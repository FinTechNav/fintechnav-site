<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fiska Checkout Demo | FinTechNav</title>
    <link rel="icon" href="/favicon.ico" sizes="any" />
    <link rel="icon" href="/favicon-192.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="/favicon-192.png" />
    <link
      href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;500;600;700&family=Poiret+One&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --color-primary: #c9a15f;
        --color-primary-hover: #b89050;
        --color-background: #1a1a1a;
        --color-text: #e0e0e0;
        --color-text-light: #a0a0a0;
        --color-border: #3a3a3a;
        --color-error: #ff6b6b;
        --color-success: #6bff9e;
        --font-family-heading: 'Poiret One', cursive;
        --font-family-body: 'Cormorant Garamond', serif;
        --border-radius: 6px;
        --box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      }

      body {
        font-family: var(--font-family-body);
        line-height: 1.7;
        color: var(--color-text);
        background-color: var(--color-background);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        font-size: 1.1rem;
      }
      .container {
        width: 100%;
        max-width: 1800px; /* Increased from 1200px to 1800px (50% wider) */
        margin: 40px auto;
        padding: 30px;
        box-shadow: var(--box-shadow);
        border-radius: var(--border-radius);
        background-color: #252525;
        border: 1px solid var(--color-border);
        transition: filter 0.3s ease;
      }

      .container.blurred {
        filter: blur(5px);
        pointer-events: none; /* Prevent interaction with blurred content */
      }

      h1,
      h2,
      h3 {
        font-family: var(--font-family-heading);
        color: var(--color-text);
        margin-top: 0;
        font-weight: 400;
        letter-spacing: 0.03em;
      }

      h2 {
        font-size: 2.5rem;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 10px;
        color: var(--color-primary);
      }

      .section {
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 15px;
      }

      .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: var(--color-text);
      }

      .environment-selection {
        margin-bottom: 20px;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
      }

      .environment-selection label {
        font-weight: 600;
        color: var(--color-primary);
        margin-bottom: 10px;
        display: block;
      }

      .radio-group {
        display: flex;
        gap: 20px;
        align-items: center;
      }

      .radio-option {
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .radio-option input[type='radio'] {
        margin-right: 8px;
      }

      .radio-option label {
        margin: 0;
        font-weight: normal;
        color: var(--color-text);
        cursor: pointer;
      }

      .modal-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.7); /* Darkened background for better focus */
        z-index: 100;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(3px); /* Additional blur effect for background */
        scrollbar-width: none !important; /* Firefox */
        -ms-overflow-style: none !important; /* IE and Edge */
      }

      .modal-overlay::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(26, 26, 26, 0.8); /* Site background with opacity */
        z-index: -1;
      }

      .modal-overlay::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
      }

      .modal {
        background-color: transparent !important; /* Remove background */
        border: none !important; /* Remove border */
        padding: 0 !important; /* Remove padding */
        box-shadow: none !important; /* Remove shadow */
        width: 100%;
        max-width: 620px; /* Increased width to ensure no horizontal scrollbar */
        height: 800px; /* Further increased height */
        position: relative;
        overflow: visible; /* Ensure any overflow is visible */
      }

      /* Extra background coverage to hide any borders */
      .modal::before {
        content: '';
        position: absolute;
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        background-color: #1a1a1a; /* Match page background */
        z-index: -1;
      }

      /* Add specific side covers to mask blue borders */
      .modal::after {
        content: '';
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px; /* Width of the cover */
        right: -20px; /* Position it outside the modal */
        background-color: #1a1a1a; /* Match page background */
        z-index: 150;
      }

      /* Add left side cover */
      .side-cover-left {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px;
        left: -20px;
        background-color: #1a1a1a;
        z-index: 150;
      }

      /* Add right side cover */
      .side-cover-right {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 20px;
        right: -20px;
        background-color: #1a1a1a;
        z-index: 150;
      }

      #paymentFormContainer {
        display: flex;
        flex-direction: column;
        flex-grow: 1;
        height: 100%;
        position: relative;
        overflow: hidden !important;
        border: none !important;
        outline: none !important;
      }

      .iframe-container {
        width: 100%;
        height: 100%;
        border: none !important;
        outline: none !important;
        scrollbar-width: none !important; /* Firefox */
        -ms-overflow-style: none !important; /* IE and Edge */
        box-shadow: none !important;
        background-color: transparent !important;
      }

      /* Hide scrollbar for Chrome, Safari and Opera */
      .iframe-container::-webkit-scrollbar {
        display: none !important;
        width: 0 !important;
      }

      /* Close button */
      .modal-close-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 36px; /* Increased size */
        height: 36px; /* Increased size */
        background-color: #c9a15f; /* Solid color instead of transparent */
        color: #1a1a1a; /* Dark text on light background for contrast */
        border: 2px solid white; /* Add white border for extra visibility */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 9999; /* Very high z-index to guarantee it's on top */
        font-size: 24px;
        font-weight: bold;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5); /* Stronger shadow */
        opacity: 1 !important; /* Force opacity to 100% */
        pointer-events: auto !important; /* Ensure it can be clicked */
      }

      .modal-close-btn:hover {
        background-color: white;
        color: #c9a15f;
        transform: scale(1.1);
      }

      .btn {
        display: inline-block;
        background-color: var(--color-primary);
        color: white;
        padding: 12px 25px;
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        text-align: center;
        transition: background-color 0.3s ease;
        margin-right: 10px;
        margin-bottom: 10px;
      }

      .btn:hover {
        background-color: var(--color-primary-hover);
      }

      .api-key-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: #3a3a3a;
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
      }

      .api-key-input {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        margin-bottom: 10px;
        background-color: #2a2a2a;
        color: var(--color-text);
        font-family: var(--font-family-body);
      }

      .alert {
        padding: 10px 15px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        display: none;
      }

      .alert-error {
        background-color: rgba(255, 107, 107, 0.2);
        border: 1px solid rgba(255, 107, 107, 0.4);
        color: var(--color-error);
      }

      .alert-success {
        background-color: rgba(107, 255, 158, 0.2);
        border: 1px solid rgba(107, 255, 158, 0.4);
        color: var(--color-success);
      }

      .spinner {
        display: none;
        width: 40px;
        height: 40px;
        margin: 20px auto;
        border: 4px solid rgba(201, 161, 95, 0.1);
        border-radius: 50%;
        border-top-color: var(--color-primary);
        animation: spin 1s ease-in-out infinite;
      }

      /* Escape key instruction */
      .escape-instruction {
        position: absolute;
        bottom: 15px;
        left: 0;
        right: 0;
        text-align: center;
        color: var(--color-text-light);
        font-size: 0.9rem;
        z-index: 101;
      }

      .button-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .divider {
        height: 1px;
        background-color: var(--color-border);
        margin: 20px 0;
      }

      .form-row {
        display: flex;
        gap: 15px;
        margin-bottom: 15px;
      }

      .form-row .form-group {
        flex: 1;
        margin-bottom: 0;
      }

      .half-width .api-key-input {
        width: calc(50% - 7.5px);
      }

      .additional-fields-grid {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
      }

      .additional-fields-grid .form-group {
        margin-bottom: 15px;
      }

      @media screen and (max-width: 768px) {
        .form-row {
          flex-direction: column;
          gap: 0;
        }

        .form-row .form-group {
          margin-bottom: 15px;
        }

        .half-width .api-key-input {
          width: 100%;
        }

        .additional-fields-grid {
          grid-template-columns: 1fr;
        }
      }

      @media screen and (max-width: 1200px) and (min-width: 769px) {
        .additional-fields-grid {
          grid-template-columns: 1fr 1fr;
        }
      }
      /* Compact layout styles */
      .container {
        padding: 20px; /* Reduced from 30px */
      }

      h2 {
        font-size: 2rem; /* Reduced from 2.5rem */
        margin-bottom: 15px; /* Reduced from 20px */
        padding-bottom: 8px; /* Reduced from 10px */
      }

      h3 {
        font-size: 1.5rem;
        margin-bottom: 15px;
      }

      .section {
        margin-bottom: 20px; /* Reduced from 30px */
      }

      .order-summary {
        padding: 15px; /* Reduced from 20px */
        margin-bottom: 20px; /* Reduced from 30px */
      }

      .order-item {
        margin-bottom: 5px; /* Reduced from 10px */
      }

      .order-total {
        margin-top: 15px; /* Reduced from 20px */
        padding-top: 15px; /* Reduced from 20px */
      }

      .api-key-section {
        margin-bottom: 20px; /* Reduced from 30px */
        padding: 15px; /* Reduced from 20px */
      }

      .form-row {
        margin-bottom: 10px; /* Reduced from 15px */
      }

      .form-group {
        margin-bottom: 10px; /* Reduced from 15px */
      }

      .environment-selection {
        margin-bottom: 15px; /* Reduced from 20px */
        padding: 10px; /* Reduced from 15px */
      }

      .payment-method {
        margin-bottom: 10px; /* Reduced from 15px */
        padding: 8px; /* Reduced from 10px */
      }

      .button-container {
        margin-top: 15px;
      }

      /* Make viewport more efficient */
      body {
        padding: 20px 0; /* Add some padding but keep it minimal */
        align-items: flex-start; /* Align to top instead of center */
      }

      .container {
        margin: 20px auto; /* Reduced from 40px auto */
      }
      /* Smaller headers */
      h2 {
        font-size: 1.8rem; /* Reduced from 2rem */
        margin-bottom: 12px; /* Reduced from 15px */
        padding-bottom: 6px; /* Reduced from 8px */
      }

      h3 {
        font-size: 1.3rem; /* Reduced from 1.5rem */
        margin-bottom: 12px; /* Reduced from 15px */
      }

      /* Environment in top right */
      .config-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
      }

      .environment-inline {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 0;
        padding: 0;
        background: none;
        border: none;
      }

      .environment-inline label {
        font-weight: 500;
        color: var(--color-primary);
        margin: 0;
        font-size: 1rem;
      }

      .environment-inline .radio-group {
        gap: 15px;
      }

      @media screen and (max-width: 768px) {
        .config-header-row {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }
      }
      /* Improved error display */
      .alert {
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 15px;
        display: none;
        max-height: none; /* Remove height restrictions */
        overflow: visible; /* Allow content to be fully visible */
      }

      .alert-error {
        background-color: rgba(255, 107, 107, 0.2);
        border: 1px solid rgba(255, 107, 107, 0.4);
        color: var(--color-error);
        white-space: pre-wrap; /* Preserve formatting and allow wrapping */
        word-break: break-word; /* Allow long words to break */
        font-family: monospace; /* Use monospace for better JSON readability */
        font-size: 0.9rem;
        line-height: 1.4;
        user-select: text; /* Allow text selection for copying */
        cursor: text; /* Show text cursor */
        min-height: 100px; /* Ensure minimum height */
        max-width: 100%;
        box-sizing: border-box;
      }

      .alert-success {
        background-color: rgba(107, 255, 158, 0.2);
        border: 1px solid rgba(107, 255, 158, 0.4);
        color: var(--color-success);
      }

      /* Modal error display */
      #apiError {
        max-height: 300px; /* Increased from default */
        overflow-y: auto; /* Allow scrolling if needed */
        background-color: rgba(255, 107, 107, 0.15);
        border: 2px solid rgba(255, 107, 107, 0.5);
        padding: 20px;
        margin: 20px 0;
        border-radius: var(--border-radius);
        font-family: monospace;
        font-size: 0.85rem;
        line-height: 1.5;
        white-space: pre-wrap;
        word-break: break-word;
        user-select: text;
        cursor: text;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      /* Tab styles */
      .tab-container {
        margin-bottom: 20px;
      }

      .tab-nav {
        display: flex;
        border-bottom: 2px solid var(--color-border);
        margin-bottom: 20px;
      }

      .tab-button {
        background: none;
        border: none;
        padding: 12px 24px;
        font-family: var(--font-family-body);
        font-size: 1.1rem;
        color: var(--color-text-light);
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.3s ease;
      }

      .tab-button.active {
        color: var(--color-primary);
        border-bottom-color: var(--color-primary);
      }

      .tab-button:hover {
        color: var(--color-primary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }
      /* Sticky header for API configuration */
      .sticky-config {
        position: sticky;
        top: 0;
        z-index: 50;
        background-color: var(--color-background);
        padding: 15px 0;
        border-bottom: 1px solid var(--color-border);
        margin-bottom: 20px;
      }

      .config-row {
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      .config-item {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .config-item label {
        font-weight: 500;
        color: var(--color-primary);
        margin: 0;
        white-space: nowrap;
      }

      .config-input {
        padding: 8px 12px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        background-color: #2a2a2a;
        color: var(--color-text);
        font-family: var(--font-family-body);
        min-width: 200px;
      }

      /* Enhanced filter grid */
      .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 20px;
      }

      .filter-group {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }

      .filter-group label {
        font-weight: 500;
        color: var(--color-text);
        font-size: 0.9rem;
      }

      .range-inputs {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      .range-inputs input {
        flex: 1;
      }

      .range-separator {
        color: var(--color-text-light);
        font-weight: bold;
      }

      .datetime-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .datetime-type {
        display: flex;
        gap: 15px;
        margin-bottom: 8px;
      }

      .datetime-type label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 0.85rem;
      }

      .datetime-inputs {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .datetime-range {
        display: flex;
        gap: 8px;
        align-items: center;
      }

      @media screen and (max-width: 768px) {
        .config-row {
          flex-direction: column;
          align-items: stretch;
        }

        .config-item {
          flex-direction: column;
          align-items: stretch;
          gap: 5px;
        }

        .config-input {
          min-width: auto;
        }

        .filter-grid {
          grid-template-columns: 1fr;
        }
      }
      /* Reports section styles */
      .reports-section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: var(--color-background-secondary);
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
      }

      .reports-section h3 {
        margin-top: 0;
        color: var(--color-primary);
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 10px;
      }

      .filter-grid {
        display: grid;
        grid-template-columns: 1fr 2fr 1fr;
        gap: 15px;
        margin-bottom: 15px;
        align-items: end;
      }

      .filter-input {
        width: 100%;
        padding: 8px;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        background-color: #2a2a2a;
        color: var(--color-text);
        font-family: var(--font-family-body);
      }

      .results-container {
        margin-top: 20px;
        padding: 15px;
        background-color: #2a2a2a;
        border-radius: var(--border-radius);
        max-height: 400px;
        overflow-y: auto;
        display: none;
      }

      .results-container.show {
        display: block;
      }

      .results-text {
        font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
        font-size: 0.85rem;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
        user-select: text;
        cursor: text;
        color: var(--color-text);
        background-color: #1e1e1e;
        padding: 15px;
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
        overflow-x: auto;
      }
      .search-type-selector {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .search-type-radios {
        display: flex;
        gap: 15px;
        margin-bottom: 5px;
      }

      .search-type-radios label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--color-text-light);
      }

      .datetime-exact-options {
        display: flex;
        gap: 15px;
        margin-bottom: 8px;
      }

      .datetime-exact-options label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        font-size: 0.85rem;
        color: var(--color-text-light);
      }
      @media screen and (max-width: 768px) {
        .filter-grid {
          grid-template-columns: 1fr;
          gap: 10px;
        }

        .tab-button {
          padding: 10px 16px;
          font-size: 1rem;
        }
      }
      /* Transaction table styles */
      .transaction-table-container {
        margin-top: 20px;
        background-color: var(--color-background-secondary);
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
        padding: 15px;
        display: none;
        width: 100%; /* Ensure it uses full container width */
      }

      .transaction-table-container.show {
        display: block;
      }

      .transaction-table-container h3 {
        margin-top: 0;
        color: var(--color-primary);
        border-bottom: 1px solid var(--color-border);
        padding-bottom: 10px;
      }

      .transaction-table {
        width: auto; /* Allow table to expand naturally */
        min-width: 100%; /* Ensure it's at least full width */
        border-collapse: collapse;
        margin-top: 15px;
        font-size: 0.9rem;
        table-layout: auto;
      }

      .transaction-table th,
      .transaction-table td {
        padding: 12px 16px; /* Increased padding */
        text-align: left;
        border-bottom: 1px solid var(--color-border);
        border-right: 1px solid var(--color-border);
        vertical-align: top;
        white-space: nowrap; /* Prevent all text wrapping */
        min-width: 150px; /* Increased minimum width */
        max-width: none; /* Remove max-width restriction */
      }

      .transaction-table th:last-child,
      .transaction-table td:last-child {
        border-right: none;
      }

      .transaction-table th {
        background-color: rgba(201, 161, 95, 0.1);
        color: var(--color-primary);
        font-weight: 600;
        position: sticky;
        top: 0;
        z-index: 10;
        font-size: 0.9rem;
        text-transform: capitalize; /* Make headers more readable */
      }

      .transaction-table tbody tr:hover {
        background-color: rgba(201, 161, 95, 0.05);
      }

      .transaction-table-scroll {
        max-height: 400px;
        overflow: auto;
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        scrollbar-width: thin;
        scrollbar-color: var(--color-primary) var(--color-background-secondary);
        width: 100%; /* Ensure it uses full width */
      }
      /* Custom scrollbar for webkit browsers */
      .transaction-table-scroll::-webkit-scrollbar {
        width: 10px;
        height: 10px;
      }

      .transaction-table-scroll::-webkit-scrollbar-track {
        background: var(--color-background-secondary);
        border-radius: 5px;
      }

      .transaction-table-scroll::-webkit-scrollbar-thumb {
        background: var(--color-primary);
        border-radius: 5px;
      }

      .transaction-table-scroll::-webkit-scrollbar-thumb:hover {
        background: var(--color-primary-hover);
      }

      .transaction-table-scroll::-webkit-scrollbar-corner {
        background: var(--color-background-secondary);
      }

      /* Responsive table */
      @media screen and (max-width: 768px) {
        .transaction-table-scroll {
          max-height: 300px;
        }

        .transaction-table th,
        .transaction-table td {
          padding: 8px 12px;
          font-size: 0.8rem;
          min-width: 120px; /* Smaller minimum on mobile but still no wrapping */
        }
      }
      /* Row selection styling */
      .transaction-table tbody tr {
        cursor: pointer;
        transition: background-color 0.2s ease;
      }

      .transaction-table tbody tr:hover {
        background-color: rgba(201, 161, 95, 0.1) !important;
      }

      .transaction-table tbody tr.selected {
        background-color: rgba(201, 161, 95, 0.2) !important;
        border-left: 3px solid var(--color-primary);
      }

      /* Capture button styling */
      #captureBtn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background-color: #6e5a36;
      }

      #captureBtn:not(:disabled) {
        opacity: 1;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="container" id="mainContainer">
      <!-- Sticky API Configuration -->
      <div class="sticky-config">
        <div class="config-row">
          <div class="config-item">
            <label for="globalApiKey">API Key:</label>
            <input
              type="text"
              id="globalApiKey"
              class="config-input"
              placeholder="Paste your API key here"
            />
          </div>
          <div class="config-item">
            <label>Environment:</label>
            <div class="radio-group">
              <div class="radio-option">
                <input
                  type="radio"
                  id="globalEnvDev"
                  name="globalEnvironment"
                  value="dev"
                  checked
                />
                <label for="globalEnvDev">Development</label>
              </div>
              <div class="radio-option">
                <input type="radio" id="globalEnvProd" name="globalEnvironment" value="prod" />
                <label for="globalEnvProd">Production</label>
              </div>
            </div>
          </div>
          <div class="config-item">
            <button id="saveGlobalConfig" class="btn">Save</button>
          </div>
        </div>
        <div id="globalConfigStatus" class="alert"></div>
      </div>

      <!-- Tab Navigation -->
      <div class="tab-container">
        <div class="tab-nav">
          <button class="tab-button active" data-tab="payments">Payments</button>
          <button class="tab-button" data-tab="reports">Reports</button>
        </div>

        <!-- Payments Tab -->
        <div class="tab-content active" id="payments-tab">
          <div class="api-key-section">
            <div class="additional-fields-grid">
              <div class="form-group">
                <label for="amount">Amount (in cents):</label>
                <input
                  type="text"
                  id="amount"
                  class="api-key-input"
                  placeholder="e.g., 7273 for $72.73"
                />
              </div>

              <div class="form-group">
                <label for="paymentMethodId">Payment Method ID (optional):</label>
                <input
                  type="text"
                  id="paymentMethodId"
                  class="api-key-input"
                  placeholder="Enter payment method ID or leave blank if you only have one payment method ID"
                />
              </div>

              <div class="form-group">
                <label for="referenceId">Reference ID:</label>
                <input
                  type="text"
                  id="referenceId"
                  class="api-key-input"
                  placeholder="e.g., REF-12345"
                />
              </div>

              <div class="form-group">
                <label for="amountGoodsAndServices">Amount Goods and Services (in cents):</label>
                <input
                  type="text"
                  id="amountGoodsAndServices"
                  class="api-key-input"
                  placeholder="e.g., 6773 for $67.73"
                />
              </div>

              <div class="form-group">
                <label for="tax">Tax Amount (in cents):</label>
                <input
                  type="text"
                  id="tax"
                  class="api-key-input"
                  placeholder="e.g., 500 for $5.00"
                />
              </div>

              <div class="form-group">
                <label for="cashBack">Cash Back Amount (in cents):</label>
                <input
                  type="text"
                  id="cashBack"
                  class="api-key-input"
                  placeholder="e.g., 0 for $0.00"
                />
              </div>

              <div class="form-group">
                <label for="tip">Tip Amount (in cents):</label>
                <input
                  type="text"
                  id="tip"
                  class="api-key-input"
                  placeholder="e.g., 1000 for $10.00"
                />
              </div>

              <div class="form-group">
                <label for="invoiceNumber">Invoice Number:</label>
                <input
                  type="text"
                  id="invoiceNumber"
                  class="api-key-input"
                  placeholder="e.g., INV-12345"
                />
              </div>

              <div class="form-group">
                <label for="orderNumber">Order Number:</label>
                <input
                  type="text"
                  id="orderNumber"
                  class="api-key-input"
                  placeholder="e.g., ORD-12345"
                />
              </div>
            </div>
          </div>

          <div class="button-container">
            <button class="btn" id="createTokenBtn">Create Token</button>
            <button class="btn" id="checkoutExistingBtn">Token Sale</button>
            <button class="btn" id="checkoutNewBtn">Sale</button>
            <button class="btn" id="tokenAuthBtn">Token Auth</button>
            <button class="btn" id="authBtn">Auth</button>
            <button class="btn" id="getAuthTransactionsBtn">Get Auth Trx</button>
            <button class="btn" id="getSaleCaptureTransactionsBtn">Get Sale/Capture Trx</button>
          </div>

          <div id="authTransactionsContainer" class="transaction-table-container">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <h3>Auth Transactions</h3>
              <button
                id="captureBtn"
                class="btn"
                disabled
                style="opacity: 0.5; cursor: not-allowed"
              >
                Capture
              </button>
            </div>
            <div id="authTransactionsLoading" class="spinner" style="display: none"></div>
            <div id="authTransactionsError" class="alert alert-error" style="display: none"></div>
            <div class="transaction-table-scroll">
              <table class="transaction-table" id="authTransactionsTable">
                <thead id="authTransactionsHeader">
                  <!-- Headers will be populated dynamically -->
                </thead>
                <tbody id="authTransactionsBody">
                  <!-- Rows will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
          <div id="saleCaptureTransactionsContainer" class="transaction-table-container">
            <div style="display: flex; justify-content: space-between; align-items: center">
              <h3>Sale/Capture Transactions</h3>
              <button id="refundBtn" class="btn" disabled style="opacity: 0.5; cursor: not-allowed">
                Refund
              </button>
            </div>
            <div id="saleCaptureTransactionsLoading" class="spinner" style="display: none"></div>
            <div
              id="saleCaptureTransactionsError"
              class="alert alert-error"
              style="display: none"
            ></div>
            <div class="transaction-table-scroll">
              <table class="transaction-table" id="saleCaptureTransactionsTable">
                <thead id="saleCaptureTransactionsHeader">
                  <!-- Headers will be populated dynamically -->
                </thead>
                <tbody id="saleCaptureTransactionsBody">
                  <!-- Rows will be populated dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Reports Tab -->
        <div class="tab-content" id="reports-tab">
          <!-- Payment Methods Report -->
          <div class="reports-section">
            <h3>Get Payment Methods</h3>
            <div class="filter-grid">
              <div class="filter-group">
                <label for="pmType">Payment Method Type:</label>
                <select id="pmType" class="filter-input">
                  <option value="">N/A</option>
                  <option value="Virtual">Virtual</option>
                  <option value="Physical">Physical</option>
                  <option value="Token">Token</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="pmId">ID:</label>
                <input type="text" id="pmId" class="filter-input" placeholder="e.g., pmt_123" />
              </div>

              <div class="filter-group">
                <label for="pmType">Payment Method Type:</label>
                <select id="pmType" class="filter-input">
                  <option value="">N/A</option>
                  <option value="Virtual">Virtual</option>
                  <option value="Physical">Physical</option>
                  <option value="Token">Token</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="pmCurrency">Currency:</label>
                <select id="pmCurrency" class="filter-input">
                  <option value="">N/A</option>
                  <option value="USD">USD</option>
                  <option value="CAD">CAD</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="pmDescription">Description:</label>
                <input
                  type="text"
                  id="pmDescription"
                  class="filter-input"
                  placeholder="e.g., Brad's default"
                />
              </div>

              <div class="filter-group">
                <label for="pmOwnerId">Owner ID:</label>
                <input
                  type="text"
                  id="pmOwnerId"
                  class="filter-input"
                  placeholder="e.g., owner_123"
                />
              </div>
            </div>

            <button id="getPaymentMethods" class="btn">Get Payment Methods</button>

            <div id="pmResults" class="results-container">
              <div class="results-text" id="pmResultsText"></div>
            </div>
          </div>

          <!-- Transactions Report -->
          <div class="reports-section">
            <h3>Get Transactions</h3>
            <div class="filter-grid">
              <div class="filter-group">
                <label for="txnSortColumn">Sort Column:</label>
                <select id="txnSortColumn" class="filter-input">
                  <option value="">None</option>
                  <option value="id">ID</option>
                  <option value="timestamp">Timestamp</option>
                  <option value="referenceId">Reference ID</option>
                  <option value="orderNumber">Order Number</option>
                  <option value="invoiceNumber">Invoice Number</option>
                  <option value="type">Type</option>
                  <option value="amount">Amount</option>
                </select>
              </div>

              <div class="filter-group">
                <label for="txnId">ID:</label>
                <div class="search-type-selector">
                  <div class="search-type-radios">
                    <label
                      ><input type="radio" name="txnIdType" value="equals" checked /> Equals</label
                    >
                    <label><input type="radio" name="txnIdType" value="contains" /> Contains</label>
                  </div>
                  <input type="text" id="txnId" class="filter-input" placeholder="e.g., trx_123" />
                </div>
              </div>

              <div class="filter-group">
                <label>Timestamp:</label>
                <div class="datetime-selector">
                  <div class="datetime-type">
                    <label
                      ><input type="radio" name="timestampType" value="exact" checked />
                      Exact</label
                    >
                    <label><input type="radio" name="timestampType" value="range" /> Range</label>
                  </div>
                  <div class="datetime-inputs">
                    <div class="datetime-exact-options">
                      <label
                        ><input type="radio" name="timestampExactType" value="datetime" checked />
                        Date & Time</label
                      >
                      <label
                        ><input type="radio" name="timestampExactType" value="date" /> Date
                        Only</label
                      >
                    </div>
                    <input type="datetime-local" id="txnTimestampExact" class="filter-input" />
                    <input
                      type="date"
                      id="txnTimestampDateOnly"
                      class="filter-input"
                      style="display: none"
                    />
                    <div class="datetime-range" style="display: none">
                      <input type="datetime-local" id="txnTimestampFrom" class="filter-input" />
                      <span class="range-separator">to</span>
                      <input type="datetime-local" id="txnTimestampTo" class="filter-input" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="filter-group">
                <label for="txnReferenceId">Reference ID:</label>
                <div class="search-type-selector">
                  <div class="search-type-radios">
                    <label
                      ><input type="radio" name="txnReferenceIdType" value="equals" checked />
                      Equals</label
                    >
                    <label
                      ><input type="radio" name="txnReferenceIdType" value="contains" />
                      Contains</label
                    >
                  </div>
                  <input
                    type="text"
                    id="txnReferenceId"
                    class="filter-input"
                    placeholder="e.g., ref_123"
                  />
                </div>
              </div>

              <div class="filter-group">
                <label for="txnOrderNumber">Order Number:</label>
                <div class="search-type-selector">
                  <div class="search-type-radios">
                    <label
                      ><input type="radio" name="txnOrderNumberType" value="equals" checked />
                      Equals</label
                    >
                    <label
                      ><input type="radio" name="txnOrderNumberType" value="contains" />
                      Contains</label
                    >
                  </div>
                  <input
                    type="text"
                    id="txnOrderNumber"
                    class="filter-input"
                    placeholder="e.g., order_123"
                  />
                </div>
              </div>

              <div class="filter-group">
                <label for="txnInvoiceNumber">Invoice Number:</label>
                <div class="search-type-selector">
                  <div class="search-type-radios">
                    <label
                      ><input type="radio" name="txnInvoiceNumberType" value="equals" checked />
                      Equals</label
                    >
                    <label
                      ><input type="radio" name="txnInvoiceNumberType" value="contains" />
                      Contains</label
                    >
                  </div>
                  <input
                    type="text"
                    id="txnInvoiceNumber"
                    class="filter-input"
                    placeholder="e.g., inv_123"
                  />
                </div>
              </div>

              <div class="filter-group">
                <label for="txnType">Type:</label>
                <select id="txnType" class="filter-input">
                  <option value="">N/A</option>
                  <option value="Auth">Auth</option>
                  <option value="Sale">Sale</option>
                  <option value="Capture">Capture</option>
                  <option value="Refund">Refund</option>
                </select>
              </div>

              <div class="filter-group">
                <label>Amount (in cents):</label>
                <div class="datetime-selector">
                  <div class="datetime-type">
                    <label
                      ><input type="radio" name="amountType" value="exact" checked /> Exact</label
                    >
                    <label><input type="radio" name="amountType" value="range" /> Range</label>
                  </div>
                  <div class="datetime-inputs">
                    <input
                      type="number"
                      id="txnAmountExact"
                      class="filter-input"
                      placeholder="e.g., 1000"
                    />
                    <div class="datetime-range" style="display: none">
                      <input
                        type="number"
                        id="txnAmountFrom"
                        class="filter-input"
                        placeholder="Min"
                      />
                      <span class="range-separator">to</span>
                      <input
                        type="number"
                        id="txnAmountTo"
                        class="filter-input"
                        placeholder="Max"
                      />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <button id="getTransactions" class="btn">Get Transactions</button>

            <div id="txnResults" class="results-container">
              <div class="results-text" id="txnResultsText"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal-overlay" id="cardModal">
      <div class="modal">
        <!-- Add a close button -->
        <button class="modal-close-btn" id="closeModal">Ã—</button>

        <!-- Side covers to hide any vertical borders -->
        <div class="side-cover-left"></div>
        <div class="side-cover-right"></div>

        <div id="paymentFormContainer">
          <div id="apiError" class="alert alert-error"></div>
          <div id="spinner" class="spinner"></div>
          <iframe
            id="paymentIframe"
            class="iframe-container"
            style="display: none"
            frameborder="0"
            allowtransparency="true"
            scrolling="no"
          ></iframe>
        </div>

        <!-- Escape key instruction -->
        <div class="escape-instruction">Press ESC to close</div>
      </div>
    </div>

    <script>
      // Helper function to extract detailed error message from API response
      function extractErrorMessage(data) {
        let errorMessage = 'API request failed';

        // Check for errorDetails array with message
        if (
          data &&
          data.errorDetails &&
          Array.isArray(data.errorDetails) &&
          data.errorDetails.length > 0
        ) {
          // Use the first errorDetails message if available
          if (data.errorDetails[0].message) {
            errorMessage = data.errorDetails[0].message;
          }
        }
        // Fall back to top-level error message
        else if (data && data.error && data.error.message) {
          errorMessage = data.error.message;
        }
        // Fall back to top-level message
        else if (data && data.message) {
          errorMessage = data.message;
        }

        return errorMessage;
      }
      // Local storage keys
      const API_KEY_STORAGE = 'fiska_api_key';
      const PAYMENT_METHOD_ID_STORAGE = 'fiska_payment_method_id';
      const ENVIRONMENT_STORAGE = 'fiska_environment'; // ADD THIS LINE
      const AMOUNT_STORAGE = 'fiska_amount';
      const AMOUNT_GOODS_SERVICES_STORAGE = 'fiska_amount_goods_services';
      const TAX_STORAGE = 'fiska_tax';
      const CASHBACK_STORAGE = 'fiska_cashback';
      const TIP_STORAGE = 'fiska_tip';
      const INVOICE_NUMBER_STORAGE = 'fiska_invoice_number';
      const ORDER_NUMBER_STORAGE = 'fiska_order_number';
      const REFERENCE_ID_STORAGE = 'fiska_reference_id';

      // DOM elements - Updated to match actual HTML structure
      const globalApiKeyInput = document.getElementById('globalApiKey');
      const paymentMethodIdInput = document.getElementById('paymentMethodId');
      const globalEnvDevRadio = document.getElementById('globalEnvDev');
      const globalEnvProdRadio = document.getElementById('globalEnvProd');
      const amountInput = document.getElementById('amount');
      const amountGoodsAndServicesInput = document.getElementById('amountGoodsAndServices');
      const taxInput = document.getElementById('tax');
      const cashBackInput = document.getElementById('cashBack');
      const tipInput = document.getElementById('tip');
      const invoiceNumberInput = document.getElementById('invoiceNumber');
      const orderNumberInput = document.getElementById('orderNumber');
      const referenceIdInput = document.getElementById('referenceId');
      const globalConfigStatus = document.getElementById('globalConfigStatus');
      const saveGlobalConfigBtn = document.getElementById('saveGlobalConfig');
      const cardModal = document.getElementById('cardModal');
      const closeModalBtn = document.getElementById('closeModal');
      const paymentIframe = document.getElementById('paymentIframe');
      const apiError = document.getElementById('apiError');
      const spinner = document.getElementById('spinner');
      const paymentFormContainer = document.getElementById('paymentFormContainer');
      const mainContainer = document.getElementById('mainContainer');
      const checkoutExistingBtn = document.getElementById('checkoutExistingBtn');
      const checkoutNewBtn = document.getElementById('checkoutNewBtn');
      const authBtn = document.getElementById('authBtn');
      const getAuthTransactionsBtn = document.getElementById('getAuthTransactionsBtn');
      const createTokenBtn = document.getElementById('createTokenBtn');
      const captureBtn = document.getElementById('captureBtn');
      let selectedTransaction = null;
      const tokenAuthBtn = document.getElementById('tokenAuthBtn');
      const getSaleCaptureTransactionsBtn = document.getElementById(
        'getSaleCaptureTransactionsBtn'
      );
      const refundBtn = document.getElementById('refundBtn');
      let selectedSaleCaptureTransaction = null;

      // API endpoints - REPLACE THE EXISTING API_BASE_URL CONSTANT
      function getApiBaseUrl() {
        const environment = localStorage.getItem(ENVIRONMENT_STORAGE) || 'dev';
        if (environment === 'prod') {
          return 'https://payment-api-http.prod.ms.fiska.tech/v1';
        } else {
          return 'https://beta-payment-api-http.dev.ms.fiska.tech/v1';
        }
      }
      // Hard-coded return URL
      const RETURN_URL = 'https://fintechnav.com/payment-complete';

      // Load saved configuration if exists
      document.addEventListener('DOMContentLoaded', () => {
        // Load API key and payment method ID
        const savedApiKey = localStorage.getItem(API_KEY_STORAGE);
        if (savedApiKey && globalApiKeyInput) {
          globalApiKeyInput.value = savedApiKey;

          const savedPaymentMethodId = localStorage.getItem(PAYMENT_METHOD_ID_STORAGE);
          if (savedPaymentMethodId && paymentMethodIdInput) {
            paymentMethodIdInput.value = savedPaymentMethodId;
          }
        }

        // Load environment selection
        const savedEnvironment = localStorage.getItem(ENVIRONMENT_STORAGE) || 'dev';
        if (savedEnvironment === 'prod' && globalEnvProdRadio) {
          globalEnvProdRadio.checked = true;
        } else if (globalEnvDevRadio) {
          globalEnvDevRadio.checked = true;
        }

        // Set up environment change listeners
        if (globalEnvDevRadio) {
          globalEnvDevRadio.addEventListener('change', function () {
            if (this.checked) {
              localStorage.setItem(ENVIRONMENT_STORAGE, 'dev');
            }
          });
        }

        if (globalEnvProdRadio) {
          globalEnvProdRadio.addEventListener('change', function () {
            if (this.checked) {
              localStorage.setItem(ENVIRONMENT_STORAGE, 'prod');
            }
          });
        }

        // Load additional fields (keep existing code for these)
        const savedAmount = localStorage.getItem(AMOUNT_STORAGE);
        if (savedAmount && amountInput) amountInput.value = savedAmount;

        const savedAmountGoodsServices = localStorage.getItem(AMOUNT_GOODS_SERVICES_STORAGE);
        if (savedAmountGoodsServices && amountGoodsAndServicesInput)
          amountGoodsAndServicesInput.value = savedAmountGoodsServices;

        const savedTax = localStorage.getItem(TAX_STORAGE);
        if (savedTax && taxInput) taxInput.value = savedTax;

        const savedCashBack = localStorage.getItem(CASHBACK_STORAGE);
        if (savedCashBack && cashBackInput) cashBackInput.value = savedCashBack;

        const savedTip = localStorage.getItem(TIP_STORAGE);
        if (savedTip && tipInput) tipInput.value = savedTip;

        const savedInvoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE);
        if (savedInvoiceNumber && invoiceNumberInput) invoiceNumberInput.value = savedInvoiceNumber;

        const savedOrderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE);
        if (savedOrderNumber && orderNumberInput) orderNumberInput.value = savedOrderNumber;

        const savedReferenceId = localStorage.getItem(REFERENCE_ID_STORAGE);
        if (savedReferenceId && referenceIdInput) referenceIdInput.value = savedReferenceId;

        // Show success message if configuration is loaded
        if (savedApiKey && globalConfigStatus) {
          showAlert(globalConfigStatus, 'Configuration loaded from local storage.', 'success');
        }
      });

      // Function to toggle blur on main container
      function toggleBlur(shouldBlur) {
        if (shouldBlur) {
          mainContainer.classList.add('blurred');
        } else {
          mainContainer.classList.remove('blurred');
        }
      }

      // Helper function to save or remove item from localStorage
      function saveOrRemoveFromStorage(key, value) {
        if (value) {
          localStorage.setItem(key, value);
        } else {
          localStorage.removeItem(key);
        }
      }

      // Close modal when close button is clicked
      closeModalBtn.addEventListener('click', () => {
        cardModal.style.display = 'none';
        toggleBlur(false);
      });

      // Click outside modal to close (but not on the modal content)
      cardModal.addEventListener('click', (e) => {
        if (e.target === cardModal) {
          cardModal.style.display = 'none';
          toggleBlur(false);
        }
      });

      // Add escape key functionality
      document.addEventListener('keydown', function (event) {
        if (event.key === 'Escape' && cardModal.style.display === 'flex') {
          // Add visual feedback
          document.querySelector('.escape-instruction').style.color = '#c9a15f';

          // Reset after a short delay
          setTimeout(() => {
            cardModal.style.display = 'none';
            toggleBlur(false);
            // Reset color if the modal is opened again
            document.querySelector('.escape-instruction').style.color = '';
          }, 200);
        }
      });

      // Function to create a card not present token
      async function createCardNotPresentToken() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);

        // Always make sure to stop the spinner in case of errors
        try {
          if (!apiKey) {
            showAlert(apiError, 'API key is missing. Please enter and save your API key.', 'error');
            spinner.style.display = 'none';
            return;
          }

          // Generate a reference ID using current timestamp
          const referenceId = localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`;

          // Check if the user has provided a payment method ID
          let paymentMethodId = localStorage.getItem(PAYMENT_METHOD_ID_STORAGE);

          console.log('Return URL:', RETURN_URL);

          // Prepare the request data
          const requestData = {
            referenceId: referenceId,
            returnUrl: RETURN_URL,
          };

          // Only add paymentMethodId to the request if we have one
          if (paymentMethodId) {
            requestData.paymentMethodId = paymentMethodId;
            console.log('Using payment method ID:', paymentMethodId);
          } else {
            console.log('Proceeding without a payment method ID');
          }

          console.log('Request payload:', JSON.stringify(requestData, null, 2));

          // Now create the token
          const endpoint = `${getApiBaseUrl()}/payment-methods/virtual`;
          console.log('Making request to:', endpoint);

          let response;
          try {
            response = await fetch(endpoint, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
              },
              body: JSON.stringify(requestData),
            });
          } catch (fetchError) {
            console.error('Network error during fetch:', fetchError);
            showAlert(apiError, `Network error: ${fetchError.message}`, 'error');
            spinner.style.display = 'none';
            return;
          }

          console.log('Response status:', response.status);

          // Get response text regardless of status
          let responseText = '';
          try {
            responseText = await response.text();
            console.log('Raw response:', responseText);
          } catch (e) {
            console.error('Could not read response body:', e);
            showAlert(apiError, 'Error reading API response', 'error');
            spinner.style.display = 'none';
            return;
          }

          // Try to parse as JSON if possible
          let data;
          try {
            if (responseText && responseText.trim() !== '') {
              data = JSON.parse(responseText);
            } else {
              showAlert(apiError, 'Empty response from API', 'error');
              spinner.style.display = 'none';
              return;
            }
          } catch (error) {
            console.error('Error parsing JSON response:', error);
            showAlert(
              apiError,
              `Invalid JSON response: ${responseText.substring(0, 100)}...`,
              'error'
            );
            spinner.style.display = 'none';
            return;
          }

          // Handle error response
          if (!response.ok) {
            let errorMessage = extractErrorMessage(data);

            // If no specific message was found, use status-based message
            if (errorMessage === 'API request failed') {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }

            console.error('API error:', errorMessage);
            console.error('Full response data:', data);
            showAlert(apiError, errorMessage, 'error');
            spinner.style.display = 'none';
            return;
          }

          // Handle successful response with missing data
          if (!data) {
            showAlert(apiError, 'Empty response from API', 'error');
            spinner.style.display = 'none';
            return;
          }

          console.log('API response data:', data);

          // Process the iframe URL if available
          if (data.iframeUrl) {
            // Create and add stylesheet to the document to ensure iframe content has no scrollbars
            const style = document.createElement('style');
            style.textContent = `
          iframe.iframe-container {
            overflow: hidden !important;
            scrollbar-width: none !important;
            -ms-overflow-style: none !important;
          }
          iframe.iframe-container::-webkit-scrollbar {
            display: none !important;
            width: 0 !important;
            height: 0 !important;
          }
        `;
            document.head.appendChild(style);

            // Update iframe source and display it
            paymentIframe.src = data.iframeUrl;
            paymentIframe.style.display = 'block';
            spinner.style.display = 'none'; // Hide spinner when iframe is shown
          } else {
            // Handle missing iframe URL
            let errorMsg = 'Failed to create payment session. No iframe URL returned.';
            if (data.error && data.error.message) {
              errorMsg = data.error.message;
            } else if (data.message) {
              errorMsg = data.message;
            }
            showAlert(apiError, errorMsg, 'error');
            spinner.style.display = 'none';
          }
        } catch (error) {
          // Catch-all error handler to ensure spinner is always hidden
          console.error('Unhandled error in payment processing:', error);
          showAlert(apiError, `Unexpected error: ${error.message}`, 'error');
          spinner.style.display = 'none';
        }
      }

      // Process a virtual (Card Not Present) sale
      async function processVirtualSale() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);

        if (!apiKey) {
          alert('API key is missing. Please enter and save your API key.');
          return;
        }

        // Generate a reference ID using current timestamp or use saved one
        const referenceId = localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`;

        // Get payment method ID if available
        const paymentMethodId = localStorage.getItem(PAYMENT_METHOD_ID_STORAGE);

        // Get other configuration values
        const amount = parseInt(localStorage.getItem(AMOUNT_STORAGE) || '7273');
        const tax = parseInt(localStorage.getItem(TAX_STORAGE) || '0');
        const cashBack = parseInt(localStorage.getItem(CASHBACK_STORAGE) || '0');
        const tip = parseInt(localStorage.getItem(TIP_STORAGE) || '0');
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE) || `inv_${Date.now()}`;
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE) || `ord_${Date.now()}`;

        // Get breakdown values (don't auto-calculate)
        let amountGoodsAndServices = parseInt(
          localStorage.getItem(AMOUNT_GOODS_SERVICES_STORAGE) || '0'
        );

        // Reset modal state
        paymentIframe.style.display = 'none';
        apiError.style.display = 'none';
        spinner.style.display = 'block';

        // Display the modal for processing payment
        cardModal.style.display = 'flex';
        toggleBlur(true);

        try {
          // Prepare request data
          const requestData = {
            referenceId: referenceId,
            returnUrl: RETURN_URL,
            amount: amount,
            invoiceNumber: invoiceNumber,
            orderNumber: orderNumber,
          };

          // Only add amountBreakdown if at least one field has a value
          if (amountGoodsAndServices > 0 || tax > 0 || cashBack > 0 || tip > 0) {
            requestData.amountBreakdown = {
              tax: tax,
              cashBack: cashBack,
              tip: tip,
              amountGoodsAndServices: amountGoodsAndServices,
            };
          }

          // Add payment method ID if available
          if (paymentMethodId) {
            requestData.paymentMethodId = paymentMethodId;
          }

          console.log('Virtual sale request:', JSON.stringify(requestData, null, 2));

          // Make the API request
          const endpoint = `${getApiBaseUrl()}/transactions/virtual-sale`;

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
            body: JSON.stringify(requestData),
          });

          // Parse the response
          const responseText = await response.text();
          let data;

          try {
            if (responseText && responseText.trim() !== '') {
              data = JSON.parse(responseText);
            } else {
              throw new Error('Empty response');
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            showAlert(apiError, 'Invalid response format', 'error');
            spinner.style.display = 'none';
            return;
          }

          // Handle error response
          if (!response.ok) {
            let errorMessage = extractErrorMessage(data);

            // If no specific message was found, use status-based message
            if (errorMessage === 'API request failed') {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }

            console.error('API error:', errorMessage);
            console.error('Full response data:', data);
            showAlert(apiError, errorMessage, 'error');
            spinner.style.display = 'none';
            return;
          }

          // Handle iframe URL if available
          if (data.iframeUrl) {
            // Update iframe source and display it
            paymentIframe.src = data.iframeUrl;
            paymentIframe.style.display = 'block';
            spinner.style.display = 'none';
          } else {
            // Handle missing iframe URL
            showAlert(apiError, 'No payment iframe URL returned', 'error');
            spinner.style.display = 'none';
          }
        } catch (error) {
          console.error('Error processing virtual sale:', error);
          showAlert(apiError, `Payment processing error: ${error.message}`, 'error');
          spinner.style.display = 'none';
        }
      }
      // Process a virtual (Card Not Present) auth
      async function processVirtualAuth() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);

        if (!apiKey) {
          alert('API key is missing. Please enter and save your API key.');
          return;
        }

        // Generate a reference ID using current timestamp or use saved one
        const referenceId = localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`;

        // Get payment method ID if available
        const paymentMethodId = localStorage.getItem(PAYMENT_METHOD_ID_STORAGE);

        // Get other configuration values
        const amount = parseInt(localStorage.getItem(AMOUNT_STORAGE) || '7273');
        const tax = parseInt(localStorage.getItem(TAX_STORAGE) || '0');
        const cashBack = parseInt(localStorage.getItem(CASHBACK_STORAGE) || '0');
        const tip = parseInt(localStorage.getItem(TIP_STORAGE) || '0');
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE) || `inv_${Date.now()}`;
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE) || `ord_${Date.now()}`;

        // Get breakdown values (don't auto-calculate)
        let amountGoodsAndServices = parseInt(
          localStorage.getItem(AMOUNT_GOODS_SERVICES_STORAGE) || '0'
        );

        // Reset modal state
        paymentIframe.style.display = 'none';
        apiError.style.display = 'none';
        spinner.style.display = 'block';

        // Display the modal for processing payment
        cardModal.style.display = 'flex';
        toggleBlur(true);

        try {
          // Prepare request data
          const requestData = {
            referenceId: referenceId,
            returnUrl: RETURN_URL,
            amount: amount,
            invoiceNumber: invoiceNumber,
            orderNumber: orderNumber,
          };

          // Only add amountBreakdown if at least one field has a value
          if (amountGoodsAndServices > 0 || tax > 0 || cashBack > 0 || tip > 0) {
            requestData.amountBreakdown = {
              tax: tax,
              cashBack: cashBack,
              tip: tip,
              amountGoodsAndServices: amountGoodsAndServices,
            };
          }

          // Add payment method ID if available
          if (paymentMethodId) {
            requestData.paymentMethodId = paymentMethodId;
          }

          console.log('Virtual auth request:', JSON.stringify(requestData, null, 2));

          // Make the API request to the auth endpoint
          const endpoint = `${getApiBaseUrl()}/transactions/virtual-auth`;

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
            body: JSON.stringify(requestData),
          });

          // Parse the response
          const responseText = await response.text();
          let data;

          try {
            if (responseText && responseText.trim() !== '') {
              data = JSON.parse(responseText);
            } else {
              throw new Error('Empty response');
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            showAlert(apiError, 'Invalid response format', 'error');
            spinner.style.display = 'none';
            return;
          }

          // Handle error response
          if (!response.ok) {
            let errorMessage = extractErrorMessage(data);

            // If no specific message was found, use status-based message
            if (errorMessage === 'API request failed') {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }

            console.error('API error:', errorMessage);
            console.error('Full response data:', data);
            showAlert(apiError, errorMessage, 'error');
            spinner.style.display = 'none';
            return;
          }

          // Handle iframe URL if available
          if (data.iframeUrl) {
            // Update iframe source and display it
            paymentIframe.src = data.iframeUrl;
            paymentIframe.style.display = 'block';
            spinner.style.display = 'none';
          } else {
            // Handle missing iframe URL
            showAlert(apiError, 'No payment iframe URL returned', 'error');
            spinner.style.display = 'none';
          }
        } catch (error) {
          console.error('Error processing virtual auth:', error);
          showAlert(apiError, `Payment processing error: ${error.message}`, 'error');
          spinner.style.display = 'none';
        }
      }

      // Complete updated processTokenSale function with enhanced debugging and error handling
      async function processTokenSale(tokenId) {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);

        if (!apiKey) {
          alert('API key is missing. Please enter and save your API key.');
          return;
        }

        if (!tokenId) {
          alert('Please select a payment method first.');
          return;
        }

        // Get configuration values
        const referenceId = localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`;
        const amount = parseInt(localStorage.getItem(AMOUNT_STORAGE) || '7273');
        const tax = parseInt(localStorage.getItem(TAX_STORAGE) || '0');
        const cashBack = parseInt(localStorage.getItem(CASHBACK_STORAGE) || '0');
        const tip = parseInt(localStorage.getItem(TIP_STORAGE) || '0');
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE) || `inv_${Date.now()}`;
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE) || `ord_${Date.now()}`;

        // Get breakdown values (don't auto-calculate)
        let amountGoodsAndServices = parseInt(
          localStorage.getItem(AMOUNT_GOODS_SERVICES_STORAGE) || '0'
        );

        try {
          // Show loading state
          const originalButtonText = checkoutExistingBtn.textContent;
          checkoutExistingBtn.textContent = 'Processing...';
          checkoutExistingBtn.disabled = true;

          // Prepare request data
          const requestData = {
            referenceId: referenceId,
            paymentMethodId: tokenId, // Using paymentMethodId instead of tokenId
            amount: amount,
            invoiceNumber: invoiceNumber,
            orderNumber: orderNumber,
          };

          // Only add amountBreakdown if at least one field has a value
          if (amountGoodsAndServices > 0 || tax > 0 || cashBack > 0 || tip > 0) {
            requestData.amountBreakdown = {
              tax: tax,
              cashBack: cashBack,
              tip: tip,
              amountGoodsAndServices: amountGoodsAndServices,
            };
          }

          console.log('Token sale request:', JSON.stringify(requestData, null, 2));

          // Make the API request
          const endpoint = `${getApiBaseUrl()}/transactions/token-sale`;
          const headers = {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
          };
          const body = JSON.stringify(requestData);

          // Log request details for debugging
          console.group('API Request Details');
          console.log('Endpoint:', endpoint);
          console.log('Method: POST');
          console.log('Headers:', headers);
          console.log('Request Body:', body);
          try {
            console.log('Request Body (parsed):', JSON.parse(body));
          } catch (e) {
            console.log('Could not parse request body as JSON');
          }
          console.groupEnd();

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: body,
          });

          // Parse the response
          const responseText = await response.text();
          console.log('Raw API Response:', responseText);

          let data;
          try {
            if (responseText && responseText.trim() !== '') {
              data = JSON.parse(responseText);
              console.log('Parsed API Response:', data);
            } else {
              throw new Error('Empty response');
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            alert(`Error: Invalid response format\n\nRaw response: ${responseText}`);
            checkoutExistingBtn.textContent = originalButtonText;
            checkoutExistingBtn.disabled = false;
            return;
          }

          // Handle error response
          if (!response.ok) {
            console.error('API Error Response Status:', response.status);
            console.error('API Error Raw Response:', responseText);

            let errorMessage = `Error: API returned an error.\n\nStatus: ${response.status}\n\nRaw Response:\n${responseText}`;

            try {
              // Try to format the JSON response for display
              const formattedJson = JSON.stringify(data, null, 2);
              console.error('API Error Formatted JSON:', formattedJson);
              errorMessage += `\n\nFormatted JSON:\n${formattedJson}`;
            } catch (e) {
              // JSON formatting failed, raw response is already included
            }

            // Show in a modal-style alert that can be copied
            showAlert(apiKeyStatus, errorMessage, 'error');

            // Scroll to the error message
            apiKeyStatus.scrollIntoView({ behavior: 'smooth', block: 'center' });

            checkoutExistingBtn.textContent = originalButtonText;
            checkoutExistingBtn.disabled = false;
            return;
          }

          // Handle successful response
          console.log('Payment successful:', data);

          // Redirect to payment complete page with transaction details
          const params = new URLSearchParams();
          params.append('resultCode', data.resultCode || '0');
          params.append('transactionId', data.id || 'unknown');
          params.append('amount', amount.toString());

          window.location.href = `${RETURN_URL}?${params.toString()}`;
        } catch (error) {
          console.error('Error processing token sale:', error);
          alert(`Payment processing error: ${error.message}\n\nStack trace: ${error.stack}`);

          // Reset button state
          checkoutExistingBtn.textContent = 'Token Sale';
          checkoutExistingBtn.disabled = false;
        }
      }

      // Set up event listener for iframe postMessages
      function setupIframeMessageListener() {
        window.addEventListener('message', (event) => {
          // Verify origin for security
          if (
            event.origin.includes('fiska.tech') ||
            event.origin.includes('integratedcommerce.io')
          ) {
            try {
              const data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;

              // Handle resize events from the iframe
              if (data.action === 'resize') {
                // If iframe sends a resize message, adjust modal height
                if (data.height) {
                  const modal = document.querySelector('.modal');
                  modal.style.height = `${data.height}px`;
                }
              }

              if (data.status === 'completed') {
                // Payment was successful
                cardModal.style.display = 'none';
                toggleBlur(false);

                // Handle payment transaction completion
                if (data.transactionId) {
                  // Redirect to payment complete page with result
                  const params = new URLSearchParams();
                  params.append('resultCode', '0');
                  params.append('transactionId', data.transactionId);

                  if (data.amount) {
                    params.append('amount', data.amount.toString());
                  }

                  window.location.href = `${RETURN_URL}?${params.toString()}`;
                } else {
                  // Just a token creation, not a payment
                  const cardDetails = data.cardDetails || {};

                  // Show success message
                  alert('Payment method added successfully!');
                }
              } else if (data.status === 'error') {
                // Payment failed
                showAlert(apiError, data.message || 'Payment failed. Please try again.', 'error');
              } else if (data.status === 'canceled') {
                // User canceled the payment
                cardModal.style.display = 'none';
                toggleBlur(false);
              }
            } catch (error) {
              console.error('Error processing postMessage:', error);
            }
          }
        });
      }
      // Capture button event listener
      if (captureBtn) {
        captureBtn.addEventListener('click', processCapture);
      }
      // Setup iframe message listener on load
      setupIframeMessageListener();

      // Helper function to show alerts
      function showAlert(element, message, type) {
        // Format the message for better readability
        let formattedMessage = message;

        // If it looks like JSON, try to format it nicely
        if (message.includes('{') && message.includes('}')) {
          try {
            const jsonStart = message.indexOf('{');
            const beforeJson = message.substring(0, jsonStart);
            const jsonPart = message.substring(jsonStart);
            const parsed = JSON.parse(jsonPart);
            formattedMessage = beforeJson + '\n\n' + JSON.stringify(parsed, null, 2);
          } catch (e) {
            // If JSON parsing fails, just use the original message
            formattedMessage = message;
          }
        }

        element.textContent = formattedMessage;
        element.style.display = 'block';

        if (type === 'error') {
          element.className = 'alert alert-error';
        } else {
          element.className = 'alert alert-success';
        }

        // Don't auto-hide error messages so users can copy them
        if (type !== 'error') {
          setTimeout(() => {
            element.style.display = 'none';
          }, 5000);
        }
      }

      // Update the checkoutExistingBtn click handler to prompt for token ID
      checkoutExistingBtn.addEventListener('click', () => {
        // Prompt for token ID
        const tokenId = prompt('Enter Payment Method ID (Token ID):', '');

        // Validate input
        if (tokenId === null) {
          // User canceled the prompt
          return;
        }

        if (!tokenId.trim()) {
          alert('Please enter a valid Payment Method ID');
          return;
        }

        // Process the sale with the provided token
        processTokenSale(tokenId.trim());
      });

      checkoutNewBtn.addEventListener('click', () => {
        processVirtualSale();
      });

      // Auth button event listener
      authBtn.addEventListener('click', () => {
        processVirtualAuth();
      });

      // Get Auth Transactions button event listener
      getAuthTransactionsBtn.addEventListener('click', getAuthTransactions);

      // Update the button text to reflect the new functionality
      checkoutExistingBtn.textContent = 'Token Sale';

      // Auth button event listener
      authBtn.addEventListener('click', () => {
        processVirtualAuth();
      });

      // Token Auth button event listener
      if (tokenAuthBtn) {
        tokenAuthBtn.addEventListener('click', () => {
          const tokenId = prompt('Enter Payment Method ID (Token ID):', '');
          if (tokenId === null) return;
          if (!tokenId.trim()) {
            alert('Please enter a valid Payment Method ID');
            return;
          }
          processTokenAuth(tokenId.trim());
        });
      }

      // Get Sale/Capture Transactions button event listener
      if (getSaleCaptureTransactionsBtn) {
        getSaleCaptureTransactionsBtn.addEventListener('click', getSaleCaptureTransactions);
      }

      // Refund button event listener
      if (refundBtn) {
        refundBtn.addEventListener('click', processRefund);
      }

      // Tab functionality and global config brad
      document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const timestampExactRadios = document.querySelectorAll('input[name="timestampExactType"]');
        timestampExactRadios.forEach((radio) => {
          radio.addEventListener('change', toggleTimestampExactInputs);
        });

        // Set max date/time to current date/time
        setMaxDateTime();

        // Tab switching
        tabButtons.forEach((button) => {
          button.addEventListener('click', () => {
            const tabId = button.getAttribute('data-tab');

            tabButtons.forEach((btn) => btn.classList.remove('active'));
            tabContents.forEach((content) => content.classList.remove('active'));

            button.classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
          });
        });

        // Load global configuration
        loadGlobalConfig();

        // Global config save
        document.getElementById('saveGlobalConfig').addEventListener('click', saveGlobalConfig);

        // Reports functionality
        document.getElementById('getPaymentMethods').addEventListener('click', getPaymentMethods);
        document.getElementById('getTransactions').addEventListener('click', getTransactions);

        document.addEventListener('DOMContentLoaded', () => {
          const tabButtons = document.querySelectorAll('.tab-button');
          const tabContents = document.querySelectorAll('.tab-content');

          const timestampExactRadios = document.querySelectorAll(
            'input[name="timestampExactType"]'
          );
          timestampExactRadios.forEach((radio) => {
            radio.addEventListener('change', toggleTimestampExactInputs);
          });

          // Set max date/time to current date/time
          setMaxDateTime();

          // Tab switching
          tabButtons.forEach((button) => {
            button.addEventListener('click', () => {
              const tabId = button.getAttribute('data-tab');

              tabButtons.forEach((btn) => btn.classList.remove('active'));
              tabContents.forEach((content) => content.classList.remove('active'));

              button.classList.add('active');
              document.getElementById(`${tabId}-tab`).classList.add('active');
            });
          });

          // Load global configuration
          loadGlobalConfig();

          // Global config save
          document.getElementById('saveGlobalConfig').addEventListener('click', saveGlobalConfig);

          // Reports functionality
          document.getElementById('getPaymentMethods').addEventListener('click', getPaymentMethods);
          document.getElementById('getTransactions').addEventListener('click', getTransactions);

          // ADD THIS LINE HERE:
          document
            .getElementById('getAuthTransactionsBtn')
            .addEventListener('click', getAuthTransactions);

          // Timestamp type toggle
          const timestampRadios = document.querySelectorAll('input[name="timestampType"]');
          timestampRadios.forEach((radio) => {
            radio.addEventListener('change', toggleTimestampInputs);
          });

          // Amount type toggle
          const amountRadios = document.querySelectorAll('input[name="amountType"]');
          amountRadios.forEach((radio) => {
            radio.addEventListener('change', toggleAmountInputs);
          });
        });

        // Timestamp type toggle
        const timestampRadios = document.querySelectorAll('input[name="timestampType"]');
        timestampRadios.forEach((radio) => {
          radio.addEventListener('change', toggleTimestampInputs);
        });

        // Amount type toggle
        const amountRadios = document.querySelectorAll('input[name="amountType"]');
        amountRadios.forEach((radio) => {
          radio.addEventListener('change', toggleAmountInputs);
        });
      });

      // Load global configuration
      function loadGlobalConfig() {
        const savedApiKey = localStorage.getItem(API_KEY_STORAGE);
        const savedEnvironment = localStorage.getItem(ENVIRONMENT_STORAGE) || 'dev';

        if (savedApiKey) {
          document.getElementById('globalApiKey').value = savedApiKey;
        }

        if (savedEnvironment === 'prod') {
          document.getElementById('globalEnvProd').checked = true;
        } else {
          document.getElementById('globalEnvDev').checked = true;
        }
      }

      // Save global configuration
      function saveGlobalConfig() {
        const apiKey = document.getElementById('globalApiKey').value.trim();
        const environment = document.getElementById('globalEnvProd').checked ? 'prod' : 'dev';
        const statusElement = document.getElementById('globalConfigStatus');

        // Get all form values
        const amount = document.getElementById('amount').value.trim();
        const paymentMethodId = document.getElementById('paymentMethodId').value.trim();
        const referenceId = document.getElementById('referenceId').value.trim();
        const amountGoodsAndServices = document
          .getElementById('amountGoodsAndServices')
          .value.trim();
        const tax = document.getElementById('tax').value.trim();
        const cashBack = document.getElementById('cashBack').value.trim();
        const tip = document.getElementById('tip').value.trim();
        const invoiceNumber = document.getElementById('invoiceNumber').value.trim();
        const orderNumber = document.getElementById('orderNumber').value.trim();

        if (apiKey) {
          // Save API key and environment
          localStorage.setItem(API_KEY_STORAGE, apiKey);
          localStorage.setItem(ENVIRONMENT_STORAGE, environment);

          // Save all form values
          saveOrRemoveFromStorage(AMOUNT_STORAGE, amount);
          saveOrRemoveFromStorage(PAYMENT_METHOD_ID_STORAGE, paymentMethodId);
          saveOrRemoveFromStorage(REFERENCE_ID_STORAGE, referenceId);
          saveOrRemoveFromStorage(AMOUNT_GOODS_SERVICES_STORAGE, amountGoodsAndServices);
          saveOrRemoveFromStorage(TAX_STORAGE, tax);
          saveOrRemoveFromStorage(CASHBACK_STORAGE, cashBack);
          saveOrRemoveFromStorage(TIP_STORAGE, tip);
          saveOrRemoveFromStorage(INVOICE_NUMBER_STORAGE, invoiceNumber);
          saveOrRemoveFromStorage(ORDER_NUMBER_STORAGE, orderNumber);

          showAlert(statusElement, 'Configuration saved successfully!', 'success');
        } else {
          showAlert(statusElement, 'Please enter a valid API key.', 'error');
        }
      }

      // Toggle timestamp input fields
      function toggleTimestampInputs() {
        const exactInput = document.getElementById('txnTimestampExact');
        const rangeInputs = exactInput.parentElement.querySelector('.datetime-range');
        const isRange =
          document.querySelector('input[name="timestampType"]:checked').value === 'range';

        if (isRange) {
          exactInput.style.display = 'none';
          rangeInputs.style.display = 'flex';
        } else {
          exactInput.style.display = 'block';
          rangeInputs.style.display = 'none';
        }
      }

      // Toggle amount input fields
      function toggleAmountInputs() {
        const exactInput = document.getElementById('txnAmountExact');
        const rangeInputs = exactInput.parentElement.querySelector('.datetime-range');
        const isRange =
          document.querySelector('input[name="amountType"]:checked').value === 'range';

        if (isRange) {
          exactInput.style.display = 'none';
          rangeInputs.style.display = 'flex';
        } else {
          exactInput.style.display = 'block';
          rangeInputs.style.display = 'none';
        }
      }

      // Build filter string for payment methods
      function buildPaymentMethodFilters() {
        const filters = [];

        const id = document.getElementById('pmId');
        if (id && id.value.trim()) {
          const idType = document.querySelector('input[name="pmIdType"]:checked');
          if (idType) {
            const operator = idType.value === 'equals' ? '==' : '@=';
            filters.push(`id${operator}${id.value.trim()}`);
          }
        }

        const type = document.getElementById('pmType');
        if (type && type.value) filters.push(`paymentMethodType==${type.value}`);

        const currency = document.getElementById('pmCurrency');
        if (currency && currency.value) filters.push(`currency==${currency.value}`);

        const description = document.getElementById('pmDescription');
        if (description && description.value.trim())
          filters.push(`description==${description.value.trim()}`);

        const ownerId = document.getElementById('pmOwnerId');
        if (ownerId && ownerId.value.trim()) filters.push(`ownerId==${ownerId.value.trim()}`);

        return filters.join(',');
      }
      // Build filter string for transactions
      function buildTransactionFilters() {
        const filters = [];

        const id = document.getElementById('txnId').value.trim();
        if (id) {
          const idType = document.querySelector('input[name="txnIdType"]:checked').value;
          const operator = idType === 'equals' ? '==' : '@=';
          filters.push(`id${operator}${id}`);
        }

        // Timestamp handling
        const timestampType = document.querySelector('input[name="timestampType"]:checked').value;
        if (timestampType === 'exact') {
          const exactType = document.querySelector(
            'input[name="timestampExactType"]:checked'
          ).value;

          if (exactType === 'datetime') {
            const timestamp = document.getElementById('txnTimestampExact').value;
            if (timestamp) filters.push(`timestamp==${timestamp}`);
          } else {
            const dateOnly = document.getElementById('txnTimestampDateOnly').value;
            if (dateOnly) {
              // Convert local date to UTC range for proper timezone handling
              const localDate = new Date(dateOnly + 'T00:00:00');
              const nextDay = new Date(localDate);
              nextDay.setDate(nextDay.getDate() + 1);

              // Convert to UTC ISO strings
              const startOfDayUTC = localDate.toISOString();
              const endOfDayUTC = nextDay.toISOString();

              filters.push(`timestamp>=${startOfDayUTC}`);
              filters.push(`timestamp<${endOfDayUTC}`);
            }
          }
        } else {
          const timestampFrom = document.getElementById('txnTimestampFrom').value;
          const timestampTo = document.getElementById('txnTimestampTo').value;
          if (timestampFrom) filters.push(`timestamp>=${timestampFrom}`);
          if (timestampTo) filters.push(`timestamp<=${timestampTo}`);
        }

        const referenceId = document.getElementById('txnReferenceId').value.trim();
        if (referenceId) {
          const refIdType = document.querySelector(
            'input[name="txnReferenceIdType"]:checked'
          ).value;
          const operator = refIdType === 'equals' ? '==' : '@=';
          filters.push(`referenceId${operator}${referenceId}`);
        }

        const orderNumber = document.getElementById('txnOrderNumber').value.trim();
        if (orderNumber) {
          const orderType = document.querySelector(
            'input[name="txnOrderNumberType"]:checked'
          ).value;
          const operator = orderType === 'equals' ? '==' : '@=';
          filters.push(`orderNumber${operator}${orderNumber}`);
        }

        const invoiceNumber = document.getElementById('txnInvoiceNumber').value.trim();
        if (invoiceNumber) {
          const invoiceType = document.querySelector(
            'input[name="txnInvoiceNumberType"]:checked'
          ).value;
          const operator = invoiceType === 'equals' ? '==' : '@=';
          filters.push(`invoiceNumber${operator}${invoiceNumber}`);
        }

        const type = document.getElementById('txnType').value;
        if (type && type !== '') filters.push(`type==${type}`);

        // Amount handling
        const amountType = document.querySelector('input[name="amountType"]:checked').value;
        if (amountType === 'exact') {
          const amount = document.getElementById('txnAmountExact').value;
          if (amount) filters.push(`amount==${amount}`);
        } else {
          const amountFrom = document.getElementById('txnAmountFrom').value;
          const amountTo = document.getElementById('txnAmountTo').value;
          if (amountFrom) filters.push(`amount>=${amountFrom}`);
          if (amountTo) filters.push(`amount<=${amountTo}`);
        }

        return filters.join(',');
      }

      // Get Payment Methods function
      async function getPaymentMethods() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        const filters = buildPaymentMethodFilters();
        const resultsContainer = document.getElementById('pmResults');
        const resultsText = document.getElementById('pmResultsText');

        if (!apiKey) {
          alert('API key is missing. Please configure it at the top of the page first.');
          return;
        }

        // Build query parameters
        const params = new URLSearchParams();

        // Only add sorts if the element exists
        const sortColumnElement = document.getElementById('pmSortColumn');
        if (sortColumnElement && sortColumnElement.value) {
          params.append('sorts', sortColumnElement.value);
        }

        if (filters) {
          params.append('filters', filters);
        }

        const queryString = params.toString();
        const url = `${getApiBaseUrl()}/payment-methods${queryString ? '?' + queryString : ''}`;

        try {
          const button = document.getElementById('getPaymentMethods');
          const originalText = button.textContent;
          button.textContent = 'Loading...';
          button.disabled = true;

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
          });

          const responseText = await response.text();

          // Try to parse and format the JSON response
          let formattedText;
          try {
            const jsonData = JSON.parse(responseText);
            formattedText = JSON.stringify(jsonData, null, 2);
          } catch (parseError) {
            // If JSON parsing fails, show the raw response
            formattedText = responseText;
          }

          // Display the formatted response
          resultsText.textContent = formattedText;
          resultsContainer.classList.add('show');

          button.textContent = originalText;
          button.disabled = false;
        } catch (error) {
          resultsText.textContent = `Error: ${error.message}`;
          resultsContainer.classList.add('show');

          const button = document.getElementById('getPaymentMethods');
          button.textContent = 'Get Payment Methods';
          button.disabled = false;
        }
      }

      // Get Transactions function
      async function getTransactions() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        const sortColumn = document.getElementById('txnSortColumn').value;
        const filters = buildTransactionFilters();
        const resultsContainer = document.getElementById('txnResults');
        const resultsText = document.getElementById('txnResultsText');

        if (!apiKey) {
          alert('API key is missing. Please configure it at the top of the page first.');
          return;
        }

        // Build query parameters
        const params = new URLSearchParams();
        if (sortColumn) {
          params.append('sorts', sortColumn);
        }
        if (filters) {
          params.append('filters', filters);
        }

        const queryString = params.toString();
        const url = `${getApiBaseUrl()}/transactions${queryString ? '?' + queryString : ''}`;

        try {
          const button = document.getElementById('getTransactions');
          const originalText = button.textContent;
          button.textContent = 'Loading...';
          button.disabled = true;

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
          });

          const responseText = await response.text();

          // Try to parse and format the JSON response
          let formattedText;
          try {
            const jsonData = JSON.parse(responseText);
            formattedText = JSON.stringify(jsonData, null, 2);
          } catch (parseError) {
            // If JSON parsing fails, show the raw response
            formattedText = responseText;
          }

          // Display the formatted response
          resultsText.textContent = formattedText;
          resultsContainer.classList.add('show');

          button.textContent = originalText;
          button.disabled = false;
        } catch (error) {
          resultsText.textContent = `Error: ${error.message}`;
          resultsContainer.classList.add('show');

          const button = document.getElementById('getTransactions');
          button.textContent = 'Get Transactions';
          button.disabled = false;
        }
      }

      // Get Auth Transactions function
      async function getAuthTransactions() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        const container = document.getElementById('authTransactionsContainer');
        const loading = document.getElementById('authTransactionsLoading');
        const errorDiv = document.getElementById('authTransactionsError');
        const tableHeader = document.getElementById('authTransactionsHeader');
        const tableBody = document.getElementById('authTransactionsBody');
        const button = document.getElementById('getAuthTransactionsBtn');

        // Reset selection state
        selectedTransaction = null;
        captureBtn.disabled = true;
        captureBtn.style.opacity = '0.5';
        captureBtn.style.cursor = 'not-allowed';

        if (!apiKey) {
          showAlert(
            errorDiv,
            'API key is missing. Please configure it at the top of the page first.',
            'error'
          );
          container.classList.add('show');
          return;
        }

        // Generate today's date range in UTC
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(startOfDay);
        endOfDay.setDate(endOfDay.getDate() + 1);

        const startOfDayUTC = startOfDay.toISOString();
        const endOfDayUTC = endOfDay.toISOString();

        // Build the filters with explicit descending sort
        const filters = `timestamp>=${startOfDayUTC},timestamp<${endOfDayUTC},type==Auth,amount>=1`;
        const sorts = '-timestamp'; // Negative sign for descending order
        const url = `${getApiBaseUrl()}/transactions?filters=${encodeURIComponent(filters)}&sorts=${sorts}`;

        try {
          // Show loading state
          const originalText = button.textContent;
          button.textContent = 'Loading...';
          button.disabled = true;
          loading.style.display = 'block';
          errorDiv.style.display = 'none';
          container.classList.add('show');

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
          });

          const responseText = await response.text();

          // Parse the response
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error(`Invalid JSON response: ${responseText}`);
          }

          if (!response.ok) {
            throw new Error(`API Error ${response.status}: ${data.message || responseText}`);
          }

          // Check if we have transactions
          if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
            showAlert(errorDiv, 'No Auth transactions found for today.', 'error');
            loading.style.display = 'none';
            button.textContent = originalText;
            button.disabled = false;
            return;
          }

          // Generate table headers from the first transaction with custom order
          const firstTransaction = data.items[0];
          const allHeaders = Object.keys(firstTransaction);

          // Define specific column order - first 5 columns in specified order, then rest alphabetically
          const priorityHeaders = ['timestamp', 'type', 'amount', 'referenceId', 'id'];
          const remainingHeaders = allHeaders
            .filter((header) => !priorityHeaders.includes(header))
            .sort(); // Sort remaining headers alphabetically

          const headers = [...priorityHeaders, ...remainingHeaders];

          // Create header row
          tableHeader.innerHTML = '';
          const headerRow = document.createElement('tr');
          headers.forEach((header) => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
          });
          tableHeader.appendChild(headerRow);

          // Create data rows with click handlers
          tableBody.innerHTML = '';
          data.items.forEach((transaction, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-transaction-index', index);

            // Add click handler for row selection
            row.addEventListener('click', function () {
              // Remove selection from other rows
              document.querySelectorAll('#authTransactionsTable tbody tr').forEach((r) => {
                r.classList.remove('selected');
              });

              // Select this row
              this.classList.add('selected');

              // Store selected transaction data
              selectedTransaction = transaction;

              // Enable capture button
              captureBtn.disabled = false;
              captureBtn.style.opacity = '1';
              captureBtn.style.cursor = 'pointer';
            });

            headers.forEach((header) => {
              const td = document.createElement('td');
              const value = transaction[header];

              // Format the value for display
              if (value === null || value === undefined) {
                td.textContent = '';
              } else if (typeof value === 'object') {
                td.textContent = JSON.stringify(value);
              } else {
                td.textContent = String(value);
              }

              row.appendChild(td);
            });
            tableBody.appendChild(row);
          });

          // Hide loading, restore button
          loading.style.display = 'none';
          button.textContent = originalText;
          button.disabled = false;
        } catch (error) {
          console.error('Error fetching Auth transactions:', error);
          showAlert(errorDiv, `Error: ${error.message}`, 'error');
          loading.style.display = 'none';
          button.textContent = 'Get Auth Transactions';
          button.disabled = false;
        }
      }
      // Toggle between datetime and date-only inputs
      function toggleTimestampExactInputs() {
        const datetimeInput = document.getElementById('txnTimestampExact');
        const dateOnlyInput = document.getElementById('txnTimestampDateOnly');
        const isDateTime =
          document.querySelector('input[name="timestampExactType"]:checked').value === 'datetime';

        if (isDateTime) {
          datetimeInput.style.display = 'block';
          dateOnlyInput.style.display = 'none';
        } else {
          datetimeInput.style.display = 'none';
          dateOnlyInput.style.display = 'block';
        }
      }

      // Set maximum date/time to current date/time
      function setMaxDateTime() {
        const now = new Date();
        const maxDateTime = now.toISOString().slice(0, 16); // Format: YYYY-MM-DDTHH:MM
        const maxDate = now.toISOString().slice(0, 10); // Format: YYYY-MM-DD

        // Set max for all datetime-local inputs
        const datetimeInputs = document.querySelectorAll('input[type="datetime-local"]');
        datetimeInputs.forEach((input) => {
          input.max = maxDateTime;
        });

        // Set max for date input
        const dateInput = document.getElementById('txnTimestampDateOnly');
        if (dateInput) {
          dateInput.max = maxDate;
        }
      }
      // Add New Card button event listener
      const addNewCardBtn = document.getElementById('addNewCardBtn');
      if (addNewCardBtn) {
        addNewCardBtn.addEventListener('click', () => {
          createCardNotPresentToken();
        });
      }

      // Process capture transaction
      async function processCapture() {
        if (!selectedTransaction) {
          alert('Please select a transaction first.');
          return;
        }

        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        if (!apiKey) {
          alert('API key is missing. Please configure it at the top of the page first.');
          return;
        }

        // Show popup with auth amount and request capture amount
        const authAmount = selectedTransaction.amount || 'Unknown';
        const captureAmountStr = prompt(
          `Auth Transaction Amount: ${authAmount} cents\n\nEnter capture amount in cents (leave blank to capture full amount):`
        );

        if (captureAmountStr === null) {
          // User canceled
          return;
        }

        // Ask user to choose between referenceId or transactionId
        const useReferenceId = confirm(
          `Choose which field to use:\n\n` +
            `Click OK to use Auth's referenceId: ${selectedTransaction.referenceId || 'N/A'}\n` +
            `Click Cancel to use Auth's transactionId: ${selectedTransaction.id || 'N/A'}`
        );

        // Build request data
        const requestData = {
          referenceId: localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`, // Use form's referenceId
        };

        // Add originalReferenceId OR originalTransactionId based on user choice
        if (useReferenceId) {
          if (selectedTransaction.referenceId) {
            requestData.originalReferenceId = selectedTransaction.referenceId;
          } else {
            alert(
              'Selected transaction does not have a referenceId. Please try again and choose transactionId.'
            );
            return;
          }
        } else {
          if (selectedTransaction.id) {
            requestData.originalTransactionId = selectedTransaction.id;
          } else {
            alert(
              'Selected transaction does not have a transactionId. Please try again and choose referenceId.'
            );
            return;
          }
        }

        // Add amount if provided
        if (captureAmountStr.trim() !== '') {
          const captureAmount = parseInt(captureAmountStr.trim());
          if (isNaN(captureAmount) || captureAmount <= 0) {
            alert('Please enter a valid amount in cents.');
            return;
          }
          requestData.amount = captureAmount;
        }

        // Add optional fields from the form (not from selected transaction)
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE);
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE);

        if (invoiceNumber) {
          requestData.invoiceNumber = invoiceNumber;
        }
        if (orderNumber) {
          requestData.orderNumber = orderNumber;
        }

        try {
          // Show loading state
          const originalText = captureBtn.textContent;
          captureBtn.textContent = 'Processing...';
          captureBtn.disabled = true;

          console.log('Capture request:', JSON.stringify(requestData, null, 2));

          const response = await fetch(`${getApiBaseUrl()}/transactions/capture`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
            body: JSON.stringify(requestData),
          });

          const responseText = await response.text();
          let data;

          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error(`Invalid JSON response: ${responseText}`);
          }

          if (!response.ok) {
            let errorMessage = extractErrorMessage(data);
            if (errorMessage === 'API request failed') {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          // Success - show detailed response
          const usedField = useReferenceId ? 'originalReferenceId' : 'originalTransactionId';
          const usedValue = useReferenceId
            ? requestData.originalReferenceId
            : requestData.originalTransactionId;

          const successMessage =
            `Capture successful!\n` +
            `Transaction ID: ${data.id || 'Unknown'}\n` +
            `Result: ${data.resultText || 'Success'}\n` +
            `Used ${usedField}: ${usedValue}`;

          alert(successMessage);

          // Refresh the auth transactions list
          getAuthTransactions();
        } catch (error) {
          console.error('Error processing capture:', error);
          alert(`Capture failed: ${error.message}`);
        } finally {
          // Reset button state
          captureBtn.textContent = 'Capture';
          captureBtn.disabled = true;
          captureBtn.style.opacity = '0.5';
          captureBtn.style.cursor = 'not-allowed';

          // Clear selection
          selectedTransaction = null;
          document.querySelectorAll('#authTransactionsTable tbody tr').forEach((row) => {
            row.classList.remove('selected');
          });
        }
      }

      // Process token auth transaction
      async function processTokenAuth(tokenId) {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);

        if (!apiKey) {
          alert('API key is missing. Please enter and save your API key.');
          return;
        }

        if (!tokenId) {
          alert('Please select a payment method first.');
          return;
        }

        // Get configuration values
        const referenceId = localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`;
        const amount = parseInt(localStorage.getItem(AMOUNT_STORAGE) || '7273');
        const tax = parseInt(localStorage.getItem(TAX_STORAGE) || '0');
        const cashBack = parseInt(localStorage.getItem(CASHBACK_STORAGE) || '0');
        const tip = parseInt(localStorage.getItem(TIP_STORAGE) || '0');
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE) || `inv_${Date.now()}`;
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE) || `ord_${Date.now()}`;

        // Get breakdown values
        let amountGoodsAndServices = parseInt(
          localStorage.getItem(AMOUNT_GOODS_SERVICES_STORAGE) || '0'
        );

        try {
          // Show loading state
          const originalButtonText = tokenAuthBtn.textContent;
          tokenAuthBtn.textContent = 'Processing...';
          tokenAuthBtn.disabled = true;

          // Prepare request data
          const requestData = {
            referenceId: referenceId,
            paymentMethodId: tokenId,
            amount: amount,
            invoiceNumber: invoiceNumber,
            orderNumber: orderNumber,
          };

          // Only add amountBreakdown if at least one field has a value
          if (amountGoodsAndServices > 0 || tax > 0 || cashBack > 0 || tip > 0) {
            requestData.amountBreakdown = {
              tax: tax,
              cashBack: cashBack,
              tip: tip,
              amountGoodsAndServices: amountGoodsAndServices,
            };
          }

          console.log('Token auth request:', JSON.stringify(requestData, null, 2));

          // Make the API request
          const endpoint = `${getApiBaseUrl()}/transactions/token-auth`;
          const headers = {
            'Content-Type': 'application/json',
            'x-api-key': apiKey,
          };
          const body = JSON.stringify(requestData);

          console.log('Token Auth API Request:', { endpoint, headers, body });

          const response = await fetch(endpoint, {
            method: 'POST',
            headers: headers,
            body: body,
          });

          const responseText = await response.text();
          console.log('Token Auth API Response:', responseText);

          let data;
          try {
            if (responseText && responseText.trim() !== '') {
              data = JSON.parse(responseText);
            } else {
              throw new Error('Empty response');
            }
          } catch (error) {
            console.error('Error parsing response:', error);
            alert(`Error: Invalid response format\n\nRaw response: ${responseText}`);
            return;
          }

          // Handle error response
          if (!response.ok) {
            let errorMessage = `Error: API returned an error.\n\nStatus: ${response.status}\n\nRaw Response:\n${responseText}`;
            alert(errorMessage);
            return;
          }

          // Handle successful response
          console.log('Token Auth successful:', data);
          alert(
            `Token Auth successful!\nTransaction ID: ${data.id || 'Unknown'}\nResult: ${data.resultText || 'Success'}`
          );
        } catch (error) {
          console.error('Error processing token auth:', error);
          alert(`Token Auth processing error: ${error.message}`);
        } finally {
          // Reset button state
          tokenAuthBtn.textContent = 'Token Auth';
          tokenAuthBtn.disabled = false;
        }
      }
      // Get Sale/Capture Transactions function
      async function getSaleCaptureTransactions() {
        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        const container = document.getElementById('saleCaptureTransactionsContainer');
        const loading = document.getElementById('saleCaptureTransactionsLoading');
        const errorDiv = document.getElementById('saleCaptureTransactionsError');
        const tableHeader = document.getElementById('saleCaptureTransactionsHeader');
        const tableBody = document.getElementById('saleCaptureTransactionsBody');
        const button = document.getElementById('getSaleCaptureTransactionsBtn');

        if (!apiKey) {
          showAlert(
            errorDiv,
            'API key is missing. Please configure it at the top of the page first.',
            'error'
          );
          container.classList.add('show');
          return;
        }

        // Reset selection state
        selectedSaleCaptureTransaction = null;
        refundBtn.disabled = true;
        refundBtn.style.opacity = '0.5';
        refundBtn.style.cursor = 'not-allowed';

        // Generate today's date range in UTC
        const today = new Date();
        const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const endOfDay = new Date(startOfDay);
        endOfDay.setDate(endOfDay.getDate() + 1);

        const startOfDayUTC = startOfDay.toISOString();
        const endOfDayUTC = endOfDay.toISOString();

        // Build the filters for Sale OR Capture types with sorting
        const filters = `timestamp>=${startOfDayUTC},timestamp<${endOfDayUTC},type==Sale|Capture,amount>=1`;
        const sorts = '-timestamp'; // Descending order (most recent first)
        const url = `${getApiBaseUrl()}/transactions?filters=${encodeURIComponent(filters)}&sorts=${sorts}`;

        try {
          // Show loading state
          const originalText = button.textContent;
          button.textContent = 'Loading...';
          button.disabled = true;
          loading.style.display = 'block';
          errorDiv.style.display = 'none';
          container.classList.add('show');

          const response = await fetch(url, {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
          });

          const responseText = await response.text();

          // Parse the response
          let data;
          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error(`Invalid JSON response: ${responseText}`);
          }

          if (!response.ok) {
            throw new Error(`API Error ${response.status}: ${data.message || responseText}`);
          }

          // Check if we have transactions
          if (!data.items || !Array.isArray(data.items) || data.items.length === 0) {
            showAlert(errorDiv, 'No Sale/Capture transactions found for today.', 'error');
            loading.style.display = 'none';
            button.textContent = originalText;
            button.disabled = false;
            return;
          }

          // Generate table headers from the first transaction with custom order
          const firstTransaction = data.items[0];
          const allHeaders = Object.keys(firstTransaction);

          // Define specific column order - first 5 columns in specified order, then rest alphabetically
          const priorityHeaders = ['timestamp', 'type', 'amount', 'referenceId', 'id'];
          const remainingHeaders = allHeaders
            .filter((header) => !priorityHeaders.includes(header))
            .sort(); // Sort remaining headers alphabetically

          const headers = [...priorityHeaders, ...remainingHeaders];

          // Create header row
          tableHeader.innerHTML = '';
          const headerRow = document.createElement('tr');
          headers.forEach((header) => {
            const th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
          });
          tableHeader.appendChild(headerRow);

          // Create data rows with click handlers
          tableBody.innerHTML = '';
          data.items.forEach((transaction, index) => {
            const row = document.createElement('tr');
            row.setAttribute('data-transaction-index', index);

            // Add click handler for row selection
            row.addEventListener('click', function () {
              // Remove selection from other rows
              document.querySelectorAll('#saleCaptureTransactionsTable tbody tr').forEach((r) => {
                r.classList.remove('selected');
              });

              // Select this row
              this.classList.add('selected');

              // Store selected transaction data
              selectedSaleCaptureTransaction = transaction;

              // Enable refund button
              refundBtn.disabled = false;
              refundBtn.style.opacity = '1';
              refundBtn.style.cursor = 'pointer';
            });

            headers.forEach((header) => {
              const td = document.createElement('td');
              const value = transaction[header];

              // Format the value for display
              if (value === null || value === undefined) {
                td.textContent = '';
              } else if (typeof value === 'object') {
                td.textContent = JSON.stringify(value);
              } else {
                td.textContent = String(value);
              }

              row.appendChild(td);
            });
            tableBody.appendChild(row);
          });

          // Hide loading, restore button
          loading.style.display = 'none';
          button.textContent = originalText;
          button.disabled = false;
        } catch (error) {
          console.error('Error fetching Sale/Capture transactions:', error);
          showAlert(errorDiv, `Error: ${error.message}`, 'error');
          loading.style.display = 'none';
          button.textContent = 'Get Sale/Capture Trx';
          button.disabled = false;
        }
      }
      // Process refund transaction
      async function processRefund() {
        if (!selectedSaleCaptureTransaction) {
          alert('Please select a transaction first.');
          return;
        }

        const apiKey = localStorage.getItem(API_KEY_STORAGE);
        if (!apiKey) {
          alert('API key is missing. Please configure it at the top of the page first.');
          return;
        }

        // Show popup with original amount and request refund amount
        const originalAmount = selectedSaleCaptureTransaction.amount || 'Unknown';
        const refundAmountStr = prompt(
          `Original Transaction Amount: ${originalAmount} cents\n\nEnter refund amount in cents (leave blank to refund full amount):`
        );

        if (refundAmountStr === null) {
          // User canceled
          return;
        }

        // Ask user to choose between referenceId or transactionId
        const useReferenceId = confirm(
          `Choose which field to use:\n\n` +
            `Click OK to use transaction's referenceId: ${selectedSaleCaptureTransaction.referenceId || 'N/A'}\n` +
            `Click Cancel to use transaction's transactionId: ${selectedSaleCaptureTransaction.id || 'N/A'}`
        );

        // Build request data
        const requestData = {
          referenceId: localStorage.getItem(REFERENCE_ID_STORAGE) || `ref_${Date.now()}`,
        };

        // Add originalReferenceId OR originalTransactionId based on user choice
        if (useReferenceId) {
          if (selectedSaleCaptureTransaction.referenceId) {
            requestData.originalReferenceId = selectedSaleCaptureTransaction.referenceId;
          } else {
            alert(
              'Selected transaction does not have a referenceId. Please try again and choose transactionId.'
            );
            return;
          }
        } else {
          if (selectedSaleCaptureTransaction.id) {
            requestData.originalTransactionId = selectedSaleCaptureTransaction.id;
          } else {
            alert(
              'Selected transaction does not have a transactionId. Please try again and choose referenceId.'
            );
            return;
          }
        }

        // Add amount if provided
        if (refundAmountStr.trim() !== '') {
          const refundAmount = parseInt(refundAmountStr.trim());
          if (isNaN(refundAmount) || refundAmount <= 0) {
            alert('Please enter a valid amount in cents.');
            return;
          }
          requestData.amount = refundAmount;
        }

        // Add optional fields from the form
        const invoiceNumber = localStorage.getItem(INVOICE_NUMBER_STORAGE);
        const orderNumber = localStorage.getItem(ORDER_NUMBER_STORAGE);

        if (invoiceNumber) {
          requestData.invoiceNumber = invoiceNumber;
        }
        if (orderNumber) {
          requestData.orderNumber = orderNumber;
        }

        try {
          // Show loading state
          const originalText = refundBtn.textContent;
          refundBtn.textContent = 'Processing...';
          refundBtn.disabled = true;

          console.log('Refund request:', JSON.stringify(requestData, null, 2));

          const response = await fetch(`${getApiBaseUrl()}/transactions/refund`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'x-api-key': apiKey,
            },
            body: JSON.stringify(requestData),
          });

          const responseText = await response.text();
          let data;

          try {
            data = JSON.parse(responseText);
          } catch (parseError) {
            throw new Error(`Invalid JSON response: ${responseText}`);
          }

          if (!response.ok) {
            let errorMessage = extractErrorMessage(data);
            if (errorMessage === 'API request failed') {
              errorMessage = `Error ${response.status}: ${response.statusText}`;
            }
            throw new Error(errorMessage);
          }

          // Success
          const usedField = useReferenceId ? 'originalReferenceId' : 'originalTransactionId';
          const usedValue = useReferenceId
            ? requestData.originalReferenceId
            : requestData.originalTransactionId;

          const successMessage =
            `Refund successful!\n` +
            `Transaction ID: ${data.id || 'Unknown'}\n` +
            `Result: ${data.resultText || 'Success'}\n` +
            `Used ${usedField}: ${usedValue}`;

          alert(successMessage);

          // Refresh the sale/capture transactions list
          getSaleCaptureTransactions();
        } catch (error) {
          console.error('Error processing refund:', error);
          alert(`Refund failed: ${error.message}`);
        } finally {
          // Reset button state
          refundBtn.textContent = 'Refund';
          refundBtn.disabled = true;
          refundBtn.style.opacity = '0.5';
          refundBtn.style.cursor = 'not-allowed';

          // Clear selection
          selectedSaleCaptureTransaction = null;
          document.querySelectorAll('#saleCaptureTransactionsTable tbody tr').forEach((row) => {
            row.classList.remove('selected');
          });
        }
      }
      // Create Token button event listener
      if (createTokenBtn) {
        createTokenBtn.addEventListener('click', () => {
          // Reset modal state
          paymentIframe.style.display = 'none';
          apiError.style.display = 'none';
          spinner.style.display = 'block';

          // Display the modal for creating token
          cardModal.style.display = 'flex';
          toggleBlur(true);

          // Call the existing function
          createCardNotPresentToken();
        });
      }
    </script>
  </body>
</html>
