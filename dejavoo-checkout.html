<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>Dejavoo Checkout</title>

    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Georgia', 'Times New Roman', serif;
        background-color: #f8f8f8;
        color: #333;
        line-height: 1.6;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px;
      }

      .header {
        text-align: center;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 1px solid #ddd;
      }

      .header h1 {
        font-size: 1.5rem;
        font-weight: 400;
        letter-spacing: 2px;
        text-transform: uppercase;
        color: #8b7355;
      }

      .checkout-wrapper {
        display: flex;
        gap: 40px;
        align-items: flex-start;
      }

      @media (max-width: 968px) {
        .checkout-wrapper {
          flex-direction: column;
        }
      }

      .checkout-main {
        flex: 1;
        background: white;
        padding: 40px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .checkout-sidebar {
        width: 380px;
        background: white;
        padding: 30px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      @media (max-width: 968px) {
        .checkout-sidebar {
          width: 100%;
        }
      }

      .progress-steps {
        display: flex;
        justify-content: space-between;
        margin-bottom: 40px;
        padding-bottom: 20px;
        border-bottom: 2px solid #f0f0f0;
      }

      .step {
        display: flex;
        align-items: center;
        gap: 10px;
        color: #999;
        font-size: 0.9rem;
      }

      .step.active {
        color: #8b7355;
        font-weight: 600;
      }

      .step-number {
        display: inline-block;
        width: 24px;
        height: 24px;
        line-height: 24px;
        text-align: center;
        border-radius: 50%;
        background: #f0f0f0;
        color: #999;
        font-size: 0.85rem;
      }

      .step.active .step-number {
        background: #8b7355;
        color: white;
      }

      .section-title {
        font-size: 1.3rem;
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 1px;
        color: #8b7355;
        margin-bottom: 30px;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
      }

      label .required {
        color: #d9534f;
      }

      input[type='text'],
      input[type='email'],
      input[type='tel'],
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        font-size: 0.95rem;
        font-family: inherit;
        transition: border-color 0.3s;
      }

      input[type='text']:focus,
      input[type='email']:focus,
      input[type='tel']:focus,
      select:focus {
        outline: none;
        border-color: #8b7355;
      }

      .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 15px;
      }

      .help-text {
        font-size: 0.75rem;
        color: #999;
        margin-top: 5px;
      }

      .security-notice {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 12px;
        background: #f9f9f9;
        border-left: 3px solid #8b7355;
        margin-bottom: 25px;
        font-size: 0.85rem;
        color: #666;
      }

      .btn {
        width: 100%;
        padding: 16px;
        background: #8b7355;
        color: white;
        border: none;
        font-size: 1rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: background 0.3s;
      }

      .btn:hover:not(:disabled) {
        background: #6f5a43;
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: white;
        color: #8b7355;
        border: 2px solid #8b7355;
      }

      .btn-secondary:hover:not(:disabled) {
        background: #f9f9f9;
      }

      /* Sidebar Styles */
      .order-item {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
        padding-bottom: 20px;
        border-bottom: 1px solid #f0f0f0;
      }

      .order-item:last-child {
        border-bottom: none;
      }

      .item-image {
        width: 60px;
        height: 60px;
        background: #f0f0f0;
        border: 1px solid #ddd;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        color: #999;
      }

      .item-details {
        flex: 1;
      }

      .item-title {
        font-size: 0.9rem;
        font-weight: 600;
        margin-bottom: 4px;
        color: #333;
      }

      .item-subtitle {
        font-size: 0.8rem;
        color: #999;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .item-price {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9rem;
      }

      .item-quantity {
        color: #666;
      }

      .summary-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 12px;
        font-size: 0.9rem;
      }

      .summary-row.total {
        border-top: 2px solid #f0f0f0;
        padding-top: 15px;
        margin-top: 15px;
        font-size: 1.1rem;
        font-weight: 600;
      }

      .summary-row .label {
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #666;
      }

      .summary-row.total .label {
        color: #333;
      }

      .savings {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        background: #f0f9f0;
        border-left: 3px solid #5cb85c;
        margin-top: 15px;
        font-size: 0.85rem;
        color: #5cb85c;
      }

      .help-contact {
        margin-top: 25px;
        padding-top: 25px;
        border-top: 1px solid #f0f0f0;
        text-align: center;
        font-size: 0.85rem;
        color: #666;
      }

      .help-contact a {
        color: #8b7355;
        text-decoration: none;
      }

      .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 4px;
      }

      .alert-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
      }

      .alert-error {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
      }

      .alert-info {
        background: #d1ecf1;
        border-left: 4px solid #17a2b8;
        color: #0c5460;
      }

      .review-section {
        background: #f9f9f9;
        padding: 20px;
        margin-bottom: 20px;
        border: 1px solid #e0e0e0;
      }

      .review-section h3 {
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #8b7355;
        margin-bottom: 12px;
      }

      .review-content {
        font-size: 0.9rem;
        color: #333;
        line-height: 1.6;
      }

      .edit-link {
        color: #8b7355;
        text-decoration: none;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
        border: none;
        background: none;
        padding: 0;
      }

      .edit-link:hover {
        text-decoration: underline;
      }

      .processing-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }

      .processing-overlay.active {
        display: flex;
      }

      .processing-content {
        background: white;
        padding: 40px;
        border-radius: 8px;
        text-align: center;
        max-width: 400px;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #8b7355;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .step-content {
        display: none;
      }

      .step-content.active {
        display: block;
      }

      .transaction-details {
        background: #f9f9f9;
        padding: 20px;
        margin-top: 20px;
        border: 1px solid #e0e0e0;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
      }

      .customer-info-box {
        background: #f9f9f9;
        padding: 15px;
        margin-top: 15px;
        border: 1px solid #e0e0e0;
      }

      .saved-cards {
        margin-top: 20px;
      }

      .card-option {
        background: #f9f9f9;
        border: 2px solid #ddd;
        padding: 15px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .card-option:hover {
        border-color: #8b7355;
        background: #fff;
      }

      .card-option.selected {
        border-color: #8b7355;
        background: #fff;
      }

      .card-option input[type='radio'] {
        width: 18px;
        height: 18px;
      }

      .checkbox-label {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f0f9f0;
        border: 1px solid #d4edda;
        margin-top: 20px;
        cursor: pointer;
      }

      .checkbox-label input[type='checkbox'] {
        width: 18px;
        height: 18px;
      }

      .payment-divider {
        display: flex;
        align-items: center;
        margin: 30px 0;
        color: #999;
        font-size: 0.85rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .payment-divider::before,
      .payment-divider::after {
        content: '';
        flex: 1;
        height: 1px;
        background: #ddd;
      }

      .payment-divider span {
        padding: 0 15px;
      }

      #ipospays-gpay-btn {
        margin: 20px 0;
      }
    </style>

    <!-- Dejavoo Freedom to Design Library - Dynamically loaded -->
    <script id="ftd" defer></script>
    <!-- Google Pay SDK - Script tag must exist in DOM before SDK loads -->
    <script id="gpayftd"></script>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Checkout</h1>
      </div>

      <div class="checkout-wrapper">
        <!-- Main Content -->
        <div class="checkout-main">
          <!-- Loading indicator -->
          <div id="loadingConfig" class="alert alert-info" style="display: none">
            <span>‚è≥</span> Loading payment configuration...
          </div>

          <!-- Progress Steps -->
          <div class="progress-steps">
            <div class="step active" id="step1-indicator">
              <span class="step-number">1</span>
              <span>Customer</span>
            </div>
            <div class="step" id="step2-indicator">
              <span class="step-number">2</span>
              <span>Payment</span>
            </div>
            <div class="step" id="step3-indicator">
              <span class="step-number">3</span>
              <span>Review</span>
            </div>
          </div>

          <!-- Step 1: Customer Selection -->
          <div class="step-content active" id="step1">
            <h2 class="section-title">Select Customer</h2>

            <div id="customerAlerts"></div>

            <div class="form-group">
              <label>Customer <span class="required">*</span></label>
              <select id="customerSelect" onchange="handleCustomerChange()">
                <option value="">-- Select Customer --</option>
                <option value="guest">üé´ Checkout as Guest</option>
              </select>
            </div>

            <div id="customerInfoBox" class="customer-info-box" style="display: none">
              <strong>Customer Details:</strong>
              <div id="customerInfo" style="margin-top: 10px"></div>
            </div>

            <button type="button" class="btn" id="continueToPayment" onclick="continueToPayment()" disabled>
              Continue to Payment
            </button>
          </div>

          <!-- Step 2: Payment -->
          <div class="step-content" id="step2">
            <h2 class="section-title">Payment</h2>

            <div class="security-notice">
              <span>üîí</span>
              All transactions are secure and encrypted
            </div>

            <div id="paymentAlerts"></div>

            <!-- Google Pay Button -->
            <div id="ipospays-gpay-btn" data-security-key=""></div>

            <div class="payment-divider">
              <span>Or pay with card</span>
            </div>

            <!-- Saved Cards Section -->
            <div id="savedCardsSection" style="display: none">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666">SAVED PAYMENT METHODS</h3>
              <div id="savedCardsList" class="saved-cards"></div>
            </div>

            <!-- CVV for saved card -->
            <div id="savedCardCvv" style="display: none">
              <div class="form-group">
                <label>CVV <span class="required">*</span></label>
                <input type="text" id="savedCvv" placeholder="123" maxlength="4" />
                <div class="help-text">Security code required for saved cards</div>
              </div>
            </div>

            <!-- New Card Form -->
            <div id="newCardForm">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666" id="newCardHeading">CARD DETAILS</h3>
              
              <form id="paymentForm">
                <div class="form-group">
                  <label>Card Number <span class="required">*</span></label>
                  <input
                    type="text"
                    id="ccnumber"
                    placeholder="1234 1234 1234 1234"
                    maxlength="19"
                  />
                </div>

                <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                  <div class="form-group">
                    <label>Expiry Month <span class="required">*</span></label>
                    <input type="text" id="ccexpiry" placeholder="MM/YY" maxlength="5" />
                  </div>

                  <div class="form-group">
                    <label>CVV <span class="required">*</span></label>
                    <input type="text" id="cccvv" placeholder="123" maxlength="4" />
                    <div class="help-text">3-4 digits on back</div>
                  </div>
                </div>

                <!-- Save card option (for returning customers) -->
                <div id="saveCardOption" style="display: none; margin-bottom: 30px;">
                  <label class="checkbox-label">
                    <input type="checkbox" id="saveCardCheckbox" checked />
                    <span>Save this card for future purchases</span>
                  </label>
                </div>

                <h3 class="section-title" style="margin-top: 30px; font-size: 1rem">Billing</h3>

                <div class="form-group">
                  <label>Name <span class="required">*</span></label>
                  <input type="text" id="billingName" />
                </div>

                <div class="form-group">
                  <label>Address <span class="required">*</span></label>
                  <input type="text" id="billingAddress" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>City <span class="required">*</span></label>
                    <input type="text" id="billingCity" />
                  </div>

                  <div class="form-group">
                    <label>State <span class="required">*</span></label>
                    <input type="text" id="billingState" maxlength="2" />
                  </div>

                  <div class="form-group">
                    <label>Zip <span class="required">*</span></label>
                    <input type="text" id="billingZip" />
                  </div>
                </div>
              </form>
            </div>

            <button type="button" class="btn" style="margin-top: 20px" onclick="continueToReview()">
              Continue to Review
            </button>
          </div>

          <!-- Step 3: Review -->
          <div class="step-content" id="step3">
            <h2 class="section-title">Review</h2>

            <div id="reviewAlerts"></div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Customer</h3>
                <button class="edit-link" onclick="editStep(1)">Edit</button>
              </div>
              <div class="review-content" id="reviewCustomer"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Payment</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewPayment"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Billing Address</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewBilling"></div>
            </div>

            <button type="button" class="btn" onclick="placeOrder()">Place Order</button>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="checkout-sidebar">
          <div class="order-item">
            <div class="item-image">
              <img
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23f0f0f0' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='10'%3EWine%3C/text%3E%3C/svg%3E"
                alt="Product"
                style="width: 100%; height: 100%"
              />
            </div>
            <div class="item-details">
              <div class="item-title">Humboldt Single Vineyard Pinot Pack</div>
              <div class="item-subtitle">Three-Pack</div>
              <div class="item-price">
                <span>$155.00</span>
                <span class="item-quantity">√ó 1</span>
                <span style="margin-left: auto">$155.00</span>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <div class="summary-row">
              <span class="label">Subtotal (3)</span>
              <span>$155.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Shipping (UPS Ground)</span>
              <span><s style="color: #999">$31.93</s> $0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Tax</span>
              <span>$0.00</span>
            </div>
            <div class="summary-row total">
              <span class="label">Total</span>
              <span>USD $155.00</span>
            </div>
          </div>

          <div class="savings">
            <span>üí∞</span>
            <span>Shipping Included on Humboldt Three-Packs - $31.93 SAVED</span>
          </div>

          <div class="help-contact">
            Need help? Call us at<br />
            <a href="tel:7078201621">(707) 820-1621</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
      <div class="processing-content">
        <div class="spinner"></div>
        <h3 style="margin-bottom: 10px; color: #333">Processing Payment...</h3>
        <p style="color: #666; font-size: 0.9rem" id="processingMessage">
          Please wait while we process your transaction
        </p>
      </div>
    </div>

    <script>
      // Configuration
      let MERCHANT_ID = '';
      let API_AUTH_TOKEN = '';
      let DEJAVOO_AUTH_TOKEN = '';
      let ENVIRONMENT = 'sandbox';
      let API_BASE_URL = '';

      let currentStep = 1;
      let selectedCustomer = null;
      let savedCards = [];
      let selectedPaymentMethod = 'new'; // 'new', 'googlepay', or token_id
      let paymentTokenId = null;
      let reusableToken = null;
      let configLoaded = false;
      let googlePayInitialized = false;
      let googlePayData = null;

      // Load configuration
      async function loadConfig() {
        const loadingEl = document.getElementById('loadingConfig');
        loadingEl.style.display = 'block';

        try {
          console.log('üîÑ Loading configuration...');
          const response = await fetch('/.netlify/functions/get-dejavoo-config');
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const config = await response.json();
          
          DEJAVOO_AUTH_TOKEN = config.dejavooAuthToken;
          MERCHANT_ID = config.merchantId;
          API_AUTH_TOKEN = config.apiAuthToken;
          ENVIRONMENT = config.environment;

          const isSandbox = ENVIRONMENT === 'sandbox';
          API_BASE_URL = isSandbox
            ? 'https://payment.ipospays.tech/api/v2/iposTransact'
            : 'https://payment.ipospays.com/api/v2/iposTransact';

          const ftdScript = document.getElementById('ftd');
          const scriptUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/freedomtodesign.js'
            : 'https://payment.ipospays.com/ftd/v1/freedomtodesign.js';

          ftdScript.setAttribute('src', scriptUrl);
          ftdScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);

          await new Promise((resolve, reject) => {
            ftdScript.onload = resolve;
            ftdScript.onerror = reject;
          });

          // Configure Google Pay SDK using existing script tag
          const gpayScript = document.getElementById('gpayftd');
          const gpayUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/gpay-ftd.js'
            : 'https://payment.ipospays.com/ftd/v1/gpay-ftd.js';
          
          // Set security_key attribute FIRST
          gpayScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          // Then set src to load the script
          gpayScript.src = gpayUrl;
          
          gpayScript.onload = () => {
            console.log('‚úÖ Google Pay SDK loaded');
          };
          gpayScript.onerror = (error) => {
            console.warn('‚ö†Ô∏è Google Pay SDK failed to load:', error);
          };

          console.log('‚úÖ Configuration loaded');
          loadingEl.style.display = 'none';
          configLoaded = true;

          // Load customers
          await loadCustomers();
        } catch (error) {
          console.error('‚ùå Configuration error:', error);
          loadingEl.innerHTML = `<div class="alert alert-error">Configuration Error: ${error.message}</div>`;
        }
      }

      // Setup Google Pay
      function setupGooglePay() {
        if (!configLoaded || googlePayInitialized) return;

        // Wait a bit for SDK to load if not ready yet
        if (typeof window.initializeGooglePay !== 'function') {
          console.log('‚è≥ Waiting for Google Pay SDK...');
          setTimeout(setupGooglePay, 500);
          return;
        }

        try {
          console.log('üîß Setting up Google Pay...');
          console.log('üìç DEJAVOO_AUTH_TOKEN:', DEJAVOO_AUTH_TOKEN ? 'Present (length: ' + DEJAVOO_AUTH_TOKEN.length + ')' : 'MISSING');
          
          // Try setting security_key as global variable
          window.security_key = DEJAVOO_AUTH_TOKEN;
          
          // Check script tag
          const gpayScriptTag = document.getElementById('gpayftd');
          console.log('üìú Google Pay script tag found:', !!gpayScriptTag);
          if (gpayScriptTag) {
            console.log('  - security_key attribute:', gpayScriptTag.getAttribute('security_key'));
            console.log('  - src:', gpayScriptTag.getAttribute('src'));
            // Force set it again right before init
            gpayScriptTag.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          }
          
          // Set security key on button container
          const buttonContainer = document.getElementById('ipospays-gpay-btn');
          console.log('üéØ Button container found:', !!buttonContainer);
          
          if (buttonContainer) {
            buttonContainer.setAttribute('data-security-key', DEJAVOO_AUTH_TOKEN);
            buttonContainer.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
            console.log('  - Set security_key on button container');
          }

          const transactionInfo = {
            countryCode: "US",
            currencyCode: "USD",
            totalPriceStatus: "FINAL",
            totalPrice: "155.00",
            totalPriceLabel: "Total",
          };

          const merchantId = "N/A"; // Use "N/A" for TEST mode
          const Mode = ENVIRONMENT === 'sandbox' ? "TEST" : "PRODUCTION";

          const buttonStyles = {
            buttonColor: "default",
            buttonType: "buy",
            buttonRadius: 4,
            buttonLocale: "en",
            buttonHeight: "48px",
            buttonWidth: "100%",
          };

          const goolePayFelids = {
            requestBillingAddress: true,
            requestPayerEmail: true,
            requestPayerPhone: false,
            requestShipping: false,
          };

          console.log('üöÄ Calling initializeGooglePay...');
          console.log('   Function exists:', typeof window.initializeGooglePay);
          console.log('   Function toString:', window.initializeGooglePay.toString().substring(0, 500));
          console.log('   transactionInfo:', transactionInfo);
          console.log('   merchantId:', merchantId);
          console.log('   Mode:', Mode);
          
          // Wrap in try-catch to capture SDK errors
          try {
            // Initialize Google Pay - function provided by gpay-ftd.js
            window.initializeGooglePay(transactionInfo, merchantId, Mode, buttonStyles, goolePayFelids);
            googlePayInitialized = true;
            console.log('‚úÖ Google Pay initialized');
          } catch (sdkError) {
            console.error('üí• SDK threw error:', sdkError);
            console.error('   Error name:', sdkError.name);
            console.error('   Error message:', sdkError.message);
            console.error('   Error stack:', sdkError.stack);
            throw sdkError;
          }
        } catch (error) {
          console.error('‚ùå Google Pay initialization error:', error);
          console.error('   Error stack:', error.stack);
        }
      }

      // Callback for Google Pay - called by Google Pay SDK
      function getPaymentInfo(paymentData) {
        console.log("üì± Google Pay Payment Data received");
        googlePayData = paymentData;
        selectedPaymentMethod = 'googlepay';
        
        // Auto-advance to review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        document.getElementById('reviewPayment').textContent = 'Google Pay';
        document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        
        setStep(3);
      }

      // Load customers
      async function loadCustomers() {
        try {
          const response = await fetch('/.netlify/functions/get-customers');
          if (!response.ok) throw new Error('Failed to load customers');
          
          const customers = await response.json();
          const select = document.getElementById('customerSelect');
          
          customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.customer_id;
            option.textContent = customer.customer_name;
            option.dataset.customer = JSON.stringify(customer);
            select.appendChild(option);
          });

          console.log('‚úÖ Loaded customers');
        } catch (error) {
          console.error('‚ùå Failed to load customers:', error);
          showAlert('customerAlerts', 'error', 'Unable to load customer list');
        }
      }

      // Handle customer selection
      function handleCustomerChange() {
        const select = document.getElementById('customerSelect');
        const continueBtn = document.getElementById('continueToPayment');
        const infoBox = document.getElementById('customerInfoBox');
        const infoDiv = document.getElementById('customerInfo');

        if (!select.value) {
          continueBtn.disabled = true;
          infoBox.style.display = 'none';
          selectedCustomer = null;
          return;
        }

        continueBtn.disabled = false;

        if (select.value === 'guest') {
          selectedCustomer = { customer_id: null, customer_name: 'Guest' };
          infoBox.style.display = 'none';
        } else {
          const option = select.options[select.selectedIndex];
          selectedCustomer = JSON.parse(option.dataset.customer);
          
          infoDiv.innerHTML = `
            <strong>${selectedCustomer.customer_name}</strong><br>
            ${selectedCustomer.email}<br>
            ${selectedCustomer.billing_street}<br>
            ${selectedCustomer.billing_city}, ${selectedCustomer.billing_state} ${selectedCustomer.billing_zip}
          `;
          infoBox.style.display = 'block';
        }
      }

      // Continue to payment
      async function continueToPayment() {
        if (!selectedCustomer) return;

        setStep(2);
        
        // Setup Google Pay when entering payment step
        setupGooglePay();

        if (selectedCustomer.customer_id) {
          // Load saved cards and pre-fill billing
          await loadSavedCards(selectedCustomer.customer_id);
          document.getElementById('billingName').value = selectedCustomer.customer_name;
          document.getElementById('billingAddress').value = selectedCustomer.billing_street;
          document.getElementById('billingCity').value = selectedCustomer.billing_city;
          document.getElementById('billingState').value = selectedCustomer.billing_state;
          document.getElementById('billingZip').value = selectedCustomer.billing_zip;
          document.getElementById('saveCardOption').style.display = 'block';
        } else {
          // Guest - clear form
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
          document.getElementById('saveCardOption').style.display = 'none';
        }
      }

      // Load saved cards
      async function loadSavedCards(customerId) {
        try {
          console.log('üì° Loading saved cards for customer:', customerId);
          const response = await fetch(`/.netlify/functions/get-payment-tokens?customer_id=${customerId}`);
          
          console.log('Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error('No saved cards');
          }
          
          savedCards = await response.json();
          console.log('‚úÖ Loaded saved cards:', savedCards);
          
          if (savedCards.length > 0) {
            displaySavedCards();
          } else {
            console.log('No cards in array, showing new card form');
            document.getElementById('savedCardsSection').style.display = 'none';
            document.getElementById('newCardForm').style.display = 'block';
          }
        } catch (error) {
          console.error('‚ùå Failed to load saved cards:', error);
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
        }
      }

      // Display saved cards
      function displaySavedCards() {
        const section = document.getElementById('savedCardsSection');
        const list = document.getElementById('savedCardsList');
        list.innerHTML = '';

        savedCards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card-option';
          div.innerHTML = `
            <input type="radio" name="payment-method" value="${card.token_id}" id="card-${card.token_id}">
            <div>
              <strong>${card.card_type || 'Card'} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_four}</strong><br>
              <small style="color: #999">Expires ${card.expiry_month}/${card.expiry_year}</small>
            </div>
          `;
          div.onclick = function() { selectSavedCard(card.token_id, this); };
          list.appendChild(div);
        });

        // Add new card option
        const newDiv = document.createElement('div');
        newDiv.className = 'card-option';
        newDiv.innerHTML = `
          <input type="radio" name="payment-method" value="new" id="card-new">
          <div><strong>‚ûï Use a different card</strong></div>
        `;
        newDiv.onclick = function() { selectNewCard(this); };
        list.appendChild(newDiv);

        section.style.display = 'block';
        selectSavedCard(savedCards[0].token_id);
      }

      // Select saved card
      function selectSavedCard(tokenId, clickedElement) {
        selectedPaymentMethod = tokenId;
        document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
        
        if (clickedElement) {
          clickedElement.classList.add('selected');
        } else {
          const cardElement = document.getElementById(`card-${tokenId}`)?.closest('.card-option');
          if (cardElement) cardElement.classList.add('selected');
        }
        
        document.getElementById(`card-${tokenId}`).checked = true;
        document.getElementById('savedCardCvv').style.display = 'block';
        document.getElementById('newCardForm').style.display = 'none';
        console.log('üí≥ Selected saved card:', tokenId);
      }

      // Select new card
      function selectNewCard(clickedElement) {
        selectedPaymentMethod = 'new';
        document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
        
        if (clickedElement) {
          clickedElement.classList.add('selected');
        } else {
          const newCardElement = document.getElementById('card-new')?.closest('.card-option');
          if (newCardElement) newCardElement.classList.add('selected');
        }
        
        document.getElementById('card-new').checked = true;
        document.getElementById('savedCardCvv').style.display = 'none';
        document.getElementById('newCardForm').style.display = 'block';
        document.getElementById('newCardHeading').textContent = 'NEW CARD DETAILS';
        console.log('‚ûï Selected new card entry');
      }

      // Continue to review
      function continueToReview() {
        // Validate
        if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value.trim();
          const ccexpiry = document.getElementById('ccexpiry').value.trim();
          const cccvv = document.getElementById('cccvv').value.trim();
          const billingName = document.getElementById('billingName').value.trim();
          const billingAddress = document.getElementById('billingAddress').value.trim();
          const billingCity = document.getElementById('billingCity').value.trim();
          const billingState = document.getElementById('billingState').value.trim();
          const billingZip = document.getElementById('billingZip').value.trim();

          if (!ccnumber || ccnumber.replace(/\s/g, '').length < 13) {
            alert('Please enter a valid card number');
            document.getElementById('ccnumber').focus();
            return;
          }
          if (!ccexpiry || ccexpiry.length < 4) {
            alert('Please enter expiry date (MM/YY)');
            document.getElementById('ccexpiry').focus();
            return;
          }
          if (!cccvv || cccvv.length < 3) {
            alert('Please enter CVV (3-4 digits)');
            document.getElementById('cccvv').focus();
            return;
          }
          if (!billingName) {
            alert('Please enter cardholder name');
            document.getElementById('billingName').focus();
            return;
          }
          if (!billingAddress) {
            alert('Please enter billing address');
            document.getElementById('billingAddress').focus();
            return;
          }
          if (!billingCity) {
            alert('Please enter city');
            document.getElementById('billingCity').focus();
            return;
          }
          if (!billingState || billingState.length !== 2) {
            alert('Please enter 2-letter state code');
            document.getElementById('billingState').focus();
            return;
          }
          if (!billingZip) {
            alert('Please enter ZIP code');
            document.getElementById('billingZip').focus();
            return;
          }
        } else if (selectedPaymentMethod !== 'googlepay') {
          const savedCvv = document.getElementById('savedCvv').value.trim();
          if (!savedCvv || savedCvv.length < 3) {
            alert('Please enter CVV for saved card');
            document.getElementById('savedCvv').focus();
            return;
          }
        }

        // Update review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        
        if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const last4 = ccnumber.slice(-4);
          document.getElementById('reviewPayment').textContent = `New card ending in ${last4}`;
        } else if (selectedPaymentMethod === 'googlepay') {
          document.getElementById('reviewPayment').textContent = 'Google Pay';
        } else {
          const card = savedCards.find(c => c.token_id === selectedPaymentMethod);
          document.getElementById('reviewPayment').textContent = `${card.card_type} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_four}`;
        }

        if (selectedPaymentMethod !== 'googlepay') {
          const name = document.getElementById('billingName').value;
          const address = document.getElementById('billingAddress').value;
          const city = document.getElementById('billingCity').value;
          const state = document.getElementById('billingState').value;
          const zip = document.getElementById('billingZip').value;
          
          document.getElementById('reviewBilling').innerHTML = `${name}<br>${address}<br>${city}, ${state} ${zip}`;
        } else {
          document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        }

        setStep(3);
      }

      // Place order
      async function placeOrder() {
        if (!configLoaded) {
          showAlert('reviewAlerts', 'error', 'Payment system not ready');
          return;
        }

        document.getElementById('processingOverlay').classList.add('active');
        document.getElementById('processingMessage').textContent = 'Processing payment...';

        try {
          let saleResponse;

          if (selectedPaymentMethod === 'googlepay') {
            // Process Google Pay transaction
            saleResponse = await processGooglePaySale();
          } else {
            // Generate or use token for card payment
            if (selectedPaymentMethod === 'new') {
              if (typeof postData !== 'function') {
                throw new Error('Payment tokenization not available');
              }
              document.getElementById('processingMessage').textContent = 'Creating payment token...';
              const tokenResponse = await postData();
              if (tokenResponse.statusCode !== '00') throw new Error('Token generation failed');
              paymentTokenId = tokenResponse.payment_token_id;
            } else {
              const card = savedCards.find(c => c.token_id === selectedPaymentMethod);
              reusableToken = card.reusable_token;
            }

            // Process card transaction
            document.getElementById('processingMessage').textContent = 'Processing payment...';
            saleResponse = await processSale();
          }

          document.getElementById('processingOverlay').classList.remove('active');

          // Check response
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData) {
            if (saleResponse.errors && saleResponse.errors.length > 0) {
              const error = saleResponse.errors[0];
              showAlert('reviewAlerts', 'error', `API Error: ${error.message}`);
            } else {
              showAlert('reviewAlerts', 'error', 'Unknown error occurred');
            }
            return;
          }

          if (transactionData.responseCode === '200') {
            // Save token if needed
            if (selectedPaymentMethod === 'new' && selectedCustomer.customer_id && document.getElementById('saveCardCheckbox').checked) {
              await savePaymentToken(saleResponse);
            }
            
            // Save transaction
            await saveTransaction(saleResponse);
            
            showSuccessPage(saleResponse);
          } else {
            const errorMsg = transactionData.errResponseMessage || transactionData.responseMessage || 'Transaction failed';
            showAlert('reviewAlerts', 'error', `‚ùå ${errorMsg}`);
          }
        } catch (error) {
          console.error('Error:', error);
          document.getElementById('processingOverlay').classList.remove('active');
          showAlert('reviewAlerts', 'error', error.message);
        }
      }

      // Process Google Pay sale
      async function processGooglePaySale() {
        const requestBody = {
          merchantAuthentication: {
            merchantId: MERCHANT_ID,
            transactionReferenceId: 'GPAY' + Date.now(),
          },
          transactionRequest: {
            transactionType: 1,
            amount: 15500,
            sourceType: "GOOGLE-FTD"
          },
          preferences: {
            eReceipt: true,
            customerName: selectedCustomer.customer_name,
            customerEmail: selectedCustomer.email || 'guest@example.com',
            customerMobile: selectedCustomer.customer_phone || '',
            requestPaymentToken: false
          },
          googlePayData: googlePayData
        };

        console.log('iPOS Transact Request (Google Pay):', requestBody);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            token: API_AUTH_TOKEN,
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) throw new Error('API request failed');
        return await response.json();
      }

      // Process sale
      async function processSale() {
        const billingZip = document.getElementById('billingZip').value;
        const billingAddress = document.getElementById('billingAddress').value;
        const streetNo = billingAddress.split(' ')[0];

        const requestBody = {
          merchantAuthentication: {
            merchantId: MERCHANT_ID,
            transactionReferenceId: 'TEST' + Date.now(),
          },
          transactionRequest: {
            transactionType: 1,
            amount: 15500,
            applySteamSettingTipFeeTax: false,
          },
          preferences: {
            eReceipt: true,
            customerName: document.getElementById('billingName').value,
            customerEmail: selectedCustomer.email || 'guest@example.com',
            customerMobile: '+14048811898',
          },
          Avs: {
            StreetNo: streetNo,
            Zip: billingZip,
          },
        };

        // Use paymentTokenId for new cards, cardToken for saved cards
        if (selectedPaymentMethod === 'new') {
          requestBody.transactionRequest.paymentTokenId = paymentTokenId;
          requestBody.preferences.requestCardToken = true;
        } else {
          requestBody.transactionRequest.cardToken = reusableToken;
          requestBody.transactionRequest.cvv = document.getElementById('savedCvv').value;
        }

        console.log('iPOS Transact Request:', requestBody);

        const response = await fetch(API_BASE_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            token: API_AUTH_TOKEN,
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) throw new Error('API request failed');
        return await response.json();
      }

      // Save token
      async function savePaymentToken(saleResponse) {
        try {
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData.chdToken) {
            console.warn('No chdToken in response - cannot save card');
            return;
          }

          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const lastFour = ccnumber.slice(-4);
          const cardType = getCardType(ccnumber);
          const expiry = document.getElementById('ccexpiry').value.split('/');

          const response = await fetch('/.netlify/functions/save-payment-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customer_id: selectedCustomer.customer_id,
              payment_token_id: paymentTokenId,
              reusable_token: transactionData.chdToken,
              card_last_four: lastFour,
              card_type: cardType,
              expiry_month: expiry[0],
              expiry_year: '20' + expiry[1]
            })
          });

          if (response.ok) {
            console.log('‚úÖ Card token saved:', transactionData.chdToken);
          } else if (response.status === 409) {
            console.log('‚ÑπÔ∏è Card token already exists (duplicate)');
          } else {
            console.warn('‚ö†Ô∏è Failed to save card token:', response.status);
          }
        } catch (error) {
          console.error('‚ùå Error saving token:', error);
        }
      }

      // Save transaction
      async function saveTransaction(saleResponse) {
        try {
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData) {
            console.warn('No transaction data to save');
            return;
          }

          await fetch('/.netlify/functions/save-transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              customer_id: selectedCustomer.customer_id,
              dejavoo_reference_id: transactionData.transactionId,
              amount: 155.00,
              status: 'approved',
              response_code: transactionData.responseCode,
              response_message: transactionData.responseMessage || transactionData.errResponseMessage
            })
          });
          
          console.log('‚úÖ Transaction saved to database');
        } catch (error) {
          console.error('Failed to save transaction:', error);
        }
      }

      // Helper functions
      function getCardType(cardNumber) {
        if (/^4/.test(cardNumber)) return 'Visa';
        if (/^5[1-5]/.test(cardNumber)) return 'Mastercard';
        if (/^3[47]/.test(cardNumber)) return 'American Express';
        if (/^6(?:011|5)/.test(cardNumber)) return 'Discover';
        return 'Card';
      }

      function showAlert(containerId, type, message) {
        const container = document.getElementById(containerId);
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      }

      function setStep(step) {
        for (let i = 1; i <= 3; i++) {
          const indicator = document.getElementById(`step${i}-indicator`);
          indicator.classList.toggle('active', i <= step);
        }

        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        window.scrollTo(0, 0);
      }

      function editStep(step) {
        setStep(step);
      }

      function showSuccessPage(response) {
        const data = response.iposTransactResponse || response.iposhpresponse;
        const paymentMethod = selectedPaymentMethod === 'googlepay' ? 'Google Pay' : 'Card';
        showAlert('reviewAlerts', 'success', `
          <h3 style="margin-bottom: 15px">‚úÖ Payment Successful!</h3>
          <p><strong>Payment Method:</strong> ${paymentMethod}</p>
          <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
          <p><strong>Amount:</strong> $${(data.totalAmount / 100).toFixed(2)}</p>
          <p><strong>Approval Code:</strong> ${data.responseApprovalCode}</p>
          ${data.chdToken && selectedPaymentMethod !== 'googlepay' ? '<p style="margin-top: 10px; color: #856404;">üí≥ Card saved for future use</p>' : ''}
        `);
        document.querySelector('#step3 .btn').style.display = 'none';
      }

      // Input formatting
      document.getElementById('ccnumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
      });

      document.getElementById('ccexpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
        e.target.value = value;
      });

      document.getElementById('cccvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      document.getElementById('savedCvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Initialize
      window.addEventListener('DOMContentLoaded', loadConfig);
    </script>
  </body>
</html>