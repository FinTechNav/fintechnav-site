<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>Dejavoo Checkout</title>
    <link rel="stylesheet" href="checkout-styles.css" />
    <!-- Dejavoo Freedom to Design Library - Dynamically loaded -->
    <script id="ftd" defer></script>
    <!-- Google Pay SDK - Script tag must exist in DOM before SDK loads -->
    <script id="gpayftd"></script>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Checkout</h1>
      </div>

      <div class="checkout-wrapper">
        <!-- Main Content -->
        <div class="checkout-main">
          <!-- Loading indicator -->
          <div id="loadingConfig" class="alert alert-info" style="display: none">
            <span>‚è≥</span> Loading payment configuration...
          </div>

          <!-- Progress Steps -->
          <div class="progress-steps">
            <div class="step active" id="step1-indicator">
              <span class="step-number">1</span>
              <span>Customer</span>
            </div>
            <div class="step" id="step2-indicator">
              <span class="step-number">2</span>
              <span>Payment</span>
            </div>
            <div class="step" id="step3-indicator">
              <span class="step-number">3</span>
              <span>Review</span>
            </div>
          </div>

          <!-- Step 1: Customer Selection -->
          <div class="step-content active" id="step1">
            <h2 class="section-title">Select Customer</h2>

            <div id="customerAlerts"></div>

            <div class="form-group">
              <label>Customer <span class="required">*</span></label>
              <div style="position: relative;">
                <input 
                  type="text" 
                  id="customerSearch" 
                  placeholder="Search customers by name, email, or phone..."
                  autocomplete="off"
                  style="width: 100%;"
                />
                <div id="customerSearchResults" style="
                  position: absolute;
                  top: 100%;
                  left: 0;
                  right: 0;
                  background: white;
                  border: 1px solid #ddd;
                  border-top: none;
                  border-radius: 0 0 8px 8px;
                  max-height: 300px;
                  overflow-y: auto;
                  display: none;
                  z-index: 1000;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                "></div>
              </div>
            </div>

            <div id="customerInfoBox" class="customer-info-box" style="display: none">
              <strong>Customer Details:</strong>
              <div id="customerInfo" style="margin-top: 10px"></div>
            </div>

            <button type="button" class="btn" id="continueToPayment" onclick="continueToPayment()" disabled>
              Continue to Payment
            </button>
          </div>

          <!-- Step 2: Payment -->
          <div class="step-content" id="step2">
            <h2 class="section-title">Payment</h2>

            <div class="security-notice">
              <span>üîí</span>
              All transactions are secure and encrypted
            </div>

            <div id="paymentAlerts"></div>

            <!-- Google Pay Button -->
            <div id="ipospays-gpay-btn" data-security-key=""></div>

            <div class="payment-divider">
              <span>Or pay with card</span>
            </div>

            <!-- Saved Cards Section -->
            <div id="savedCardsSection" style="display: none">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666">SAVED PAYMENT METHODS</h3>
              <div id="savedCardsList" class="saved-cards"></div>
            </div>

            <!-- CVV for saved card -->
            <div id="savedCardCvv" style="display: none">
              <div class="form-group">
                <label>CVV <span class="required">*</span></label>
                <input type="text" id="savedCvv" placeholder="123" maxlength="4" />
                <div class="help-text">Security code required for saved cards</div>
              </div>
            </div>

            <!-- New Card Form -->
            <div id="newCardForm">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666" id="newCardHeading">CARD DETAILS</h3>
              
              <form id="paymentForm">
                <div class="form-group">
                  <label>Card Number <span class="required">*</span></label>
                  <input
                    type="text"
                    id="ccnumber"
                    placeholder="1234 1234 1234 1234"
                    maxlength="19"
                  />
                </div>

                <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                  <div class="form-group">
                    <label>Expiry Month <span class="required">*</span></label>
                    <input type="text" id="ccexpiry" placeholder="MM/YY" maxlength="5" />
                  </div>

                  <div class="form-group">
                    <label>CVV <span class="required">*</span></label>
                    <input type="text" id="cccvv" placeholder="123" maxlength="4" />
                    <div class="help-text">3-4 digits on back</div>
                  </div>
                </div>

                <!-- Save card option (for returning customers) -->
                <div id="saveCardOption" style="display: none; margin-bottom: 30px;">
                  <label class="checkbox-label">
                    <input type="checkbox" id="saveCardCheckbox" checked />
                    <span>Save this card for future purchases</span>
                  </label>
                </div>

                <h3 class="section-title" style="margin-top: 30px; font-size: 1rem">Billing</h3>

                <div class="form-group">
                  <label>Name <span class="required">*</span></label>
                  <input type="text" id="billingName" />
                </div>

                <div class="form-group">
                  <label>Address <span class="required">*</span></label>
                  <input type="text" id="billingAddress" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>City <span class="required">*</span></label>
                    <input type="text" id="billingCity" />
                  </div>

                  <div class="form-group">
                    <label>State <span class="required">*</span></label>
                    <input type="text" id="billingState" maxlength="2" />
                  </div>

                  <div class="form-group">
                    <label>Zip <span class="required">*</span></label>
                    <input type="text" id="billingZip" />
                  </div>
                </div>
              </form>
            </div>

            <button type="button" class="btn" style="margin-top: 20px" onclick="continueToReview()">
              Continue to Review
            </button>
          </div>

          <!-- Step 3: Review -->
          <div class="step-content" id="step3">
            <h2 class="section-title">Review</h2>

            <div id="reviewAlerts"></div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Customer</h3>
                <button class="edit-link" onclick="editStep(1)">Edit</button>
              </div>
              <div class="review-content" id="reviewCustomer"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Payment</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewPayment"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Billing Address</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewBilling"></div>
            </div>

            <button type="button" class="btn" onclick="placeOrder()">Place Order</button>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="checkout-sidebar">
          <div class="order-item">
            <div class="item-image">
              <img
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23f0f0f0' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='10'%3EWine%3C/text%3E%3C/svg%3E"
                alt="Product"
                style="width: 100%; height: 100%"
              />
            </div>
            <div class="item-details">
              <div class="item-title">Humboldt Single Vineyard Pinot Pack</div>
              <div class="item-subtitle">Three-Pack</div>
              <div class="item-price">
                <span>$155.00</span>
                <span class="item-quantity">√ó 1</span>
                <span style="margin-left: auto">$155.00</span>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <div class="summary-row">
              <span class="label">Subtotal (3)</span>
              <span>$155.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Shipping (UPS Ground)</span>
              <span><s style="color: #999">$31.93</s> $0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Tax</span>
              <span>$0.00</span>
            </div>
            <div class="summary-row total">
              <span class="label">Total</span>
              <span>USD $155.00</span>
            </div>
          </div>

          <div class="savings">
            <span>üí∞</span>
            <span>Shipping Included on Humboldt Three-Packs - $31.93 SAVED</span>
          </div>

          <div class="help-contact">
            Need help? Call us at<br />
            <a href="tel:7078201621">(707) 820-1621</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
      <div class="processing-content">
        <div class="spinner"></div>
        <h3 style="margin-bottom: 10px; color: #333">Processing Payment...</h3>
        <p style="color: #666; font-size: 0.9rem" id="processingMessage">
          Please wait while we process your transaction
        </p>
      </div>
    </div>

    <script>
      // Configuration - SET YOUR WINERY ID HERE
      const WINERY_ID = '22222222-2222-2222-2222-222222222222'; // Jensen Family Winery
      
      let MERCHANT_ID = '';
      let API_AUTH_TOKEN = '';
      let DEJAVOO_AUTH_TOKEN = '';
      let ENVIRONMENT = 'sandbox';
      let API_BASE_URL = '';

      let currentStep = 1;
      let selectedCustomer = null;
      let savedCards = [];
      let selectedPaymentMethod = 'new'; // 'new', 'googlepay', or token_id
      let paymentTokenId = null;
      let reusableToken = null;
      let configLoaded = false;
      let googlePayInitialized = false;
      let googlePayData = null;
      let customers = [];

      // Load configuration
      async function loadConfig() {
        const loadingEl = document.getElementById('loadingConfig');
        loadingEl.style.display = 'block';

        try {
          console.log('üîÑ Loading configuration...');
          const response = await fetch(`/.netlify/functions/get-dejavoo-config?winery_id=${WINERY_ID}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const config = await response.json();
          
          DEJAVOO_AUTH_TOKEN = config.dejavooAuthToken;
          MERCHANT_ID = config.merchantId;
          API_AUTH_TOKEN = config.apiAuthToken;
          ENVIRONMENT = config.environment;

          const isSandbox = ENVIRONMENT === 'sandbox';
          API_BASE_URL = isSandbox
            ? 'https://payment.ipospays.tech/api/v2/iposTransact'
            : 'https://payment.ipospays.com/api/v2/iposTransact';

          const ftdScript = document.getElementById('ftd');
          const scriptUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/freedomtodesign.js'
            : 'https://payment.ipospays.com/ftd/v1/freedomtodesign.js';

          ftdScript.setAttribute('src', scriptUrl);
          ftdScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);

          await new Promise((resolve, reject) => {
            ftdScript.onload = resolve;
            ftdScript.onerror = reject;
          });

          // Configure Google Pay SDK using existing script tag
          const gpayScript = document.getElementById('gpayftd');
          const gpayUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/gpay-ftd.js'
            : 'https://payment.ipospays.com/ftd/v1/gpay-ftd.js';
          
          // Set security_key attribute FIRST
          gpayScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          // Then set src to load the script
          gpayScript.src = gpayUrl;
          
          gpayScript.onload = () => {
            console.log('‚úÖ Google Pay SDK loaded');
          };
          gpayScript.onerror = (error) => {
            console.warn('‚ö†Ô∏è Google Pay SDK failed to load:', error);
          };

          console.log('‚úÖ Configuration loaded');
          loadingEl.style.display = 'none';
          configLoaded = true;

          // Load customers
          await loadCustomers();
        } catch (error) {
          console.error('‚ùå Configuration error:', error);
          loadingEl.innerHTML = `<div class="alert alert-error">Configuration Error: ${error.message}</div>`;
        }
      }

      // Setup Google Pay
      function setupGooglePay() {
        if (!configLoaded || googlePayInitialized) return;

        // Wait a bit for SDK to load if not ready yet
        if (typeof window.initializeGooglePay !== 'function') {
          console.log('‚è≥ Waiting for Google Pay SDK...');
          setTimeout(setupGooglePay, 500);
          return;
        }

        try {
          // Set security key as global variable
          window.security_key = DEJAVOO_AUTH_TOKEN;
          
          // Force set security_key on script tag
          const gpayScriptTag = document.getElementById('gpayftd');
          if (gpayScriptTag) {
            gpayScriptTag.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          }
          
          // Set security key on button container
          const buttonContainer = document.getElementById('ipospays-gpay-btn');
          if (buttonContainer) {
            buttonContainer.setAttribute('data-security-key', DEJAVOO_AUTH_TOKEN);
            buttonContainer.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          }

          const transactionInfo = {
            countryCode: "US",
            currencyCode: "USD",
            totalPriceStatus: "FINAL",
            totalPrice: "155.00",
            totalPriceLabel: "Total",
          };

          const merchantId = "N/A";
          const Mode = ENVIRONMENT === 'sandbox' ? "TEST" : "PRODUCTION";

          const buttonStyles = {
            buttonColor: "default",
            buttonType: "buy",
            buttonRadius: 4,
            buttonLocale: "en",
            buttonHeight: "48px",
            buttonWidth: "100%",
          };

          const goolePayFelids = {
            requestBillingAddress: true,
            requestPayerEmail: true,
            requestPayerPhone: false,
            requestShipping: false,
          };

          window.initializeGooglePay(transactionInfo, merchantId, Mode, buttonStyles, goolePayFelids);
          googlePayInitialized = true;
          console.log('‚úÖ Google Pay initialized');
        } catch (error) {
          console.error('‚ùå Google Pay initialization error:', error);
        }
      }

      // Callback for Google Pay - called by Google Pay SDK
      function getPaymentInfo(paymentData) {
        console.log("üì± Google Pay Payment Data received");
        console.log("üì¶ Full paymentData object:", paymentData);
        console.log("üì¶ PaymentData type:", typeof paymentData);
        console.log("üì¶ PaymentData keys:", Object.keys(paymentData));
        
        googlePayData = paymentData;
        selectedPaymentMethod = 'googlepay';
        
        // Auto-advance to review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        document.getElementById('reviewPayment').textContent = 'Google Pay';
        document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        
        console.log("‚úÖ Moving to review step (step 3)");
        setStep(3);
      }

      // Load customers
      async function loadCustomers() {
        try {
          console.log('üîÑ Loading customers for winery_id:', WINERY_ID);
          const url = `/.netlify/functions/get-winery-customers?winery_id=${WINERY_ID}`;
          console.log('üì° Fetching from URL:', url);
          
          const response = await fetch(url);
          console.log('üì• Response status:', response.status);
          console.log('üì• Response ok:', response.ok);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Response error text:', errorText);
            throw new Error('Failed to load customers');
          }
          
          const data = await response.json();
          console.log('üì¶ Response data:', JSON.stringify(data, null, 2));
          console.log('üì¶ data.success:', data.success);
          console.log('üì¶ data.customers:', data.customers);
          
          if (!data.success) {
            console.error('‚ùå API returned success=false');
            throw new Error('Failed to load customers');
          }
          
          customers = data.customers;
          console.log('‚úÖ Loaded customers:', customers.length);
          console.log('üë• Customer list:', customers);
          
          // Setup customer search event listeners
          setupCustomerSearch();
        } catch (error) {
          console.error('‚ùå Failed to load customers:', error);
          console.error('‚ùå Error stack:', error.stack);
          showAlert('customerAlerts', 'error', 'Unable to load customer list');
        }
      }

      // Setup customer search
      function setupCustomerSearch() {
        const searchInput = document.getElementById('customerSearch');
        const resultsContainer = document.getElementById('customerSearchResults');
        
        // Show guest checkout option by default
        showGuestCheckoutOption();
        
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          
          if (!query) {
            showGuestCheckoutOption();
            return;
          }
          
          searchCustomers(query);
        });
        
        searchInput.addEventListener('focus', () => {
          const query = searchInput.value.trim();
          if (!query) {
            showGuestCheckoutOption();
          } else {
            searchCustomers(query);
          }
        });
        
        // Close results when clicking outside
        document.addEventListener('click', (e) => {
          if (!searchInput.contains(e.target) && !resultsContainer.contains(e.target)) {
            resultsContainer.style.display = 'none';
          }
        });
      }

      // Show guest checkout option
      function showGuestCheckoutOption() {
        const resultsContainer = document.getElementById('customerSearchResults');
        
        resultsContainer.innerHTML = `
          <div class="customer-search-item" data-customer-id="guest" style="padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: background 0.2s;">
            <div style="font-weight: 600; color: #333; font-size: 14px;">Guest Checkout</div>
            <div style="font-size: 12px; color: #666; margin-top: 2px;">Continue without customer info</div>
          </div>
        `;
        
        resultsContainer.style.display = 'block';
        
        const item = resultsContainer.querySelector('.customer-search-item');
        item.addEventListener('mouseenter', function() {
          this.style.background = 'rgba(0, 0, 0, 0.03)';
        });
        item.addEventListener('mouseleave', function() {
          this.style.background = 'transparent';
        });
        item.addEventListener('click', function() {
          selectGuest();
        });
      }

      // Search customers
      function searchCustomers(query) {
        const resultsContainer = document.getElementById('customerSearchResults');
        const searchLower = query.toLowerCase();
        const searchNormalized = query.replace(/[\s\-\.()]/g, '').toLowerCase();
        
        const matches = customers
          .map(c => {
            const name = (c.name || '').toLowerCase();
            const email = (c.email || '').toLowerCase();
            const phone = (c.phone || '').toLowerCase();
            const phoneNormalized = phone.replace(/[\s\-\.()]/g, '');
            
            let score = 0;
            if (name.includes(searchLower)) score += 10;
            if (email.includes(searchLower)) score += 8;
            if (phone.includes(searchLower)) score += 6;
            if (phoneNormalized.includes(searchNormalized)) score += 6;
            
            return score > 0 ? { customer: c, score } : null;
          })
          .filter(Boolean)
          .sort((a, b) => b.score - a.score)
          .slice(0, 10);
        
        if (matches.length === 0) {
          resultsContainer.innerHTML = `
            <div style="padding: 12px; color: #666; font-size: 14px;">No customers found</div>
            <div class="customer-search-item" data-customer-id="guest" style="padding: 12px; cursor: pointer; border-top: 1px solid rgba(0, 0, 0, 0.05); transition: background 0.2s;">
              <div style="font-weight: 600; color: #333; font-size: 14px;">Guest Checkout</div>
              <div style="font-size: 12px; color: #666; margin-top: 2px;">Continue without customer info</div>
            </div>
          `;
          
          const guestItem = resultsContainer.querySelector('.customer-search-item');
          guestItem.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0, 0, 0, 0.03)';
          });
          guestItem.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
          });
          guestItem.addEventListener('click', function() {
            selectGuest();
          });
        } else {
          resultsContainer.innerHTML = matches.map(({ customer }) => {
            const displayName = customer.name || customer.email;
            const highlightedName = highlightText(displayName, query);
            const highlightedEmail = customer.email ? highlightText(customer.email, query) : '';
            const highlightedPhone = customer.phone ? highlightText(customer.phone, query) : '';
            
            return `
              <div class="customer-search-item" data-customer-id="${customer.id}" style="padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(0, 0, 0, 0.05); transition: background 0.2s;">
                <div style="font-weight: 600; color: #333; font-size: 14px;">${highlightedName}</div>
                ${customer.email ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${highlightedEmail}</div>` : ''}
                ${customer.phone ? `<div style="font-size: 12px; color: #666; margin-top: 2px;">${highlightedPhone}</div>` : ''}
              </div>
            `;
          }).join('');
        }
        
        resultsContainer.style.display = 'block';
        
        const items = resultsContainer.querySelectorAll('.customer-search-item');
        items.forEach(item => {
          item.addEventListener('mouseenter', function() {
            this.style.background = 'rgba(0, 0, 0, 0.03)';
          });
          item.addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
          });
          item.addEventListener('click', function() {
            const customerId = this.dataset.customerId;
            if (customerId === 'guest') {
              selectGuest();
            } else {
              selectCustomer(customerId);
            }
          });
        });
      }

      // Highlight text
      function highlightText(text, query) {
        if (!text || !query) return text;
        
        const searchLower = query.toLowerCase();
        const textLower = text.toLowerCase();
        const normalized = query.replace(/[\s\-\.()]/g, '');
        const textNormalized = text.replace(/[\s\-\.()]/g, '');
        
        // Try exact match first
        const index = textLower.indexOf(searchLower);
        if (index !== -1) {
          const before = text.substring(0, index);
          const match = text.substring(index, index + query.length);
          const after = text.substring(index + query.length);
          return `${before}<span style="background: rgba(243, 156, 18, 0.3); color: #f39c12; font-weight: 700;">${match}</span>${after}`;
        }
        
        // Try normalized match for phone numbers
        if (normalized.length > 0) {
          const normalizedIndex = textNormalized.toLowerCase().indexOf(normalized.toLowerCase());
          if (normalizedIndex !== -1) {
            let charCount = 0;
            let startIndex = -1;
            let endIndex = -1;
            
            for (let i = 0; i < text.length; i++) {
              const char = text[i];
              if (!/[\s\-\.]/.test(char)) {
                if (charCount === normalizedIndex) startIndex = i;
                if (charCount === normalizedIndex + normalized.length - 1) {
                  endIndex = i + 1;
                  break;
                }
                charCount++;
              }
            }
            
            if (startIndex !== -1 && endIndex !== -1) {
              const before = text.substring(0, startIndex);
              const match = text.substring(startIndex, endIndex);
              const after = text.substring(endIndex);
              return `${before}<span style="background: rgba(243, 156, 18, 0.3); color: #f39c12; font-weight: 700;">${match}</span>${after}`;
            }
          }
        }
        
        return text;
      }

      // Select customer
      function selectCustomer(customerId) {
        const customer = customers.find(c => c.id === customerId);
        if (!customer) return;
        
        const searchInput = document.getElementById('customerSearch');
        const resultsContainer = document.getElementById('customerSearchResults');
        const continueBtn = document.getElementById('continueToPayment');
        const infoBox = document.getElementById('customerInfoBox');
        const infoDiv = document.getElementById('customerInfo');
        
        searchInput.value = customer.name || customer.email;
        resultsContainer.style.display = 'none';
        continueBtn.disabled = false;
        
        selectedCustomer = {
          ...customer,
          customer_id: customer.id,
          customer_name: customer.name || customer.email,
        };
        
        infoDiv.innerHTML = `
          <strong>${selectedCustomer.customer_name}</strong><br>
          ${selectedCustomer.email || ''}<br>
        `;
        infoBox.style.display = 'block';
      }

      // Select guest
      function selectGuest() {
        const searchInput = document.getElementById('customerSearch');
        const resultsContainer = document.getElementById('customerSearchResults');
        const continueBtn = document.getElementById('continueToPayment');
        const infoBox = document.getElementById('customerInfoBox');
        
        searchInput.value = 'Guest Checkout';
        resultsContainer.style.display = 'none';
        continueBtn.disabled = false;
        infoBox.style.display = 'none';
        
        selectedCustomer = { 
          id: null, 
          customer_id: null, 
          name: 'Guest',
          customer_name: 'Guest'
        };
      }

      // Continue to payment
      async function continueToPayment() {
        if (!selectedCustomer) return;

        setStep(2);
        
        // Setup Google Pay when entering payment step
        setupGooglePay();

        if (selectedCustomer.id || selectedCustomer.customer_id) {
          // Load saved cards and pre-fill billing
          await loadSavedCards(selectedCustomer.id || selectedCustomer.customer_id);
          document.getElementById('billingName').value = selectedCustomer.customer_name || '';
          document.getElementById('saveCardOption').style.display = 'block';
        } else {
          // Guest - clear form
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
          document.getElementById('saveCardOption').style.display = 'none';
        }
      }

      // Load saved cards
      async function loadSavedCards(customerId) {
        try {
          console.log('üì° Loading saved cards for customer:', customerId);
          const response = await fetch(`/.netlify/functions/get-payment-tokens?customer_id=${customerId}&winery_id=${WINERY_ID}`);
          
          console.log('Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error('No saved cards');
          }
          
          savedCards = await response.json();
          console.log('‚úÖ Loaded saved cards:', savedCards);
          
          if (savedCards.length > 0) {
            displaySavedCards();
          } else {
            console.log('No cards in array, showing new card form');
            document.getElementById('savedCardsSection').style.display = 'none';
            document.getElementById('newCardForm').style.display = 'block';
          }
        } catch (error) {
          console.error('‚ùå Failed to load saved cards:', error);
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
        }
      }

      // Display saved cards
      function displaySavedCards() {
        const savedCardsSection = document.getElementById('savedCardsSection');
        const savedCardsList = document.getElementById('savedCardsList');
        const newCardForm = document.getElementById('newCardForm');
        
        savedCardsList.innerHTML = savedCards.map(card => `
          <div class="saved-card ${selectedPaymentMethod === card.id ? 'selected' : ''}" 
               onclick="selectSavedCard('${card.id}')">
            <div class="card-type">${card.card_type}</div>
            <div class="card-number">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.last_4}</div>
            <div class="card-expiry">Exp: ${card.expiry_month}/${card.expiry_year}</div>
          </div>
        `).join('');
        
        // Add "Use a different card" button
        savedCardsList.innerHTML += `
          <div class="saved-card" onclick="selectNewCard()" style="justify-content: center; font-weight: 600;">
            + Use a different card
          </div>
        `;
        
        savedCardsSection.style.display = 'block';
        document.getElementById('newCardHeading').textContent = 'OR USE NEW CARD';
        newCardForm.style.display = 'none';
      }

      // Select saved card
      function selectSavedCard(tokenId) {
        selectedPaymentMethod = tokenId;
        
        // Update visual selection
        document.querySelectorAll('.saved-card').forEach(card => {
          card.classList.remove('selected');
        });
        event.target.closest('.saved-card').classList.add('selected');
        
        // Show CVV input
        document.getElementById('savedCardCvv').style.display = 'block';
        document.getElementById('newCardForm').style.display = 'none';
      }

      // Select new card
      function selectNewCard() {
        selectedPaymentMethod = 'new';
        document.getElementById('savedCardCvv').style.display = 'none';
        document.getElementById('newCardForm').style.display = 'block';
        
        // Clear selection
        document.querySelectorAll('.saved-card').forEach(card => {
          card.classList.remove('selected');
        });
      }

      // Continue to review
      function continueToReview() {
        // Validate payment details
        if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value;
          const ccexpiry = document.getElementById('ccexpiry').value;
          const cccvv = document.getElementById('cccvv').value;
          const billingName = document.getElementById('billingName').value;
          const billingAddress = document.getElementById('billingAddress').value;
          const billingCity = document.getElementById('billingCity').value;
          const billingState = document.getElementById('billingState').value;
          const billingZip = document.getElementById('billingZip').value;

          if (!ccnumber || !ccexpiry || !cccvv || !billingName || !billingAddress || !billingCity || !billingState || !billingZip) {
            showAlert('paymentAlerts', 'error', 'Please fill in all required fields');
            return;
          }
        } else if (selectedPaymentMethod !== 'googlepay') {
          const savedCvv = document.getElementById('savedCvv').value;
          if (!savedCvv) {
            showAlert('paymentAlerts', 'error', 'Please enter CVV for saved card');
            return;
          }
        }

        // Populate review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        
        if (selectedPaymentMethod === 'googlepay') {
          document.getElementById('reviewPayment').textContent = 'Google Pay';
          document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        } else if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const lastFour = ccnumber.slice(-4);
          const cardType = getCardType(ccnumber);
          document.getElementById('reviewPayment').textContent = `${cardType} ending in ${lastFour}`;
          
          const billingName = document.getElementById('billingName').value;
          const billingAddress = document.getElementById('billingAddress').value;
          const billingCity = document.getElementById('billingCity').value;
          const billingState = document.getElementById('billingState').value;
          const billingZip = document.getElementById('billingZip').value;
          
          document.getElementById('reviewBilling').innerHTML = `
            ${billingName}<br>
            ${billingAddress}<br>
            ${billingCity}, ${billingState} ${billingZip}
          `;
        } else {
          const card = savedCards.find(c => c.id === selectedPaymentMethod);
          document.getElementById('reviewPayment').textContent = `${card.card_type} ending in ${card.last_4}`;
          document.getElementById('reviewBilling').innerHTML = 'Billing address on file';
        }

        setStep(3);
      }

      // Place order
      async function placeOrder() {
        const overlay = document.getElementById('processingOverlay');
        overlay.style.display = 'flex';

        try {
          if (selectedPaymentMethod === 'googlepay') {
            await processGooglePayPayment();
          } else if (selectedPaymentMethod === 'new') {
            await processNewCardPayment();
          } else {
            await processSavedCardPayment();
          }
        } catch (error) {
          console.error('Payment error:', error);
          overlay.style.display = 'none';
          showAlert('reviewAlerts', 'error', `Payment failed: ${error.message}`);
        }
      }

      // Process Google Pay payment
      async function processGooglePayPayment() {
        console.log('üí≥ Processing Google Pay payment...');
        
        try {
          if (!googlePayData) {
            throw new Error('Google Pay data not available');
          }

          console.log('üì¶ Sending Google Pay data to Dejavoo API...');

          const paymentToken = googlePayData.paymentMethodData?.tokenizationData?.token;
          const parsedToken = typeof paymentToken === 'string' ? JSON.parse(paymentToken) : paymentToken;
          
          const billingAddress = googlePayData.paymentMethodData?.info?.billingAddress || {};
          
          const payload = {
            registerKey: DEJAVOO_AUTH_TOKEN,
            amount: 15500,
            invoiceNumber: `WEB${Date.now()}`,
            paymentType: 'GOOGLEPAY',
            billingEmail: googlePayData.email || selectedCustomer.email || '',
            billingName: billingAddress.name || selectedCustomer.customer_name || '',
            billingAddress1: billingAddress.address1 || '',
            billingAddress2: billingAddress.address2 || '',
            billingCity: billingAddress.locality || '',
            billingState: billingAddress.administrativeArea || '',
            billingZip: billingAddress.postalCode || '',
            billingCountryCode: billingAddress.countryCode || 'US',
            cvdIndicator: 'PROVIDED',
            walletType: 'GOOGLEPAY',
            protocolVersion: parsedToken.protocolVersion,
            signature: parsedToken.signature,
            signedMessage: parsedToken.signedMessage,
          };

          console.log('üì§ Google Pay payload:', JSON.stringify(payload, null, 2));

          const response = await fetch(API_BASE_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': API_AUTH_TOKEN,
            },
            body: JSON.stringify(payload),
          });

          const result = await response.json();
          console.log('üì• Google Pay API response:', result);

          if (result.iposTransactResponse?.responseCode === 'A01' || 
              result.iposhpresponse?.responseCode === 'A01') {
            console.log('‚úÖ Google Pay payment approved');
            await saveTransaction(result);
            showSuccessPage(result);
          } else {
            const declineInfo = getDeclineInfo(result.iposTransactResponse || result.iposhpresponse);
            console.error('‚ùå Google Pay payment declined:', declineInfo);
            showDeclineModal(declineInfo);
          }
        } catch (error) {
          console.error('‚ùå Google Pay payment error:', error);
          throw error;
        } finally {
          document.getElementById('processingOverlay').style.display = 'none';
        }
      }

      // Process new card payment
      async function processNewCardPayment() {
        console.log('üí≥ Processing new card payment...');
        
        const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
        const ccexpiry = document.getElementById('ccexpiry').value.replace(/\D/g, '');
        const cccvv = document.getElementById('cccvv').value;
        const billingName = document.getElementById('billingName').value;
        const billingAddress = document.getElementById('billingAddress').value;
        const billingCity = document.getElementById('billingCity').value;
        const billingState = document.getElementById('billingState').value;
        const billingZip = document.getElementById('billingZip').value;
        
        const expiryMonth = ccexpiry.substring(0, 2);
        const expiryYear = ccexpiry.substring(2, 4);

        try {
          // Step 1: Tokenize the card
          console.log('üîê Tokenizing card...');
          const tokenizeResult = await window.tokenizeCard({
            registerkey: DEJAVOO_AUTH_TOKEN,
            cardnumber: ccnumber,
            expMonth: expiryMonth,
            expYear: expiryYear,
            billingZip: billingZip,
            cvdIndicator: 'PROVIDED',
            cvdCode: cccvv
          });

          if (!tokenizeResult?.success || tokenizeResult?.responseCode !== 'A01') {
            throw new Error('Tokenization failed');
          }

          paymentTokenId = tokenizeResult.paymentTokenId;
          reusableToken = tokenizeResult.reusableToken;
          console.log('‚úÖ Card tokenized:', { paymentTokenId, reusableToken });

          // Step 2: Process the sale
          console.log('üí∞ Processing sale...');
          const saleResult = await window.processSale({
            registerkey: DEJAVOO_AUTH_TOKEN,
            amount: 15500,
            paymentTokenId: paymentTokenId,
            invoiceNumber: `WEB${Date.now()}`,
            billingEmail: selectedCustomer.email || '',
            billingName: billingName,
            billingAddress1: billingAddress,
            billingCity: billingCity,
            billingState: billingState,
            billingZip: billingZip,
            billingCountryCode: 'US'
          });

          console.log('üì• Sale API response:', saleResult);

          if (saleResult?.iposTransactResponse?.responseCode === 'A01' || 
              saleResult?.iposhpresponse?.responseCode === 'A01') {
            console.log('‚úÖ Payment approved');
            
            // Save payment token if customer wants to save card
            const saveCard = document.getElementById('saveCardCheckbox').checked;
            if (saveCard && reusableToken && (selectedCustomer.id || selectedCustomer.customer_id)) {
              await savePaymentToken(reusableToken);
            }
            
            await saveTransaction(saleResult);
            showSuccessPage(saleResult);
          } else {
            const declineInfo = getDeclineInfo(saleResult.iposTransactResponse || saleResult.iposhpresponse);
            console.error('‚ùå Payment declined:', declineInfo);
            showDeclineModal(declineInfo);
          }
        } catch (error) {
          console.error('‚ùå Payment error:', error);
          throw error;
        } finally {
          document.getElementById('processingOverlay').style.display = 'none';
        }
      }

      // Process saved card payment
      async function processSavedCardPayment() {
        console.log('üí≥ Processing saved card payment...');
        
        const savedCvv = document.getElementById('savedCvv').value;
        const card = savedCards.find(c => c.id === selectedPaymentMethod);
        
        if (!card || !card.token) {
          throw new Error('Invalid saved card');
        }

        try {
          console.log('üí∞ Processing sale with saved token...');
          const saleResult = await window.processSale({
            registerkey: DEJAVOO_AUTH_TOKEN,
            amount: 15500,
            reusableToken: card.token,
            cvdIndicator: 'PROVIDED',
            cvdCode: savedCvv,
            invoiceNumber: `WEB${Date.now()}`,
            billingEmail: selectedCustomer.email || ''
          });

          console.log('üì• Sale API response:', saleResult);

          if (saleResult?.iposTransactResponse?.responseCode === 'A01' || 
              saleResult?.iposhpresponse?.responseCode === 'A01') {
            console.log('‚úÖ Payment approved');
            await saveTransaction(saleResult);
            showSuccessPage(saleResult);
          } else {
            const declineInfo = getDeclineInfo(saleResult.iposTransactResponse || saleResult.iposhpresponse);
            console.error('‚ùå Payment declined:', declineInfo);
            showDeclineModal(declineInfo);
          }
        } catch (error) {
          console.error('‚ùå Payment error:', error);
          throw error;
        } finally {
          document.getElementById('processingOverlay').style.display = 'none';
        }
      }

      // Save payment token
      async function savePaymentToken(token) {
        try {
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const ccexpiry = document.getElementById('ccexpiry').value.replace(/\D/g, '');
          const lastFour = ccnumber.slice(-4);
          const cardType = getCardType(ccnumber);
          const expiryMonth = ccexpiry.substring(0, 2);
          const expiryYear = ccexpiry.substring(2, 4);
          
          const payload = {
            customer_id: selectedCustomer.id || selectedCustomer.customer_id,
            winery_id: WINERY_ID,
            processor: 'dejavoo',
            token: token,
            card_type: cardType,
            last_4: lastFour,
            expiry_month: expiryMonth,
            expiry_year: expiryYear
          };
          
          console.log('üíæ Saving payment token:', payload);
          
          const response = await fetch('/.netlify/functions/save-payment-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Save token error:', errorText);
          } else {
            console.log('‚úÖ Payment token saved');
          }
        } catch (error) {
          console.error('Failed to save payment token:', error);
        }
      }

      // Get decline info
      function getDeclineInfo(response) {
        if (!response) {
          return {
            code: 'N/A',
            message: 'Unknown error',
            definition: 'No response data available'
          };
        }

        const declineCodes = {
          'D01': 'Refer to card issuer',
          'D02': 'Refer to card issuer (special condition)',
          'D03': 'Invalid merchant',
          'D04': 'Pick up card (no fraud)',
          'D05': 'Do not honor',
          'D07': 'Pick up card (special condition)',
          'D12': 'Invalid transaction',
          'D13': 'Invalid amount',
          'D14': 'Invalid card number',
          'D15': 'Invalid issuer',
          'D19': 'Re-enter transaction',
          'D30': 'Format error',
          'D41': 'Lost card',
          'D43': 'Stolen card',
          'D51': 'Insufficient funds',
          'D54': 'Expired card',
          'D55': 'Invalid PIN',
          'D57': 'Transaction not permitted to cardholder',
          'D58': 'Transaction not permitted to terminal',
          'D61': 'Exceeds withdrawal amount limit',
          'D62': 'Restricted card',
          'D63': 'Security violation',
          'D65': 'Exceeds withdrawal frequency limit',
          'D75': 'PIN tries exceeded',
          'D76': 'Invalid product codes',
          'D77': 'Reconcile error',
          'D78': 'Trace number not found',
          'D79': 'Life cycle error',
          'D80': 'Invalid date',
          'D82': 'Invalid CVV',
          'D83': 'Unable to verify PIN',
          'D85': 'Valid for all purchases except cash',
          'D86': 'Cannot verify PIN',
          'D91': 'Issuer or switch inoperative',
          'D92': 'Unable to route transaction',
          'D96': 'System malfunction'
        };

        const code = response.responseCode || 'N/A';
        const message = response.responseMessage || response.errResponseMessage || 'Unknown error';
        const definition = declineCodes[code] || 'No additional details available';

        return { code, message, definition };
      }

      // Save transaction
      async function saveTransaction(saleResponse) {
        try {
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData) {
            console.warn('No transaction data to save');
            return;
          }
          
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const lastFour = ccnumber.slice(-4);
          const cardType = getCardType(ccnumber);

          const payload = {
            winery_id: WINERY_ID,
            customer_id: selectedCustomer.id || selectedCustomer.customer_id,
            reference_id: transactionData.transactionReferenceId || `WEB${Date.now()}`,
            transaction_id: transactionData.transactionId,
            amount: transactionData.totalAmount || transactionData.amount || 0,
            status: 'approved',
            response_code: transactionData.responseCode,
            response_message: transactionData.responseMessage || transactionData.errResponseMessage,
            card_type: cardType,
            card_last_4: lastFour,
            approval_code: transactionData.responseApprovalCode,
            batch_number: transactionData.batchNumber,
            request_data: saleResponse,
            response_data: transactionData
          };
          
          console.log('üîç Sending transaction payload:', payload);

          const response = await fetch('/.netlify/functions/save-transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Save transaction error response:', errorText);
          }
          
          console.log('‚úÖ Transaction saved to database');
        } catch (error) {
          console.error('Failed to save transaction:', error);
        }
      }

      // Helper functions
      function getCardType(cardNumber) {
        if (/^4/.test(cardNumber)) return 'Visa';
        if (/^5[1-5]/.test(cardNumber)) return 'Mastercard';
        if (/^3[47]/.test(cardNumber)) return 'American Express';
        if (/^6(?:011|5)/.test(cardNumber)) return 'Discover';
        return 'Card';
      }

      function showAlert(containerId, type, message) {
        const container = document.getElementById(containerId);
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      }

      function showDeclineModal(declineInfo) {
        // Remove any existing decline modal
        const existingModal = document.getElementById('declineModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Create decline modal
        const modal = document.createElement('div');
        modal.id = 'declineModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          font-family: Georgia, serif;
        `;

        const content = document.createElement('div');
        content.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 40px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          text-align: center;
        `;

        content.innerHTML = `
          <div style="color: #e74c3c; font-size: 64px; margin-bottom: 20px;">
            ‚úï
          </div>
          <h2 style="color: #333; margin: 0 0 30px 0; font-size: 28px;">
            PAYMENT DECLINED
          </h2>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: left;">
            <div style="margin-bottom: 15px;">
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Decline Code</div>
              <div style="color: #333; font-weight: bold; font-size: 18px;">${declineInfo.code || 'N/A'}</div>
            </div>
            <div style="margin-bottom: 15px;">
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Authorization Response Message</div>
              <div style="color: #333; font-weight: bold; font-size: 18px;">${declineInfo.message || 'Unknown error'}</div>
            </div>
            <div>
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Response Definition</div>
              <div style="color: #333; font-size: 16px; line-height: 1.5;">${declineInfo.definition || 'No details available'}</div>
            </div>
          </div>
          <button id="closeDeclineModal" style="
            background: #5dade2;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-weight: bold;
          ">
            Close
          </button>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Handle close button
        document.getElementById('closeDeclineModal').addEventListener('click', () => {
          modal.remove();
        });
      }


      function setStep(step) {
        for (let i = 1; i <= 3; i++) {
          const indicator = document.getElementById(`step${i}-indicator`);
          indicator.classList.toggle('active', i <= step);
        }

        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        window.scrollTo(0, 0);
      }

      function editStep(step) {
        setStep(step);
      }

      function showSuccessPage(response) {
        const data = response.iposTransactResponse || response.iposhpresponse;
        const paymentMethod = selectedPaymentMethod === 'googlepay' ? 'Google Pay' : 'Card';
        showAlert('reviewAlerts', 'success', `
          <h3 style="margin-bottom: 15px">‚úÖ Payment Successful!</h3>
          <p><strong>Payment Method:</strong> ${paymentMethod}</p>
          <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
          <p><strong>Amount:</strong> $${(data.totalAmount / 100).toFixed(2)}</p>
          <p><strong>Approval Code:</strong> ${data.responseApprovalCode}</p>
          ${data.chdToken && selectedPaymentMethod !== 'googlepay' ? '<p style="margin-top: 10px; color: #856404;">üí≥ Card saved for future use</p>' : ''}
        `);
        document.querySelector('#step3 .btn').style.display = 'none';
      }

      // Input formatting
      document.getElementById('ccnumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
      });

      document.getElementById('ccexpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
        e.target.value = value;
      });

      document.getElementById('cccvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      document.getElementById('savedCvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Initialize
      window.addEventListener('DOMContentLoaded', loadConfig);
    </script>
  </body>
</html>