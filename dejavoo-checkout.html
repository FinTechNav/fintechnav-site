<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dejavoo Payment Checkout</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e0e0e0;
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    h1 {
      color: #4a9eff;
      margin-bottom: 10px;
      font-size: 2rem;
    }

    .subtitle {
      color: #a0a0a0;
      margin-bottom: 30px;
      font-size: 0.95rem;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      padding: 0 20px;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }

    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 60%;
      right: -40%;
      height: 2px;
      background: rgba(255, 255, 255, 0.2);
      z-index: 0;
    }

    .step.active:not(:last-child)::after {
      background: #4a9eff;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.1);
      border: 2px solid rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 8px;
      z-index: 1;
      position: relative;
    }

    .step.active .step-number {
      background: #4a9eff;
      border-color: #4a9eff;
      color: #fff;
    }

    .step.completed .step-number {
      background: #28a745;
      border-color: #28a745;
      color: #fff;
    }

    .step-label {
      font-size: 0.85rem;
      color: #a0a0a0;
      text-align: center;
    }

    .step.active .step-label {
      color: #4a9eff;
      font-weight: 500;
    }

    .page {
      display: none;
    }

    .page.active {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      color: #c0c0c0;
      font-size: 0.9rem;
      font-weight: 500;
    }

    select, input {
      width: 100%;
      padding: 12px 16px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 1rem;
      transition: all 0.3s ease;
    }

    select:focus, input:focus {
      outline: none;
      border-color: #4a9eff;
      background: rgba(255, 255, 255, 0.08);
      box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
    }

    select option {
      background: #1a1a2e;
      color: #e0e0e0;
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .input-row-3 {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr;
      gap: 16px;
    }

    .help-text {
      font-size: 0.85rem;
      color: #888;
      margin-top: 6px;
    }

    .saved-cards {
      margin-bottom: 24px;
    }

    .card-option {
      background: rgba(255, 255, 255, 0.03);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .card-option:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(74, 158, 255, 0.5);
    }

    .card-option.selected {
      border-color: #4a9eff;
      background: rgba(74, 158, 255, 0.1);
    }

    .card-option input[type="radio"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }

    .card-info {
      flex: 1;
    }

    .card-brand {
      font-weight: 600;
      color: #4a9eff;
      font-size: 0.95rem;
    }

    .card-details {
      color: #a0a0a0;
      font-size: 0.85rem;
      margin-top: 4px;
    }

    .new-card-option {
      border-style: dashed;
      justify-content: center;
      color: #4a9eff;
      font-weight: 500;
    }

    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 16px;
      padding: 16px;
      background: rgba(74, 158, 255, 0.05);
      border-radius: 8px;
      border: 1px solid rgba(74, 158, 255, 0.2);
    }

    .checkbox-group input[type="checkbox"] {
      width: 20px;
      height: 20px;
      margin: 0;
    }

    .checkbox-group label {
      margin: 0;
      color: #c0c0c0;
      font-size: 0.9rem;
    }

    .button-group {
      display: flex;
      gap: 16px;
      margin-top: 32px;
    }

    button {
      flex: 1;
      padding: 14px 24px;
      border: none;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #4a9eff 0%, #357abd 100%);
      color: white;
    }

    .btn-primary:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(74, 158, 255, 0.4);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.05);
      color: #c0c0c0;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .btn-secondary:hover:not(:disabled) {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      display: none;
      text-align: center;
      padding: 40px;
    }

    .loading.active {
      display: block;
    }

    .spinner {
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top: 3px solid #4a9eff;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .success-message {
      background: rgba(40, 167, 69, 0.1);
      border: 1px solid rgba(40, 167, 69, 0.3);
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
      text-align: center;
    }

    .success-icon {
      font-size: 3rem;
      margin-bottom: 10px;
    }

    .error-message {
      background: rgba(220, 53, 69, 0.1);
      border: 1px solid rgba(220, 53, 69, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      color: #ff6b6b;
    }

    .info-section {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 8px;
      padding: 20px;
      margin-top: 24px;
    }

    .info-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .info-row:last-child {
      border-bottom: none;
      font-weight: 600;
      font-size: 1.1rem;
      color: #4a9eff;
    }

    .info-label {
      color: #a0a0a0;
    }

    .info-value {
      color: #e0e0e0;
    }

    #new-card-form {
      display: none;
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    #new-card-form.active {
      display: block;
    }

    /* Hidden Freedom to Design iframe */
    #ftd {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üõí Checkout</h1>
    <p class="subtitle">Complete your purchase securely</p>

    <!-- Step Indicator -->
    <div class="step-indicator">
      <div class="step active" id="step-1-indicator">
        <div class="step-number">1</div>
        <div class="step-label">Customer</div>
      </div>
      <div class="step" id="step-2-indicator">
        <div class="step-number">2</div>
        <div class="step-label">Payment</div>
      </div>
      <div class="step" id="step-3-indicator">
        <div class="step-number">3</div>
        <div class="step-label">Review</div>
      </div>
    </div>

    <!-- Page 1: Customer Selection -->
    <div id="page-1" class="page active">
      <h2 style="color: #4a9eff; margin-bottom: 20px;">Select Customer</h2>
      
      <div class="form-group">
        <label for="customer-select">Choose a customer or checkout as guest</label>
        <select id="customer-select">
          <option value="">-- Select a customer --</option>
          <option value="guest">üé´ Checkout as Guest</option>
        </select>
      </div>

      <div id="customer-info" class="info-section" style="display: none;">
        <h3 style="color: #4a9eff; margin-bottom: 16px;">Customer Information</h3>
        <div class="info-row">
          <span class="info-label">Name:</span>
          <span class="info-value" id="display-name"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Email:</span>
          <span class="info-value" id="display-email"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Address:</span>
          <span class="info-value" id="display-address"></span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-primary" onclick="nextToPayment()" id="continue-to-payment" disabled>
          Continue to Payment ‚Üí
        </button>
      </div>
    </div>

    <!-- Page 2: Payment Information -->
    <div id="page-2" class="page">
      <h2 style="color: #4a9eff; margin-bottom: 20px;">Payment Information</h2>

      <!-- Saved Cards Section (for returning customers) -->
      <div id="saved-cards-section" style="display: none;">
        <h3 style="color: #c0c0c0; margin-bottom: 16px; font-size: 1rem;">Saved Payment Methods</h3>
        <div id="saved-cards-list" class="saved-cards"></div>
      </div>

      <!-- CVV for Saved Card -->
      <div id="saved-card-cvv" style="display: none;">
        <div class="form-group">
          <label for="saved-cvv">Security Code (CVV)</label>
          <input type="text" id="saved-cvv" maxlength="4" placeholder="123" autocomplete="off">
          <div class="help-text">Required for security - not stored with your card</div>
        </div>
      </div>

      <!-- New Card Form -->
      <div id="new-card-form">
        <h3 style="color: #c0c0c0; margin-bottom: 16px; font-size: 1rem;" id="new-card-heading">Payment Details</h3>
        
        <div class="form-group">
          <label for="card-number">Card Number</label>
          <input type="text" id="card-number" maxlength="19" placeholder="4111 1111 1111 1111" autocomplete="cc-number">
          <div class="help-text">Test: 4111 1111 1111 1111</div>
        </div>

        <div class="input-row-3">
          <div class="form-group">
            <label for="expiry-month">Expiry Month</label>
            <input type="text" id="expiry-month" maxlength="2" placeholder="12" autocomplete="cc-exp-month">
          </div>
          <div class="form-group">
            <label for="expiry-year">Year</label>
            <input type="text" id="expiry-year" maxlength="4" placeholder="2025" autocomplete="cc-exp-year">
          </div>
          <div class="form-group">
            <label for="cvv">CVV</label>
            <input type="text" id="cvv" maxlength="4" placeholder="999" autocomplete="cc-csc">
          </div>
        </div>

        <!-- Billing Information (for guest checkout) -->
        <div id="billing-info-section">
          <h3 style="color: #c0c0c0; margin-bottom: 16px; margin-top: 24px; font-size: 1rem;">Billing Information</h3>
          
          <div class="form-group">
            <label for="billing-name">Cardholder Name</label>
            <input type="text" id="billing-name" placeholder="John Doe" autocomplete="cc-name">
          </div>

          <div class="form-group">
            <label for="billing-street">Street Address</label>
            <input type="text" id="billing-street" placeholder="123 Main Street" autocomplete="street-address">
          </div>

          <div class="input-row">
            <div class="form-group">
              <label for="billing-city">City</label>
              <input type="text" id="billing-city" placeholder="Springfield" autocomplete="address-level2">
            </div>
            <div class="form-group">
              <label for="billing-state">State</label>
              <input type="text" id="billing-state" maxlength="2" placeholder="IL" autocomplete="address-level1">
            </div>
          </div>

          <div class="input-row">
            <div class="form-group">
              <label for="billing-zip">ZIP Code</label>
              <input type="text" id="billing-zip" maxlength="10" placeholder="62704" autocomplete="postal-code">
            </div>
            <div class="form-group">
              <label for="billing-country">Country</label>
              <input type="text" id="billing-country" value="USA" autocomplete="country-name">
            </div>
          </div>
        </div>

        <!-- Save Card Checkbox (for returning customers with new card) -->
        <div id="save-card-option" style="display: none;">
          <div class="checkbox-group">
            <input type="checkbox" id="save-card" checked>
            <label for="save-card">üíæ Save this card for future purchases</label>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-secondary" onclick="backToCustomer()">
          ‚Üê Back
        </button>
        <button class="btn-primary" onclick="nextToReview()" id="continue-to-review">
          Review Order ‚Üí
        </button>
      </div>
    </div>

    <!-- Page 3: Review and Confirm -->
    <div id="page-3" class="page">
      <h2 style="color: #4a9eff; margin-bottom: 20px;">Review Your Order</h2>

      <div class="info-section">
        <h3 style="color: #c0c0c0; margin-bottom: 16px;">Order Summary</h3>
        <div class="info-row">
          <span class="info-label">Customer:</span>
          <span class="info-value" id="review-customer"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Payment Method:</span>
          <span class="info-value" id="review-payment"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Billing Address:</span>
          <span class="info-value" id="review-billing"></span>
        </div>
        <div class="info-row">
          <span class="info-label">Amount:</span>
          <span class="info-value">$155.00</span>
        </div>
      </div>

      <div class="button-group">
        <button class="btn-secondary" onclick="backToPayment()">
          ‚Üê Back
        </button>
        <button class="btn-primary" onclick="processPayment()" id="process-payment-btn">
          Complete Purchase ($155.00)
        </button>
      </div>
    </div>

    <!-- Loading State -->
    <div id="loading" class="loading">
      <div class="spinner"></div>
      <p style="color: #a0a0a0;">Processing your payment...</p>
    </div>

    <!-- Success Page -->
    <div id="success-page" class="page">
      <div class="success-message">
        <div class="success-icon">‚úÖ</div>
        <h2 style="color: #28a745; margin-bottom: 10px;">Payment Successful!</h2>
        <p style="color: #a0a0a0; margin-bottom: 20px;">Your transaction has been completed.</p>
        
        <div class="info-section" style="text-align: left;">
          <div class="info-row">
            <span class="info-label">Transaction ID:</span>
            <span class="info-value" id="success-transaction-id"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Amount:</span>
            <span class="info-value" id="success-amount"></span>
          </div>
          <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="info-value" style="color: #28a745;">Approved</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden iframe for Freedom to Design -->
  <iframe id="ftd" name="ftd"></iframe>

  <!-- Freedom to Design Script (loaded dynamically) -->
  <script id="ftd-script"></script>

  <script>
    // ============================================
    // GLOBAL STATE
    // ============================================
    let MERCHANT_ID = '';
    let API_AUTH_TOKEN = '';
    let DEJAVOO_AUTH_TOKEN = '';
    let ENVIRONMENT = 'sandbox';
    let API_BASE_URL = '';

    let selectedCustomer = null;
    let savedCards = [];
    let selectedPaymentMethod = 'new'; // 'new' or token_id
    let paymentTokenId = null;
    let reusableToken = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('üöÄ Initializing checkout page...');
      await loadConfig();
      await loadCustomers();
    });

    async function loadConfig() {
      try {
        console.log('üì° Loading Dejavoo configuration...');
        const response = await fetch('/.netlify/functions/get-dejavoo-config');
        
        if (!response.ok) {
          throw new Error(`Config load failed: ${response.status}`);
        }

        const config = await response.json();
        
        DEJAVOO_AUTH_TOKEN = config.dejavooAuthToken;
        MERCHANT_ID = config.merchantId;
        API_AUTH_TOKEN = config.apiAuthToken;
        ENVIRONMENT = config.environment;
        
        API_BASE_URL = ENVIRONMENT === 'sandbox'
          ? 'https://payment.ipospays.tech/api/v2/iposTransact'
          : 'https://payment.ipospays.com/api/v2/iposTransact';
        
        console.log('‚úÖ Configuration loaded successfully');
        console.log('üìå Environment:', ENVIRONMENT);
        console.log('üìå Merchant ID:', MERCHANT_ID);

        // Load Freedom to Design script
        const ftdScript = document.getElementById('ftd-script');
        const scriptUrl = ENVIRONMENT === 'sandbox'
          ? 'https://payments.ipospays.tech/FreedomtoDesignAuthorize/ftdjs'
          : 'https://payments.ipospays.com/FreedomtoDesignAuthorize/ftdjs';
        
        ftdScript.src = scriptUrl;
        console.log('‚úÖ Freedom to Design script loaded');
      } catch (error) {
        console.error('‚ùå Configuration load failed:', error);
        alert('Failed to load payment configuration. Please refresh the page.');
      }
    }

    async function loadCustomers() {
      try {
        console.log('üë• Loading customer list...');
        const response = await fetch('/.netlify/functions/get-customers');
        
        if (!response.ok) {
          throw new Error(`Customers load failed: ${response.status}`);
        }

        const customers = await response.json();
        console.log('‚úÖ Loaded', customers.length, 'customers');

        const select = document.getElementById('customer-select');
        customers.forEach(customer => {
          const option = document.createElement('option');
          option.value = customer.customer_id;
          option.textContent = customer.customer_name;
          option.dataset.customer = JSON.stringify(customer);
          select.appendChild(option);
        });

        select.addEventListener('change', handleCustomerChange);
      } catch (error) {
        console.error('‚ùå Failed to load customers:', error);
      }
    }

    // ============================================
    // PAGE 1: CUSTOMER SELECTION
    // ============================================
    function handleCustomerChange() {
      const select = document.getElementById('customer-select');
      const selectedOption = select.options[select.selectedIndex];
      const continueBtn = document.getElementById('continue-to-payment');
      const customerInfo = document.getElementById('customer-info');

      if (!selectedOption.value) {
        continueBtn.disabled = true;
        customerInfo.style.display = 'none';
        selectedCustomer = null;
        return;
      }

      continueBtn.disabled = false;

      if (selectedOption.value === 'guest') {
        console.log('üé´ Guest checkout selected');
        selectedCustomer = {
          customer_id: null,
          customer_name: 'Guest',
          email: '',
          billing_street: '',
          billing_city: '',
          billing_state: '',
          billing_zip: '',
          billing_country: 'USA'
        };
        customerInfo.style.display = 'none';
      } else {
        selectedCustomer = JSON.parse(selectedOption.dataset.customer);
        console.log('üë§ Customer selected:', selectedCustomer.customer_name);
        
        document.getElementById('display-name').textContent = selectedCustomer.customer_name;
        document.getElementById('display-email').textContent = selectedCustomer.email;
        document.getElementById('display-address').textContent = 
          `${selectedCustomer.billing_street}, ${selectedCustomer.billing_city}, ${selectedCustomer.billing_state} ${selectedCustomer.billing_zip}`;
        
        customerInfo.style.display = 'block';
      }
    }

    async function nextToPayment() {
      if (!selectedCustomer) {
        alert('Please select a customer or choose guest checkout');
        return;
      }

      console.log('‚û°Ô∏è Moving to payment page...');

      // Update step indicators
      document.getElementById('step-1-indicator').classList.remove('active');
      document.getElementById('step-1-indicator').classList.add('completed');
      document.getElementById('step-2-indicator').classList.add('active');

      // Show page 2
      document.getElementById('page-1').classList.remove('active');
      document.getElementById('page-2').classList.add('active');

      // Configure payment page based on customer
      if (selectedCustomer.customer_id) {
        // Returning customer - load saved cards
        await loadSavedCards(selectedCustomer.customer_id);
        
        // Pre-fill billing info
        document.getElementById('billing-name').value = selectedCustomer.customer_name;
        document.getElementById('billing-street').value = selectedCustomer.billing_street;
        document.getElementById('billing-city').value = selectedCustomer.billing_city;
        document.getElementById('billing-state').value = selectedCustomer.billing_state;
        document.getElementById('billing-zip').value = selectedCustomer.billing_zip;
        document.getElementById('billing-country').value = selectedCustomer.billing_country;

        // Show save card option
        document.getElementById('save-card-option').style.display = 'block';
      } else {
        // Guest checkout - clear all fields
        clearPaymentForm();
        document.getElementById('saved-cards-section').style.display = 'none';
        document.getElementById('new-card-form').classList.add('active');
        document.getElementById('save-card-option').style.display = 'none';
      }
    }

    async function loadSavedCards(customerId) {
      try {
        console.log('üí≥ Loading saved payment methods...');
        const response = await fetch(`/.netlify/functions/get-payment-tokens?customer_id=${customerId}`);
        
        if (!response.ok) {
          console.warn('‚ö†Ô∏è No saved cards found');
          savedCards = [];
          showNewCardForm();
          return;
        }

        savedCards = await response.json();
        console.log('‚úÖ Loaded', savedCards.length, 'saved cards');

        if (savedCards.length > 0) {
          displaySavedCards();
        } else {
          showNewCardForm();
        }
      } catch (error) {
        console.error('‚ùå Failed to load saved cards:', error);
        showNewCardForm();
      }
    }

    function displaySavedCards() {
      const savedCardsSection = document.getElementById('saved-cards-section');
      const savedCardsList = document.getElementById('saved-cards-list');
      
      savedCardsList.innerHTML = '';

      // Add saved cards
      savedCards.forEach(card => {
        const cardOption = document.createElement('div');
        cardOption.className = 'card-option';
        cardOption.innerHTML = `
          <input type="radio" name="payment-method" value="${card.token_id}" id="card-${card.token_id}">
          <div class="card-info">
            <div class="card-brand">${card.card_type || 'Card'}</div>
            <div class="card-details">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_four} | Expires ${card.expiry_month}/${card.expiry_year}</div>
          </div>
        `;
        cardOption.onclick = () => selectSavedCard(card.token_id);
        savedCardsList.appendChild(cardOption);
      });

      // Add "new card" option
      const newCardOption = document.createElement('div');
      newCardOption.className = 'card-option new-card-option';
      newCardOption.innerHTML = `
        <input type="radio" name="payment-method" value="new" id="card-new">
        <div>‚ûï Use a different card</div>
      `;
      newCardOption.onclick = () => selectNewCard();
      savedCardsList.appendChild(newCardOption);

      savedCardsSection.style.display = 'block';
      
      // Select first card by default
      selectSavedCard(savedCards[0].token_id);
    }

    function selectSavedCard(tokenId) {
      selectedPaymentMethod = tokenId;
      
      // Update UI
      document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      document.getElementById(`card-${tokenId}`).checked = true;

      // Show CVV input, hide new card form
      document.getElementById('saved-card-cvv').style.display = 'block';
      document.getElementById('new-card-form').classList.remove('active');

      console.log('üí≥ Selected saved card:', tokenId);
    }

    function selectNewCard() {
      selectedPaymentMethod = 'new';
      
      // Update UI
      document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
      event.currentTarget.classList.add('selected');
      document.getElementById('card-new').checked = true;

      // Hide CVV input, show new card form
      document.getElementById('saved-card-cvv').style.display = 'none';
      document.getElementById('new-card-form').classList.add('active');
      document.getElementById('new-card-heading').textContent = 'Enter New Card Details';

      console.log('‚ûï Selected new card entry');
    }

    function showNewCardForm() {
      document.getElementById('saved-cards-section').style.display = 'none';
      document.getElementById('new-card-form').classList.add('active');
      document.getElementById('new-card-heading').textContent = 'Payment Details';
    }

    function clearPaymentForm() {
      document.getElementById('card-number').value = '';
      document.getElementById('expiry-month').value = '';
      document.getElementById('expiry-year').value = '';
      document.getElementById('cvv').value = '';
      document.getElementById('billing-name').value = '';
      document.getElementById('billing-street').value = '';
      document.getElementById('billing-city').value = '';
      document.getElementById('billing-state').value = '';
      document.getElementById('billing-zip').value = '';
      document.getElementById('billing-country').value = 'USA';
      document.getElementById('saved-cvv').value = '';
    }

    // ============================================
    // PAGE 2: PAYMENT INFO ‚Üí PAGE 3: REVIEW
    // ============================================
    function nextToReview() {
      // Validate payment information
      if (selectedPaymentMethod === 'new') {
        if (!validateNewCardForm()) {
          return;
        }
      } else {
        const cvv = document.getElementById('saved-cvv').value;
        if (!cvv || cvv.length < 3) {
          alert('Please enter the CVV for your saved card');
          return;
        }
      }

      console.log('‚û°Ô∏è Moving to review page...');

      // Update step indicators
      document.getElementById('step-2-indicator').classList.remove('active');
      document.getElementById('step-2-indicator').classList.add('completed');
      document.getElementById('step-3-indicator').classList.add('active');

      // Populate review page
      populateReview();

      // Show page 3
      document.getElementById('page-2').classList.remove('active');
      document.getElementById('page-3').classList.add('active');
    }

    function validateNewCardForm() {
      const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
      const expiryMonth = document.getElementById('expiry-month').value;
      const expiryYear = document.getElementById('expiry-year').value;
      const cvv = document.getElementById('cvv').value;
      const billingName = document.getElementById('billing-name').value;
      const billingStreet = document.getElementById('billing-street').value;
      const billingCity = document.getElementById('billing-city').value;
      const billingState = document.getElementById('billing-state').value;
      const billingZip = document.getElementById('billing-zip').value;

      if (!cardNumber || cardNumber.length < 13) {
        alert('Please enter a valid card number');
        return false;
      }

      if (!expiryMonth || parseInt(expiryMonth) < 1 || parseInt(expiryMonth) > 12) {
        alert('Please enter a valid expiry month (01-12)');
        return false;
      }

      if (!expiryYear || expiryYear.length !== 4) {
        alert('Please enter a valid 4-digit expiry year');
        return false;
      }

      if (!cvv || cvv.length < 3) {
        alert('Please enter a valid CVV');
        return false;
      }

      if (!billingName || !billingStreet || !billingCity || !billingState || !billingZip) {
        alert('Please fill in all billing information fields');
        return false;
      }

      return true;
    }

    function populateReview() {
      // Customer info
      document.getElementById('review-customer').textContent = selectedCustomer.customer_name;

      // Payment method
      let paymentText = '';
      if (selectedPaymentMethod === 'new') {
        const cardNumber = document.getElementById('card-number').value;
        const lastFour = cardNumber.replace(/\s/g, '').slice(-4);
        paymentText = `New card ending in ${lastFour}`;
      } else {
        const card = savedCards.find(c => c.token_id === selectedPaymentMethod);
        paymentText = `${card.card_type} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_four}`;
      }
      document.getElementById('review-payment').textContent = paymentText;

      // Billing address
      const street = document.getElementById('billing-street').value;
      const city = document.getElementById('billing-city').value;
      const state = document.getElementById('billing-state').value;
      const zip = document.getElementById('billing-zip').value;
      document.getElementById('review-billing').textContent = `${street}, ${city}, ${state} ${zip}`;
    }

    // ============================================
    // NAVIGATION FUNCTIONS
    // ============================================
    function backToCustomer() {
      document.getElementById('step-2-indicator').classList.remove('active');
      document.getElementById('step-1-indicator').classList.remove('completed');
      document.getElementById('step-1-indicator').classList.add('active');
      
      document.getElementById('page-2').classList.remove('active');
      document.getElementById('page-1').classList.add('active');
    }

    function backToPayment() {
      document.getElementById('step-3-indicator').classList.remove('active');
      document.getElementById('step-2-indicator').classList.remove('completed');
      document.getElementById('step-2-indicator').classList.add('active');
      
      document.getElementById('page-3').classList.remove('active');
      document.getElementById('page-2').classList.add('active');
    }

    // ============================================
    // PAYMENT PROCESSING
    // ============================================
    async function processPayment() {
      console.log('üí≥ Starting payment process...');
      
      // Show loading
      document.getElementById('page-3').style.display = 'none';
      document.getElementById('loading').classList.add('active');

      try {
        // Step 1: Get or generate payment token
        if (selectedPaymentMethod === 'new') {
          await generatePaymentToken();
        } else {
          // Use existing token
          const card = savedCards.find(c => c.token_id === selectedPaymentMethod);
          reusableToken = card.reusable_token;
          console.log('‚úÖ Using saved payment token');
        }

        // Step 2: Process transaction
        await processTransaction();

        // Step 3: Save new card if applicable
        if (selectedPaymentMethod === 'new' && selectedCustomer.customer_id && document.getElementById('save-card').checked) {
          await savePaymentToken();
        }

        // Show success
        showSuccess();

      } catch (error) {
        console.error('‚ùå Payment failed:', error);
        document.getElementById('loading').classList.remove('active');
        document.getElementById('page-3').style.display = 'block';
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `Payment failed: ${error.message}`;
        document.getElementById('page-3').insertBefore(errorDiv, document.querySelector('.button-group'));
      }
    }

    async function generatePaymentToken() {
      return new Promise((resolve, reject) => {
        console.log('üîê Generating payment token...');

        const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
        const expiryMonth = document.getElementById('expiry-month').value.padStart(2, '0');
        const expiryYear = document.getElementById('expiry-year').value;
        const cvv = document.getElementById('cvv').value;

        const tokenRequest = {
          authToken: DEJAVOO_AUTH_TOKEN,
          merchantId: MERCHANT_ID,
          ccnumber: cardNumber,
          ccexpiry: `${expiryMonth}${expiryYear}`,
          cccvv: cvv
        };

        window.freedomtopay(tokenRequest, function(response) {
          console.log('üì® Token response:', response);

          if (response.paymentTokenId) {
            paymentTokenId = response.paymentTokenId;
            console.log('‚úÖ Payment token generated:', paymentTokenId);
            resolve();
          } else {
            reject(new Error(response.responseMessage || 'Token generation failed'));
          }
        });
      });
    }

    async function processTransaction() {
      console.log('üí∞ Processing transaction...');

      const billingStreet = document.getElementById('billing-street').value;
      const billingCity = document.getElementById('billing-city').value;
      const billingState = document.getElementById('billing-state').value;
      const billingZip = document.getElementById('billing-zip').value;

      const transactionData = {
        authToken: API_AUTH_TOKEN,
        merchantId: MERCHANT_ID,
        merchantTransactionId: 'TEST' + Date.now(),
        firstName: selectedCustomer.customer_name.split(' ')[0],
        lastName: selectedCustomer.customer_name.split(' ').slice(1).join(' '),
        address: billingStreet,
        city: billingCity,
        state: billingState,
        zipCode: billingZip,
        amount: '155.00'
      };

      // Use appropriate token
      if (selectedPaymentMethod === 'new') {
        transactionData.paymentTokenId = paymentTokenId;
      } else {
        transactionData.paymentTokenId = reusableToken;
        transactionData.cvv = document.getElementById('saved-cvv').value;
      }

      console.log('üì§ Sending transaction request...');

      const response = await fetch(API_BASE_URL, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(transactionData)
      });

      const result = await response.json();
      console.log('üì® Transaction response:', result);

      if (result.responseCode !== '00') {
        throw new Error(result.responseMessage || 'Transaction failed');
      }

      // Store reusable token for new cards
      if (selectedPaymentMethod === 'new' && result.paymentTokenId) {
        reusableToken = result.paymentTokenId;
      }

      // Save transaction to database
      await saveTransaction(result);

      console.log('‚úÖ Transaction approved!');
    }

    async function savePaymentToken() {
      try {
        console.log('üíæ Saving payment token...');

        const cardNumber = document.getElementById('card-number').value.replace(/\s/g, '');
        const lastFour = cardNumber.slice(-4);
        const cardType = getCardType(cardNumber);
        const expiryMonth = document.getElementById('expiry-month').value.padStart(2, '0');
        const expiryYear = document.getElementById('expiry-year').value;

        const tokenData = {
          customer_id: selectedCustomer.customer_id,
          payment_token_id: paymentTokenId,
          reusable_token: reusableToken,
          card_last_four: lastFour,
          card_type: cardType,
          expiry_month: expiryMonth,
          expiry_year: expiryYear
        };

        const response = await fetch('/.netlify/functions/save-payment-token', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(tokenData)
        });

        if (response.ok) {
          console.log('‚úÖ Payment token saved');
        } else {
          console.warn('‚ö†Ô∏è Failed to save payment token');
        }
      } catch (error) {
        console.error('‚ùå Error saving token:', error);
      }
    }

    async function saveTransaction(transactionResult) {
      try {
        const transactionData = {
          customer_id: selectedCustomer.customer_id,
          dejavoo_reference_id: transactionResult.transactionId || transactionResult.merchantTransactionId,
          amount: 155.00,
          status: 'approved',
          response_code: transactionResult.responseCode,
          response_message: transactionResult.responseMessage,
          card_last_four: transactionResult.last4 || document.getElementById('card-number').value.slice(-4),
          card_type: transactionResult.cardType
        };

        await fetch('/.netlify/functions/save-transaction', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(transactionData)
        });

        console.log('‚úÖ Transaction saved to database');
      } catch (error) {
        console.error('‚ö†Ô∏è Failed to save transaction:', error);
      }
    }

    function getCardType(cardNumber) {
      const num = cardNumber.replace(/\s/g, '');
      if (/^4/.test(num)) return 'Visa';
      if (/^5[1-5]/.test(num)) return 'Mastercard';
      if (/^3[47]/.test(num)) return 'American Express';
      if (/^6(?:011|5)/.test(num)) return 'Discover';
      return 'Unknown';
    }

    function showSuccess() {
      document.getElementById('loading').classList.remove('active');
      document.getElementById('success-page').classList.add('active');
      
      document.getElementById('success-transaction-id').textContent = 'TEST' + Date.now();
      document.getElementById('success-amount').textContent = '$155.00';
    }

    // ============================================
    // AUTO-FORMATTING
    // ============================================
    document.getElementById('card-number').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\s/g, '');
      let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
      e.target.value = formattedValue;
    });

    document.getElementById('expiry-month').addEventListener('input', function(e) {
      let value = e.target.value.replace(/\D/g, '');
      if (value.length > 0 && parseInt(value) > 12) {
        value = '12';
      }
      e.target.value = value;
    });

    document.getElementById('expiry-year').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    document.getElementById('cvv').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    document.getElementById('saved-cvv').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/\D/g, '');
    });

    document.getElementById('billing-state').addEventListener('input', function(e) {
      e.target.value = e.target.value.toUpperCase().replace(/[^A-Z]/g, '');
    });

    document.getElementById('billing-zip').addEventListener('input', function(e) {
      e.target.value = e.target.value.replace(/[^\d-]/g, '');
    });
  </script>
</body>
</html>