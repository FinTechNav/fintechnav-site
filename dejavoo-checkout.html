<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>Dejavoo Checkout</title>
    <link rel="stylesheet" href="checkout-styles.css" />
    <!-- Dejavoo Freedom to Design Library - Dynamically loaded -->
    <script id="ftd" defer></script>
    <!-- Google Pay SDK - Script tag must exist in DOM before SDK loads -->
    <script id="gpayftd"></script>
  </head>

  <body>
    <div class="container">
      <div class="header">
        <h1>Checkout</h1>
      </div>

      <div class="checkout-wrapper">
        <!-- Main Content -->
        <div class="checkout-main">
          <!-- Loading indicator -->
          <div id="loadingConfig" class="alert alert-info" style="display: none">
            <span>‚è≥</span> Loading payment configuration...
          </div>

          <!-- Progress Steps -->
          <div class="progress-steps">
            <div class="step active" id="step1-indicator">
              <span class="step-number">1</span>
              <span>Customer</span>
            </div>
            <div class="step" id="step2-indicator">
              <span class="step-number">2</span>
              <span>Payment</span>
            </div>
            <div class="step" id="step3-indicator">
              <span class="step-number">3</span>
              <span>Review</span>
            </div>
          </div>

          <!-- Step 1: Customer Selection -->
          <div class="step-content active" id="step1">
            <h2 class="section-title">Select Customer</h2>

            <div id="customerAlerts"></div>

            <div class="form-group">
              <label>Customer <span class="required">*</span></label>
              <select id="customerSelect" onchange="handleCustomerChange()">
                <option value="">-- Select Customer --</option>
                <option value="guest">üé´ Checkout as Guest</option>
              </select>
            </div>

            <div id="customerInfoBox" class="customer-info-box" style="display: none">
              <strong>Customer Details:</strong>
              <div id="customerInfo" style="margin-top: 10px"></div>
            </div>

            <button type="button" class="btn" id="continueToPayment" onclick="continueToPayment()" disabled>
              Continue to Payment
            </button>
          </div>

          <!-- Step 2: Payment -->
          <div class="step-content" id="step2">
            <h2 class="section-title">Payment</h2>

            <div class="security-notice">
              <span>üîí</span>
              All transactions are secure and encrypted
            </div>

            <div id="paymentAlerts"></div>

            <!-- Google Pay Button -->
            <div id="ipospays-gpay-btn" data-security-key=""></div>

            <div class="payment-divider">
              <span>Or pay with card</span>
            </div>

            <!-- Saved Cards Section -->
            <div id="savedCardsSection" style="display: none">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666">SAVED PAYMENT METHODS</h3>
              <div id="savedCardsList" class="saved-cards"></div>
            </div>

            <!-- CVV for saved card -->
            <div id="savedCardCvv" style="display: none">
              <div class="form-group">
                <label>CVV <span class="required">*</span></label>
                <input type="text" id="savedCvv" placeholder="123" maxlength="4" />
                <div class="help-text">Security code required for saved cards</div>
              </div>
            </div>

            <!-- New Card Form -->
            <div id="newCardForm">
              <h3 style="font-size: 0.9rem; margin-bottom: 15px; color: #666" id="newCardHeading">CARD DETAILS</h3>
              
              <form id="paymentForm">
                <div class="form-group">
                  <label>Card Number <span class="required">*</span></label>
                  <input
                    type="text"
                    id="ccnumber"
                    placeholder="1234 1234 1234 1234"
                    maxlength="19"
                  />
                </div>

                <div class="form-row" style="grid-template-columns: 1fr 1fr;">
                  <div class="form-group">
                    <label>Expiry Month <span class="required">*</span></label>
                    <input type="text" id="ccexpiry" placeholder="MM/YY" maxlength="5" />
                  </div>

                  <div class="form-group">
                    <label>CVV <span class="required">*</span></label>
                    <input type="text" id="cccvv" placeholder="123" maxlength="4" />
                    <div class="help-text">3-4 digits on back</div>
                  </div>
                </div>

                <!-- Save card option (for returning customers) -->
                <div id="saveCardOption" style="display: none; margin-bottom: 30px;">
                  <label class="checkbox-label">
                    <input type="checkbox" id="saveCardCheckbox" checked />
                    <span>Save this card for future purchases</span>
                  </label>
                </div>

                <h3 class="section-title" style="margin-top: 30px; font-size: 1rem">Billing</h3>

                <div class="form-group">
                  <label>Name <span class="required">*</span></label>
                  <input type="text" id="billingName" />
                </div>

                <div class="form-group">
                  <label>Address <span class="required">*</span></label>
                  <input type="text" id="billingAddress" />
                </div>

                <div class="form-row">
                  <div class="form-group">
                    <label>City <span class="required">*</span></label>
                    <input type="text" id="billingCity" />
                  </div>

                  <div class="form-group">
                    <label>State <span class="required">*</span></label>
                    <input type="text" id="billingState" maxlength="2" />
                  </div>

                  <div class="form-group">
                    <label>Zip <span class="required">*</span></label>
                    <input type="text" id="billingZip" />
                  </div>
                </div>
              </form>
            </div>

            <button type="button" class="btn" style="margin-top: 20px" onclick="continueToReview()">
              Continue to Review
            </button>
          </div>

          <!-- Step 3: Review -->
          <div class="step-content" id="step3">
            <h2 class="section-title">Review</h2>

            <div id="reviewAlerts"></div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Customer</h3>
                <button class="edit-link" onclick="editStep(1)">Edit</button>
              </div>
              <div class="review-content" id="reviewCustomer"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Payment</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewPayment"></div>
            </div>

            <div class="review-section">
              <div style="display: flex; justify-content: space-between; align-items: center">
                <h3>Billing Address</h3>
                <button class="edit-link" onclick="editStep(2)">Edit</button>
              </div>
              <div class="review-content" id="reviewBilling"></div>
            </div>

            <button type="button" class="btn" onclick="placeOrder()">Place Order</button>
          </div>
        </div>

        <!-- Sidebar -->
        <div class="checkout-sidebar">
          <div class="order-item">
            <div class="item-image">
              <img
                src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='60' height='60'%3E%3Crect fill='%23f0f0f0' width='60' height='60'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='10'%3EWine%3C/text%3E%3C/svg%3E"
                alt="Product"
                style="width: 100%; height: 100%"
              />
            </div>
            <div class="item-details">
              <div class="item-title">Humboldt Single Vineyard Pinot Pack</div>
              <div class="item-subtitle">Three-Pack</div>
              <div class="item-price">
                <span>$155.00</span>
                <span class="item-quantity">√ó 1</span>
                <span style="margin-left: auto">$155.00</span>
              </div>
            </div>
          </div>

          <div style="margin-top: 30px">
            <div class="summary-row">
              <span class="label">Subtotal (3)</span>
              <span>$155.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Shipping (UPS Ground)</span>
              <span><s style="color: #999">$31.93</s> $0.00</span>
            </div>
            <div class="summary-row">
              <span class="label">Tax</span>
              <span>$0.00</span>
            </div>
            <div class="summary-row total">
              <span class="label">Total</span>
              <span>USD $155.00</span>
            </div>
          </div>

          <div class="savings">
            <span>üí∞</span>
            <span>Shipping Included on Humboldt Three-Packs - $31.93 SAVED</span>
          </div>

          <div class="help-contact">
            Need help? Call us at<br />
            <a href="tel:7078201621">(707) 820-1621</a>
          </div>
        </div>
      </div>
    </div>

    <!-- Processing Overlay -->
    <div class="processing-overlay" id="processingOverlay">
      <div class="processing-content">
        <div class="spinner"></div>
        <h3 style="margin-bottom: 10px; color: #333">Processing Payment...</h3>
        <p style="color: #666; font-size: 0.9rem" id="processingMessage">
          Please wait while we process your transaction
        </p>
      </div>
    </div>

    <script>
      // Configuration - SET YOUR WINERY ID HERE
      const WINERY_ID = '22222222-2222-2222-2222-222222222222'; // Jensen Family Winery
      
      let MERCHANT_ID = '';
      let API_AUTH_TOKEN = '';
      let DEJAVOO_AUTH_TOKEN = '';
      let ENVIRONMENT = 'sandbox';
      let API_BASE_URL = '';

      let currentStep = 1;
      let selectedCustomer = null;
      let savedCards = [];
      let selectedPaymentMethod = 'new'; // 'new', 'googlepay', or token_id
      let paymentTokenId = null;
      let reusableToken = null;
      let configLoaded = false;
      let googlePayInitialized = false;
      let googlePayData = null;

      // Load configuration
      async function loadConfig() {
        const loadingEl = document.getElementById('loadingConfig');
        loadingEl.style.display = 'block';

        try {
          console.log('üîÑ Loading configuration...');
          const response = await fetch(`/.netlify/functions/get-dejavoo-config?winery_id=${WINERY_ID}`);
          
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const config = await response.json();
          
          DEJAVOO_AUTH_TOKEN = config.dejavooAuthToken;
          MERCHANT_ID = config.merchantId;
          API_AUTH_TOKEN = config.apiAuthToken;
          ENVIRONMENT = config.environment;

          const isSandbox = ENVIRONMENT === 'sandbox';
          API_BASE_URL = isSandbox
            ? 'https://payment.ipospays.tech/api/v2/iposTransact'
            : 'https://payment.ipospays.com/api/v2/iposTransact';

          const ftdScript = document.getElementById('ftd');
          const scriptUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/freedomtodesign.js'
            : 'https://payment.ipospays.com/ftd/v1/freedomtodesign.js';

          ftdScript.setAttribute('src', scriptUrl);
          ftdScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);

          await new Promise((resolve, reject) => {
            ftdScript.onload = resolve;
            ftdScript.onerror = reject;
          });

          // Configure Google Pay SDK using existing script tag
          const gpayScript = document.getElementById('gpayftd');
          const gpayUrl = isSandbox
            ? 'https://payment.ipospays.tech/ftd/v1/gpay-ftd.js'
            : 'https://payment.ipospays.com/ftd/v1/gpay-ftd.js';
          
          // Set security_key attribute FIRST
          gpayScript.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          // Then set src to load the script
          gpayScript.src = gpayUrl;
          
          gpayScript.onload = () => {
            console.log('‚úÖ Google Pay SDK loaded');
          };
          gpayScript.onerror = (error) => {
            console.warn('‚ö†Ô∏è Google Pay SDK failed to load:', error);
          };

          console.log('‚úÖ Configuration loaded');
          loadingEl.style.display = 'none';
          configLoaded = true;

          // Load customers
          await loadCustomers();
        } catch (error) {
          console.error('‚ùå Configuration error:', error);
          loadingEl.innerHTML = `<div class="alert alert-error">Configuration Error: ${error.message}</div>`;
        }
      }

      // Setup Google Pay
      function setupGooglePay() {
        if (!configLoaded || googlePayInitialized) return;

        // Wait a bit for SDK to load if not ready yet
        if (typeof window.initializeGooglePay !== 'function') {
          console.log('‚è≥ Waiting for Google Pay SDK...');
          setTimeout(setupGooglePay, 500);
          return;
        }

        try {
          // Set security key as global variable
          window.security_key = DEJAVOO_AUTH_TOKEN;
          
          // Force set security_key on script tag
          const gpayScriptTag = document.getElementById('gpayftd');
          if (gpayScriptTag) {
            gpayScriptTag.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          }
          
          // Set security key on button container
          const buttonContainer = document.getElementById('ipospays-gpay-btn');
          if (buttonContainer) {
            buttonContainer.setAttribute('data-security-key', DEJAVOO_AUTH_TOKEN);
            buttonContainer.setAttribute('security_key', DEJAVOO_AUTH_TOKEN);
          }

          const transactionInfo = {
            countryCode: "US",
            currencyCode: "USD",
            totalPriceStatus: "FINAL",
            totalPrice: "155.00",
            totalPriceLabel: "Total",
          };

          const merchantId = "N/A";
          const Mode = ENVIRONMENT === 'sandbox' ? "TEST" : "PRODUCTION";

          const buttonStyles = {
            buttonColor: "default",
            buttonType: "buy",
            buttonRadius: 4,
            buttonLocale: "en",
            buttonHeight: "48px",
            buttonWidth: "100%",
          };

          const goolePayFelids = {
            requestBillingAddress: true,
            requestPayerEmail: true,
            requestPayerPhone: false,
            requestShipping: false,
          };

          window.initializeGooglePay(transactionInfo, merchantId, Mode, buttonStyles, goolePayFelids);
          googlePayInitialized = true;
          console.log('‚úÖ Google Pay initialized');
        } catch (error) {
          console.error('‚ùå Google Pay initialization error:', error);
        }
      }

      // Callback for Google Pay - called by Google Pay SDK
      function getPaymentInfo(paymentData) {
        console.log("üì± Google Pay Payment Data received");
        console.log("üì¶ Full paymentData object:", paymentData);
        console.log("üì¶ PaymentData type:", typeof paymentData);
        console.log("üì¶ PaymentData keys:", Object.keys(paymentData));
        
        googlePayData = paymentData;
        selectedPaymentMethod = 'googlepay';
        
        // Auto-advance to review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        document.getElementById('reviewPayment').textContent = 'Google Pay';
        document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        
        console.log("‚úÖ Moving to review step (step 3)");
        setStep(3);
      }

      // Load customers
      async function loadCustomers() {
        try {
          const response = await fetch(`/.netlify/functions/get-winery-customers?winery_id=${WINERY_ID}`);
          if (!response.ok) throw new Error('Failed to load customers');
          
          const data = await response.json();
          if (!data.success) throw new Error('Failed to load customers');
          
          const customers = data.customers;
          const select = document.getElementById('customerSelect');
          
          customers.forEach(customer => {
            const option = document.createElement('option');
            option.value = customer.id;
            option.textContent = customer.name || customer.email;
            option.dataset.customer = JSON.stringify(customer);
            select.appendChild(option);
          });

          console.log('‚úÖ Loaded customers');
        } catch (error) {
          console.error('‚ùå Failed to load customers:', error);
          showAlert('customerAlerts', 'error', 'Unable to load customer list');
        }
      }

      // Handle customer selection
      function handleCustomerChange() {
        const select = document.getElementById('customerSelect');
        const continueBtn = document.getElementById('continueToPayment');
        const infoBox = document.getElementById('customerInfoBox');
        const infoDiv = document.getElementById('customerInfo');

        if (!select.value) {
          continueBtn.disabled = true;
          infoBox.style.display = 'none';
          selectedCustomer = null;
          return;
        }

        continueBtn.disabled = false;

        if (select.value === 'guest') {
          selectedCustomer = { 
            id: null, 
            customer_id: null, 
            name: 'Guest',
            customer_name: 'Guest'
          };
          infoBox.style.display = 'none';
        } else {
          const option = select.options[select.selectedIndex];
          const customer = JSON.parse(option.dataset.customer);
          
          // Map new fields to old field names for compatibility
          selectedCustomer = {
            ...customer,
            customer_id: customer.id,
            customer_name: customer.name || customer.email,
          };
          
          infoDiv.innerHTML = `
            <strong>${selectedCustomer.customer_name}</strong><br>
            ${selectedCustomer.email || ''}<br>
          `;
          infoBox.style.display = 'block';
        }
      }

      // Continue to payment
      async function continueToPayment() {
        if (!selectedCustomer) return;

        setStep(2);
        
        // Setup Google Pay when entering payment step
        setupGooglePay();

        if (selectedCustomer.id || selectedCustomer.customer_id) {
          // Load saved cards and pre-fill billing
          await loadSavedCards(selectedCustomer.id || selectedCustomer.customer_id);
          document.getElementById('billingName').value = selectedCustomer.customer_name || '';
          document.getElementById('saveCardOption').style.display = 'block';
        } else {
          // Guest - clear form
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
          document.getElementById('saveCardOption').style.display = 'none';
        }
      }

      // Load saved cards
      async function loadSavedCards(customerId) {
        try {
          console.log('üì° Loading saved cards for customer:', customerId);
          const response = await fetch(`/.netlify/functions/get-payment-tokens?customer_id=${customerId}&winery_id=${WINERY_ID}`);
          
          console.log('Response status:', response.status);
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('Error response:', errorText);
            throw new Error('No saved cards');
          }
          
          savedCards = await response.json();
          console.log('‚úÖ Loaded saved cards:', savedCards);
          
          if (savedCards.length > 0) {
            displaySavedCards();
          } else {
            console.log('No cards in array, showing new card form');
            document.getElementById('savedCardsSection').style.display = 'none';
            document.getElementById('newCardForm').style.display = 'block';
          }
        } catch (error) {
          console.error('‚ùå Failed to load saved cards:', error);
          document.getElementById('savedCardsSection').style.display = 'none';
          document.getElementById('newCardForm').style.display = 'block';
        }
      }

      // Display saved cards
      function displaySavedCards() {
        const section = document.getElementById('savedCardsSection');
        const list = document.getElementById('savedCardsList');
        list.innerHTML = '';

        savedCards.forEach(card => {
          const div = document.createElement('div');
          div.className = 'card-option';
          div.innerHTML = `
            <input type="radio" name="payment-method" value="${card.id}" id="card-${card.id}">
            <div>
              <strong>${card.card_type || 'Card'} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_4}</strong><br>
              <small style="color: #999">Expires ${card.card_expiry_month}/${card.card_expiry_year}</small>
            </div>
          `;
          div.onclick = function() { selectSavedCard(card.id, this); };
          list.appendChild(div);
        });

        // Add new card option
        const newDiv = document.createElement('div');
        newDiv.className = 'card-option';
        newDiv.innerHTML = `
          <input type="radio" name="payment-method" value="new" id="card-new">
          <div><strong>‚ûï Use a different card</strong></div>
        `;
        newDiv.onclick = function() { selectNewCard(this); };
        list.appendChild(newDiv);

        section.style.display = 'block';
        selectSavedCard(savedCards[0].id);
      }

      // Select saved card
      function selectSavedCard(paymentMethodId, clickedElement) {
        selectedPaymentMethod = paymentMethodId;
        document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
        
        if (clickedElement) {
          clickedElement.classList.add('selected');
        } else {
          const cardElement = document.getElementById(`card-${paymentMethodId}`)?.closest('.card-option');
          if (cardElement) cardElement.classList.add('selected');
        }
        
        document.getElementById(`card-${paymentMethodId}`).checked = true;
        document.getElementById('savedCardCvv').style.display = 'block';
        document.getElementById('newCardForm').style.display = 'none';
        console.log('üí≥ Selected saved card:', paymentMethodId);
      }

      // Select new card
      function selectNewCard(clickedElement) {
        selectedPaymentMethod = 'new';
        document.querySelectorAll('.card-option').forEach(el => el.classList.remove('selected'));
        
        if (clickedElement) {
          clickedElement.classList.add('selected');
        } else {
          const newCardElement = document.getElementById('card-new')?.closest('.card-option');
          if (newCardElement) newCardElement.classList.add('selected');
        }
        
        document.getElementById('card-new').checked = true;
        document.getElementById('savedCardCvv').style.display = 'none';
        document.getElementById('newCardForm').style.display = 'block';
        document.getElementById('newCardHeading').textContent = 'NEW CARD DETAILS';
        console.log('‚ûï Selected new card entry');
      }

      // Continue to review
      function continueToReview() {
        // Validate
        if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value.trim();
          const ccexpiry = document.getElementById('ccexpiry').value.trim();
          const cccvv = document.getElementById('cccvv').value.trim();
          const billingName = document.getElementById('billingName').value.trim();
          const billingAddress = document.getElementById('billingAddress').value.trim();
          const billingCity = document.getElementById('billingCity').value.trim();
          const billingState = document.getElementById('billingState').value.trim();
          const billingZip = document.getElementById('billingZip').value.trim();

          if (!ccnumber || ccnumber.replace(/\s/g, '').length < 13) {
            alert('Please enter a valid card number');
            document.getElementById('ccnumber').focus();
            return;
          }
          if (!ccexpiry || ccexpiry.length < 4) {
            alert('Please enter expiry date (MM/YY)');
            document.getElementById('ccexpiry').focus();
            return;
          }
          if (!cccvv || cccvv.length < 3) {
            alert('Please enter CVV (3-4 digits)');
            document.getElementById('cccvv').focus();
            return;
          }
          if (!billingName) {
            alert('Please enter cardholder name');
            document.getElementById('billingName').focus();
            return;
          }
          if (!billingAddress) {
            alert('Please enter billing address');
            document.getElementById('billingAddress').focus();
            return;
          }
          if (!billingCity) {
            alert('Please enter city');
            document.getElementById('billingCity').focus();
            return;
          }
          if (!billingState || billingState.length !== 2) {
            alert('Please enter 2-letter state code');
            document.getElementById('billingState').focus();
            return;
          }
          if (!billingZip) {
            alert('Please enter ZIP code');
            document.getElementById('billingZip').focus();
            return;
          }
        } else if (selectedPaymentMethod !== 'googlepay') {
          const savedCvv = document.getElementById('savedCvv').value.trim();
          if (!savedCvv || savedCvv.length < 3) {
            alert('Please enter CVV for saved card');
            document.getElementById('savedCvv').focus();
            return;
          }
        }

        // Update review
        document.getElementById('reviewCustomer').textContent = selectedCustomer.customer_name;
        
        if (selectedPaymentMethod === 'new') {
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const last4 = ccnumber.slice(-4);
          document.getElementById('reviewPayment').textContent = `New card ending in ${last4}`;
        } else if (selectedPaymentMethod === 'googlepay') {
          document.getElementById('reviewPayment').textContent = 'Google Pay';
        } else {
          const card = savedCards.find(c => c.id === selectedPaymentMethod);
          document.getElementById('reviewPayment').textContent = `${card.card_type} ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${card.card_last_4}`;
        }

        if (selectedPaymentMethod !== 'googlepay') {
          const name = document.getElementById('billingName').value;
          const address = document.getElementById('billingAddress').value;
          const city = document.getElementById('billingCity').value;
          const state = document.getElementById('billingState').value;
          const zip = document.getElementById('billingZip').value;
          
          document.getElementById('reviewBilling').innerHTML = `${name}<br>${address}<br>${city}, ${state} ${zip}`;
        } else {
          document.getElementById('reviewBilling').innerHTML = 'Google Pay (billing address from wallet)';
        }

        setStep(3);
      }

      // Place order
      async function placeOrder() {
        console.log("üöÄ placeOrder() called");
        console.log("   selectedPaymentMethod:", selectedPaymentMethod);
        console.log("   configLoaded:", configLoaded);
        
        if (!configLoaded) {
          showAlert('reviewAlerts', 'error', 'Payment system not ready');
          return;
        }

        document.getElementById('processingOverlay').classList.add('active');
        document.getElementById('processingMessage').textContent = 'Processing payment...';

        try {
          let saleResponse;

          if (selectedPaymentMethod === 'googlepay') {
            console.log("üí≥ Processing Google Pay transaction");
            // Process Google Pay transaction
            saleResponse = await processGooglePaySale();
            console.log("‚úÖ Google Pay sale completed, response:", saleResponse);
          } else {
            console.log("üí≥ Processing card payment");
            // Generate or use token for card payment
            if (selectedPaymentMethod === 'new') {
              if (typeof postData !== 'function') {
                throw new Error('Payment tokenization not available');
              }
              document.getElementById('processingMessage').textContent = 'Creating payment token...';
              const tokenResponse = await postData();
              console.log("üé´ Token response:", tokenResponse);
              if (tokenResponse.statusCode !== '00') throw new Error('Token generation failed');
              paymentTokenId = tokenResponse.payment_token_id;
            } else {
              const card = savedCards.find(c => c.id === selectedPaymentMethod);
              reusableToken = card.token;
              console.log("üí≥ Using saved card token:", reusableToken);
            }

            // Process card transaction
            document.getElementById('processingMessage').textContent = 'Processing payment...';
            saleResponse = await processSale();
            console.log("‚úÖ Card sale completed, response:", saleResponse);
          }

          document.getElementById('processingOverlay').classList.remove('active');

          console.log("üîç Analyzing response structure...");
          console.log("   Response keys:", Object.keys(saleResponse));
          
          // Check if backend processing succeeded
          if (!saleResponse.success) {
            console.error("‚ùå Backend processing failed");
            showDeclineModal(saleResponse.declineInfo || {
              code: 'ERROR',
              message: 'PROCESSING ERROR',
              definition: saleResponse.error || 'Payment processing failed',
            });
            return;
          }

          console.log("üéØ Transaction approved:", saleResponse.approved);
          
          if (saleResponse.approved) {
            console.log("‚úÖ Transaction approved!");
            
            // Save token if needed (token is in transactionData.chdToken)
            if (selectedPaymentMethod === 'new' && selectedCustomer.customer_id && document.getElementById('saveCardCheckbox').checked) {
              console.log("üíæ Saving payment token...");
              // Reconstruct response format for savePaymentToken function
              const legacyResponse = {
                iposTransactResponse: saleResponse.transactionData
              };
              await savePaymentToken(legacyResponse);
            }
            
            // Save transaction
            console.log("üíæ Saving transaction to database...");
            // Reconstruct response format for saveTransaction function
            const legacyResponse = {
              iposTransactResponse: saleResponse.transactionData
            };
            await saveTransaction(legacyResponse);
            
            console.log("üéâ Showing success page");
            showSuccessPage(legacyResponse);
          } else {
            console.error("‚ùå Transaction declined");
            console.error("   Decline info:", saleResponse.declineInfo);
            showDeclineModal(saleResponse.declineInfo);
          }
        } catch (error) {
          console.error('üí• Error in placeOrder:', error);
          console.error('   Error name:', error.name);
          console.error('   Error message:', error.message);
          console.error('   Error stack:', error.stack);
          document.getElementById('processingOverlay').classList.remove('active');
          showAlert('reviewAlerts', 'error', error.message);
        }
      }

      // Process Google Pay sale
      async function processGooglePaySale() {
        console.log("üí≥ Processing Google Pay sale...");
        console.log("üì¶ Using googlePayData:", googlePayData);
        
        const requestBody = {
          merchantAuthentication: {
            merchantId: MERCHANT_ID,
            transactionReferenceId: 'GPAY' + Date.now(),
          },
          transactionRequest: {
            transactionType: 1,
            amount: 15500,
            applySteamSettingTipFeeTax: false
          },
          preferences: {
            eReceipt: true,
            customerName: selectedCustomer.customer_name,
            customerEmail: selectedCustomer.email || 'guest@example.com',
            customerMobile: selectedCustomer.customer_phone || ''
          },
          Avs: {
            StreetNo: "155",
            Zip: "30316"
          },
          GooglePay: googlePayData  // At root level, not inside transactionRequest
        };

        console.log('üì§ iPOS Transact Request (Google Pay):');
        console.log('  - API URL:', API_BASE_URL);
        console.log('  - Merchant ID:', MERCHANT_ID);
        console.log('  - Transaction Reference:', requestBody.merchantAuthentication.transactionReferenceId);
        console.log('  - Amount:', requestBody.transactionRequest.amount);
        console.log('  - Full request body:', JSON.stringify(requestBody, null, 2));

        try {
          const response = await fetch(API_BASE_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              token: API_AUTH_TOKEN,
            },
            body: JSON.stringify(requestBody),
          });

          console.log('üì• API Response Status:', response.status, response.statusText);
          console.log('üì• API Response Headers:', Object.fromEntries(response.headers.entries()));

          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå API request failed:', errorText);
            throw new Error('API request failed: ' + response.status);
          }

          const responseData = await response.json();
          console.log('üì• API Response Data:', responseData);
          console.log('üì• Response keys:', Object.keys(responseData));
          
          return responseData;
        } catch (error) {
          console.error('üí• Error in processGooglePaySale:', error);
          throw error;
        }
      }

      // Process sale
      async function processSale() {
        const billingZip = document.getElementById('billingZip').value;
        const billingAddress = document.getElementById('billingAddress').value;

        const requestBody = {
          amount: 155.00, // Convert from cents
          subtotal: 145.00,
          tax: 10.00,
          tipAmount: 0,
          customerId: selectedCustomer?.id || selectedCustomer?.customer_id,
          wineryId: WINERY_ID,
          referenceId: 'WEB' + Date.now(),
          saveCard: selectedPaymentMethod === 'new' && selectedCustomer?.customer_id && document.getElementById('saveCardCheckbox')?.checked,
          billingAddress: billingAddress,
          billingZip: billingZip,
        };

        // Use paymentTokenId for new cards, cardToken for saved cards
        if (selectedPaymentMethod === 'new') {
          requestBody.paymentTokenId = paymentTokenId;
        } else {
          requestBody.cardToken = reusableToken;
          requestBody.cvv = document.getElementById('savedCvv').value;
        }

        console.log('üì§ Calling process-card-not-present-sale:', requestBody);

        const response = await fetch('/.netlify/functions/process-card-not-present-sale', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(requestBody),
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error('Payment processing failed: ' + errorText);
        }
        
        return await response.json();
      }

      // Save token
      async function savePaymentToken(saleResponse) {
        try {
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData.chdToken) {
            console.warn('No chdToken in response - cannot save card');
            return;
          }

          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const lastFour = ccnumber.slice(-4);
          const firstFour = ccnumber.slice(0, 4);
          const cardType = getCardType(ccnumber);
          const expiry = document.getElementById('ccexpiry').value.split('/');
          
          // Generate card fingerprint
          const fingerprintData = firstFour + lastFour + expiry[0] + '20' + expiry[1];
          const cardFingerprint = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(fingerprintData))
            .then(hash => Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join(''));

          const payload = {
            customer_id: selectedCustomer.id || selectedCustomer.customer_id,
            winery_id: WINERY_ID,
            processor_payment_method_id: transactionData.chdToken,
            card_last_4: lastFour,
            card_type: cardType,
            card_brand: cardType,
            card_expiry_month: expiry[0],
            card_expiry_year: '20' + expiry[1],
            card_fingerprint: cardFingerprint,
            card_bin: firstFour,
            source_channel: 'card_not_present'
          };
          
          console.log('üîç Sending payment token payload:', payload);

          const response = await fetch('/.netlify/functions/save-payment-token', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Save token error response:', errorText);
          }

          if (response.ok) {
            console.log('‚úÖ Card token saved:', transactionData.chdToken);
          } else if (response.status === 409) {
            console.log('‚ÑπÔ∏è Card token already exists (duplicate)');
          } else {
            console.warn('‚ö†Ô∏è Failed to save card token:', response.status);
          }
        } catch (error) {
          console.error('‚ùå Error saving token:', error);
        }
      }

      // Save transaction
      async function saveTransaction(saleResponse) {
        try {
          const transactionData = saleResponse.iposTransactResponse || saleResponse.iposhpresponse;
          
          if (!transactionData) {
            console.warn('No transaction data to save');
            return;
          }
          
          const ccnumber = document.getElementById('ccnumber').value.replace(/\s/g, '');
          const lastFour = ccnumber.slice(-4);
          const cardType = getCardType(ccnumber);

          const payload = {
            winery_id: WINERY_ID,
            customer_id: selectedCustomer.id || selectedCustomer.customer_id,
            reference_id: transactionData.transactionReferenceId || `WEB${Date.now()}`,
            transaction_id: transactionData.transactionId,
            amount: transactionData.totalAmount || transactionData.amount || 0,
            status: 'approved',
            response_code: transactionData.responseCode,
            response_message: transactionData.responseMessage || transactionData.errResponseMessage,
            card_type: cardType,
            card_last_4: lastFour,
            approval_code: transactionData.responseApprovalCode,
            batch_number: transactionData.batchNumber,
            request_data: saleResponse,
            response_data: transactionData
          };
          
          console.log('üîç Sending transaction payload:', payload);

          const response = await fetch('/.netlify/functions/save-transaction', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          
          if (!response.ok) {
            const errorText = await response.text();
            console.error('‚ùå Save transaction error response:', errorText);
          }
          
          console.log('‚úÖ Transaction saved to database');
        } catch (error) {
          console.error('Failed to save transaction:', error);
        }
      }

      // Helper functions
      function getCardType(cardNumber) {
        if (/^4/.test(cardNumber)) return 'Visa';
        if (/^5[1-5]/.test(cardNumber)) return 'Mastercard';
        if (/^3[47]/.test(cardNumber)) return 'American Express';
        if (/^6(?:011|5)/.test(cardNumber)) return 'Discover';
        return 'Card';
      }

      function showAlert(containerId, type, message) {
        const container = document.getElementById(containerId);
        const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
        container.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
      }

      function showDeclineModal(declineInfo) {
        // Remove any existing decline modal
        const existingModal = document.getElementById('declineModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Create decline modal
        const modal = document.createElement('div');
        modal.id = 'declineModal';
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 10000;
          font-family: Georgia, serif;
        `;

        const content = document.createElement('div');
        content.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 40px;
          max-width: 500px;
          width: 90%;
          box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
          text-align: center;
        `;

        content.innerHTML = `
          <div style="color: #e74c3c; font-size: 64px; margin-bottom: 20px;">
            ‚úï
          </div>
          <h2 style="color: #333; margin: 0 0 30px 0; font-size: 28px;">
            PAYMENT DECLINED
          </h2>
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; text-align: left;">
            <div style="margin-bottom: 15px;">
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Decline Code</div>
              <div style="color: #333; font-weight: bold; font-size: 18px;">${declineInfo.code || 'N/A'}</div>
            </div>
            <div style="margin-bottom: 15px;">
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Authorization Response Message</div>
              <div style="color: #333; font-weight: bold; font-size: 18px;">${declineInfo.message || 'Unknown error'}</div>
            </div>
            <div>
              <div style="color: #666; font-size: 14px; margin-bottom: 5px;">Response Definition</div>
              <div style="color: #333; font-size: 16px; line-height: 1.5;">${declineInfo.definition || 'No details available'}</div>
            </div>
          </div>
          <button id="closeDeclineModal" style="
            background: #5dade2;
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 18px;
            border-radius: 8px;
            cursor: pointer;
            font-family: Georgia, serif;
            font-weight: bold;
          ">
            Close
          </button>
        `;

        modal.appendChild(content);
        document.body.appendChild(modal);

        // Handle close button
        document.getElementById('closeDeclineModal').addEventListener('click', () => {
          modal.remove();
        });
      }


      function setStep(step) {
        for (let i = 1; i <= 3; i++) {
          const indicator = document.getElementById(`step${i}-indicator`);
          indicator.classList.toggle('active', i <= step);
        }

        document.querySelectorAll('.step-content').forEach(el => el.classList.remove('active'));
        document.getElementById(`step${step}`).classList.add('active');
        currentStep = step;
        window.scrollTo(0, 0);
      }

      function editStep(step) {
        setStep(step);
      }

      function showSuccessPage(response) {
        const data = response.iposTransactResponse || response.iposhpresponse;
        const paymentMethod = selectedPaymentMethod === 'googlepay' ? 'Google Pay' : 'Card';
        showAlert('reviewAlerts', 'success', `
          <h3 style="margin-bottom: 15px">‚úÖ Payment Successful!</h3>
          <p><strong>Payment Method:</strong> ${paymentMethod}</p>
          <p><strong>Transaction ID:</strong> ${data.transactionId}</p>
          <p><strong>Amount:</strong> $${(data.totalAmount / 100).toFixed(2)}</p>
          <p><strong>Approval Code:</strong> ${data.responseApprovalCode}</p>
          ${data.chdToken && selectedPaymentMethod !== 'googlepay' ? '<p style="margin-top: 10px; color: #856404;">üí≥ Card saved for future use</p>' : ''}
        `);
        document.querySelector('#step3 .btn').style.display = 'none';
      }

      // Input formatting
      document.getElementById('ccnumber').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        e.target.value = value.match(/.{1,4}/g)?.join(' ') || value;
      });

      document.getElementById('ccexpiry').addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) value = value.substring(0, 2) + '/' + value.substring(2, 4);
        e.target.value = value;
      });

      document.getElementById('cccvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      document.getElementById('savedCvv').addEventListener('input', function(e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Initialize
      window.addEventListener('DOMContentLoaded', loadConfig);
    </script>
  </body>
</html>