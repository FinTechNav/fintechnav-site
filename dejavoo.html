<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="referrer" content="strict-origin-when-cross-origin" />
    <title>Dejavoo Freedom to Design - Card Payment Test</title>

    <style>
      :root {
        --color-background: #1a1a1a;
        --color-background-secondary: #2a2a2a;
        --color-text: #e0e0e0;
        --color-primary: #c9a15f;
        --color-primary-hover: #b08f4f;
        --color-border: rgba(201, 161, 95, 0.3);
        --color-success: #4caf50;
        --color-error: #f44336;
        --color-warning: #ff9800;
        --border-radius: 8px;
        --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: var(--font-family);
        background-color: var(--color-background);
        color: var(--color-text);
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 600px;
        margin: 0 auto;
        background-color: var(--color-background-secondary);
        border-radius: var(--border-radius);
        padding: 30px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      h1 {
        color: var(--color-primary);
        margin-bottom: 10px;
        font-size: 2rem;
        text-align: center;
      }

      .subtitle {
        text-align: center;
        color: #888;
        margin-bottom: 30px;
        font-size: 0.9rem;
      }

      .section {
        margin-bottom: 30px;
        padding: 20px;
        background-color: var(--color-background);
        border-radius: var(--border-radius);
        border: 1px solid var(--color-border);
      }

      .section h2 {
        color: var(--color-primary);
        margin-bottom: 15px;
        font-size: 1.3rem;
        border-bottom: 2px solid var(--color-border);
        padding-bottom: 10px;
      }

      .alert {
        padding: 15px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        font-weight: 500;
      }

      .alert-info {
        background-color: rgba(33, 150, 243, 0.2);
        border: 1px solid #2196f3;
        color: #2196f3;
      }

      .alert-warning {
        background-color: rgba(255, 152, 0, 0.2);
        border: 1px solid var(--color-warning);
        color: var(--color-warning);
      }

      .alert-success {
        background-color: rgba(76, 175, 80, 0.2);
        border: 1px solid var(--color-success);
        color: var(--color-success);
      }

      .alert-error {
        background-color: rgba(244, 67, 54, 0.2);
        border: 1px solid var(--color-error);
        color: var(--color-error);
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--color-primary);
      }

      input[type='text'],
      input[type='number'] {
        width: 100%;
        padding: 12px;
        background-color: var(--color-background-secondary);
        border: 1px solid var(--color-border);
        border-radius: var(--border-radius);
        color: var(--color-text);
        font-size: 1rem;
        transition: border-color 0.3s ease;
      }

      input[type='text']:focus,
      input[type='number']:focus {
        outline: none;
        border-color: var(--color-primary);
        box-shadow: 0 0 0 3px rgba(201, 161, 95, 0.1);
      }

      .help-text {
        font-size: 0.85rem;
        color: #888;
        margin-top: 5px;
      }

      button[type='submit'],
      .btn {
        background-color: var(--color-primary);
        color: #1a1a1a;
        padding: 14px 30px;
        border: none;
        border-radius: var(--border-radius);
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        width: 100%;
        margin-top: 10px;
      }

      button[type='submit']:hover,
      .btn:hover {
        background-color: var(--color-primary-hover);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(201, 161, 95, 0.3);
      }

      button[type='submit']:disabled,
      .btn:disabled {
        background-color: #555;
        cursor: not-allowed;
        opacity: 0.5;
        transform: none;
      }

      .response-data {
        background-color: var(--color-background);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-top: 15px;
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        overflow-x: auto;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 400px;
        overflow-y: auto;
      }

      .config-section {
        background-color: var(--color-background);
        padding: 20px;
        border-radius: var(--border-radius);
        margin-bottom: 20px;
        border: 1px solid var(--color-border);
      }

      .btn-secondary {
        background-color: #555;
        margin-top: 5px;
      }

      .btn-secondary:hover {
        background-color: #666;
      }

      #results {
        display: none;
      }

      .token-display {
        background-color: rgba(76, 175, 80, 0.1);
        border: 2px solid var(--color-success);
        padding: 15px;
        border-radius: var(--border-radius);
        margin-top: 15px;
        word-break: break-all;
      }

      .token-display strong {
        color: var(--color-success);
      }

      @media (max-width: 768px) {
        .container {
          padding: 20px;
        }

        h1 {
          font-size: 1.5rem;
        }
      }
    </style>

    <!-- CRITICAL: The script tag needs the security_key attribute with your auth token -->
    <script
      id="ftd"
      src="https://payment.ipospays.tech/ftd/v1/freedomtodesign.js"
      security_key=""
      defer
    ></script>
  </head>

  <body>
    <div class="container">
      <h1>Dejavoo Card Payment</h1>
      <p class="subtitle">Freedom to Design Integration</p>

      <!-- Configuration Alert -->
      <div class="alert alert-warning" id="configAlert">
        <strong>‚ö†Ô∏è Configuration Required:</strong> Enter your auth token below and click
        "Update Script" to enable the payment form.
      </div>

      <!-- Auth Token Configuration -->
      <div class="config-section">
        <h2 style="color: var(--color-primary); margin-bottom: 15px; font-size: 1.2rem">
          üîë Configuration
        </h2>
        <div class="form-group">
          <label for="authTokenConfig">eComm Auth Token:</label>
          <input
            type="text"
            id="authTokenConfig"
            placeholder="Enter your Dejavoo auth token"
          />
          <div class="help-text">
            This will be added to the script tag's security_key attribute
          </div>
        </div>
        <button class="btn" onclick="updateSecurityKey()">Update Script & Reload Page</button>
      </div>

      <!-- Payment Form Section -->
      <div class="section">
        <h2>üí≥ Card Payment Form</h2>

        <div class="alert alert-info">
          <strong>Test Cards:</strong> Use test card numbers provided by Dejavoo for sandbox
          testing
        </div>

        <form id="paymentForm">
          <div class="form-group">
            <label for="ccnumber">Card Number:</label>
            <input
              type="text"
              id="ccnumber"
              placeholder="4111 1111 1111 1111"
              maxlength="19"
              required
            />
            <div class="help-text">16-digit card number</div>
          </div>

          <div class="form-group">
            <label for="ccexpiry">Expiry Date:</label>
            <input type="text" id="ccexpiry" placeholder="MM/YY" maxlength="5" required />
            <div class="help-text">Format: MM/YY (e.g., 12/25)</div>
          </div>

          <div class="form-group">
            <label for="cccvv">CVV:</label>
            <input type="text" id="cccvv" placeholder="123" maxlength="4" required />
            <div class="help-text">3 or 4 digit security code</div>
          </div>

          <button type="submit" id="payButton">Generate Payment Token</button>
        </form>
      </div>

      <!-- Results Section -->
      <div class="section" id="results">
        <h2>üìä Results</h2>
        <div id="resultMessage"></div>
        <div id="responseData" class="response-data"></div>
      </div>

      <!-- Instructions -->
      <div class="section">
        <h2>üìö How It Works</h2>
        <ol style="margin-left: 20px; line-height: 1.8">
          <li>Enter your auth token above and click "Update Script & Reload Page"</li>
          <li>Fill in the card details (use test cards for sandbox)</li>
          <li>Click "Generate Payment Token"</li>
          <li>The library will call <code>postData()</code> and return a payment token</li>
          <li>
            Use the payment token with iPOS Transact API to complete the transaction
            <div class="help-text">Token expires in 24 hours if unused</div>
          </li>
        </ol>
      </div>

      <!-- Documentation Links -->
      <div class="section">
        <h2>üîó Resources</h2>
        <ul style="margin-left: 20px; line-height: 1.8">
          <li>
            <a
              href="https://docs.ipospays.com/freedom-to-design"
              target="_blank"
              style="color: #64b5f6"
              >Freedom to Design Docs</a
            >
          </li>
          <li>
            <a
              href="https://docs.ipospays.com/freedom-to-design/apidocs"
              target="_blank"
              style="color: #64b5f6"
              >API Documentation</a
            >
          </li>
          <li>
            <a
              href="https://simulator.ipostransact.com/"
              target="_blank"
              style="color: #64b5f6"
              >API Simulator</a
            >
          </li>
          <li>Support: <a href="mailto:devsupport@dejavoo.io">devsupport@dejavoo.io</a></li>
        </ul>
      </div>
    </div>

    <script>
      // Update the script tag's security_key attribute
      function updateSecurityKey() {
        const authToken = document.getElementById('authTokenConfig').value.trim();

        if (!authToken) {
          alert('Please enter your auth token');
          return;
        }

        // Save to localStorage
        localStorage.setItem('dejavoo_auth_token', authToken);

        // Update the script tag
        const scriptTag = document.getElementById('ftd');
        scriptTag.setAttribute('security_key', authToken);

        alert(
          'Auth token saved! Reloading page to initialize the library with your credentials...'
        );

        // Reload the page to reinitialize the script with the new security_key
        window.location.reload();
      }

      // Load saved auth token on page load
      window.addEventListener('DOMContentLoaded', function () {
        const savedToken = localStorage.getItem('dejavoo_auth_token');

        if (savedToken) {
          // Update the input field
          document.getElementById('authTokenConfig').value = savedToken;

          // Update the script tag
          const scriptTag = document.getElementById('ftd');
          scriptTag.setAttribute('security_key', savedToken);

          // Hide the warning
          document.getElementById('configAlert').style.display = 'none';

          console.log('‚úÖ Auth token loaded from localStorage');
        } else {
          console.log('‚ö†Ô∏è No auth token found - please configure');
        }
      });

      // Handle form submission
      async function submitCardFunc(event) {
        event.preventDefault();

        // Check if postData function exists
        if (typeof postData !== 'function') {
          const resultMessage = document.getElementById('resultMessage');
          resultMessage.className = 'alert alert-error';
          resultMessage.innerHTML = `
            <strong>‚ùå Error:</strong> postData() function not found.<br><br>
            This means the Freedom to Design library did not load properly. Possible causes:<br>
            <ul style="margin-left: 20px; margin-top: 10px;">
              <li>Invalid or missing auth token</li>
              <li>Auth token doesn't have Freedom to Design access</li>
              <li>Network connectivity issue</li>
            </ul>
            <br>Check the browser console for more details.
          `;
          document.getElementById('results').style.display = 'block';
          console.error('postData() function not available');
          return;
        }

        // Show loading state
        const payButton = document.getElementById('payButton');
        const originalText = payButton.textContent;
        payButton.disabled = true;
        payButton.textContent = 'Processing...';

        try {
          console.log('üîÑ Calling postData() to generate payment token...');
          const data_response = await postData();

          console.log('‚úÖ Payment token generated:', data_response);

          // Show success
          const resultMessage = document.getElementById('resultMessage');
          resultMessage.className = 'alert alert-success';
          resultMessage.innerHTML = `
            <strong>‚úÖ Payment Token Generated Successfully!</strong>
          `;

          // Show the token
          const responseData = document.getElementById('responseData');
          responseData.innerHTML = `
            <div class="token-display">
              <strong>Payment Token ID:</strong><br>
              <code>${data_response.payment_token_id}</code>
            </div>
            <div style="margin-top: 15px;">
              <strong>Full Response:</strong>
              <pre>${JSON.stringify(data_response, null, 2)}</pre>
            </div>
            <div style="margin-top: 15px; padding: 15px; background-color: rgba(33, 150, 243, 0.1); border-radius: 8px;">
              <strong>üí° Next Step:</strong><br>
              Use this payment token with the iPOS Transact API to complete the transaction.<br>
              <em>Note: Token expires in 24 hours if unused.</em>
            </div>
          `;

          document.getElementById('results').style.display = 'block';
          document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        } catch (error) {
          console.error('‚ùå Error processing payment:', error);

          const resultMessage = document.getElementById('resultMessage');
          resultMessage.className = 'alert alert-error';
          resultMessage.innerHTML = `
            <strong>‚ùå Error:</strong> ${error.message || 'Unknown error occurred'}
          `;

          const responseData = document.getElementById('responseData');
          responseData.textContent = JSON.stringify(error, null, 2);

          document.getElementById('results').style.display = 'block';
          document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
        } finally {
          payButton.disabled = false;
          payButton.textContent = originalText;
        }
      }

      // Attach event listener to form
      var payButton = document.getElementById('payButton');
      document.getElementById('paymentForm').addEventListener('submit', submitCardFunc);

      // Format card number input with spaces
      document.getElementById('ccnumber').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
      });

      // Format expiry date input
      document.getElementById('ccexpiry').addEventListener('input', function (e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
          value = value.substring(0, 2) + '/' + value.substring(2, 4);
        }
        e.target.value = value;
      });

      // Only allow numbers in CVV
      document.getElementById('cccvv').addEventListener('input', function (e) {
        e.target.value = e.target.value.replace(/\D/g, '');
      });

      // Log when script loads
      console.log('‚úÖ Page loaded');
      console.log(
        'üìå Checking for postData function...',
        typeof postData !== 'undefined' ? '‚úÖ Found' : '‚ùå Not found'
      );
    </script>
  </body>
</html>